<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento Di√°rio ‚Äî UTEP Nordeste</title>
  <style>
    :root{
      --bg:#0b1f10;
      --panel:#0f2a16;
      --card:#13331b;
      --border:#235a33;
      --muted:#b9d8c0;
      --text:#e8fff0;
      --accent:#66c26f;      /* verde cana */
      --accent2:#2fbf5b;
      --warn:#f2c94c;
      --bad:#eb5757;
      --ok:#27ae60;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -20%, rgba(102,194,111,.22), transparent 60%),
                  linear-gradient(180deg, #07140c, var(--bg));
      color:var(--text);
      padding:18px;
    }
    h1{
      margin:6px 0 2px;
      text-align:center;
      letter-spacing:.3px;
      font-weight:900;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      margin:0 0 14px;
      font-size:13px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin:10px auto 14px;
      max-width:1200px;
    }
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      cursor:pointer;
      border:none;
      background:linear-gradient(180deg, rgba(102,194,111,.95), rgba(47,191,91,.9));
      color:#06210f;
      font-weight:900;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:var(--shadow);
      font-size:13px;
      transition: transform .05s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid var(--border);
      box-shadow:none;
      font-weight:800;
    }
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px}
    .btn.whats{
      background: linear-gradient(180deg, #25D366, #1fbe58);
      color:#07210f;
      font-weight:950;
    }

    .layout{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      max-width:1200px;
      margin:0 auto;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel h2{
      margin:0 0 8px;
      font-size:14px;
      letter-spacing:.2px;
      color:var(--text);
      font-weight:900;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
      font-weight:700;
    }
    select, input, textarea{
      width:100%;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    .muted{color:var(--muted); font-size:12px}

    .bases{
      display:grid;
      gap:12px;
    }
    .baseBlock{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .baseHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .baseTitle{
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .count{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-weight:800;
    }

    .cards{
      display:grid;
      gap:10px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
      border:1px solid rgba(255,255,255,.08);
      border-left: 4px solid rgba(102,194,111,.9);
      border-radius: 14px;
      padding:12px;
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .title{
      font-weight:950;
      margin:0 0 6px;
      font-size:14px;
      line-height:1.2;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
    .tag{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:999px;
      color:var(--text);
      font-weight:850;
      font-size:11px;
    }
    .tag.ok{background:rgba(39,174,96,.16); border-color:rgba(39,174,96,.5)}
    .tag.warn{background:rgba(242,201,76,.16); border-color:rgba(242,201,76,.5)}
    .tag.bad{background:rgba(235,87,87,.16); border-color:rgba(235,87,87,.5)}
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .error{
      max-width:1200px;
      margin:0 auto 12px;
      color:#ffd6d6;
      background: rgba(235,87,87,.10);
      border:1px solid rgba(235,87,87,.35);
      padding:10px 12px;
      border-radius:12px;
      display:none;
      font-weight:800;
    }

    /* calend√°rio */
    .calWrap{ display:grid; gap:10px; margin-top:8px; }
    .calHeader{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
    }
    .calHeader .month{ font-weight:950; letter-spacing:.2px; }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      background:rgba(0,0,0,.10);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .dow{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      padding:4px 0;
      font-weight:900;
    }
    .day{
      text-align:center;
      padding:10px 0;
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      font-weight:950;
      font-size:12px;
      user-select:none;
    }
    .day:hover{border-color: rgba(102,194,111,.6)}
    .day.mutedDay{opacity:.35}
    .day.today{outline:2px solid rgba(102,194,111,.75)}
    .day.selected{
      background:rgba(102,194,111,.22);
      border-color: rgba(102,194,111,.75);
    }

    /* Colunas extras (chooser) */
    .colsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin-top:8px;
    }
    .colItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .colItem input{ width:auto; transform: scale(1.15); }

    /* Modal notas */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(760px, 96vw);
      background: linear-gradient(180deg, rgba(19,51,27,.98), rgba(10,28,16,.98));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-weight:950;
      font-size:15px;
      margin:0;
    }
    .modalSub{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
      line-height:1.35;
      font-weight:750;
    }
    .noteList{
      margin-top:10px;
      display:grid;
      gap:8px;
      max-height:260px;
      overflow:auto;
      padding-right:6px;
    }
    .noteItem{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
    }
    .noteTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .noteTxt{
      white-space:pre-wrap;
      font-size:13px;
      color:var(--text);
      line-height:1.35;
      font-weight:700;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .split{grid-template-columns:1fr;}
    }

    .footer{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:16px;
      opacity:.9;
      font-weight:750;
    }
  </style>
</head>

<body>
  <h1>Acompanhamento Di√°rio</h1>
  <p class="sub">UTEP Nordeste ‚Ä¢ Prazo final = <b>PREVISAO_EXECUCAO_FIM</b></p>

  <div id="err" class="error"></div>

  <div class="topbar">
    <div class="pill">
      <b>Data selecionada:</b> <span id="selDateLbl">‚Äî</span>
    </div>
    <button class="btn secondary" id="toggleFilters">Mostrar filtros</button>
    <button class="btn secondary" id="clearFilters">Limpar filtros</button>
    <button class="btn" id="reload">Recarregar</button>
    <button class="btn whats" id="exportWhats">Exportar WhatsApp (somente do dia)</button>
  </div>

  <div class="layout">
    <!-- Painel -->
    <div class="panel">
      <h2>Calend√°rio</h2>

      <div class="calWrap">
        <div class="calHeader">
          <button class="btn secondary small" id="prevMonth">‚óÄ</button>
          <div class="month" id="monthLbl">‚Äî</div>
          <button class="btn secondary small" id="nextMonth">‚ñ∂</button>
        </div>
        <div class="calGrid" id="calGrid"></div>
        <div class="muted">
          Toque no dia para filtrar por <b>FIM</b>. Se n√£o houver obras no dia, mostramos as pr√≥ximas dentro de <b>5 dias</b>.
        </div>
      </div>

      <div id="filtersPanel" style="display:none; margin-top:14px;">
        <h2>Filtros</h2>
        <div class="row">
          <div>
            <label>Crit√©rio</label>
            <select id="fCriterio"></select>
          </div>
          <div>
            <label>Agente Respons√°vel</label>
            <select id="fAgente"></select>
          </div>
          <div>
            <label>Ger√™ncia</label>
            <select id="fGerencia"></select>
          </div>
          <div>
            <label>Status</label>
            <select id="fStatus"></select>
          </div>
          <div>
            <label>Busca (nota / t√≠tulo / munic√≠pio / projeto)</label>
            <input id="fBusca" placeholder="Digite para filtrar..." />
          </div>

          <h2 style="margin-top:6px;">Exibir colunas extras</h2>
          <div class="muted">Marque as colunas que quer ver. Isso fica salvo no aparelho do usu√°rio.</div>
          <div id="colsBox" class="colsGrid"></div>

          <div class="muted">
            Fixas: <b>NOTA</b>, <b>PROJETO</b>, <b>T√çTULO</b>, <b>MUNIC√çPIO</b>, <b>FIM</b>, <b>CRIT√âRIO</b>.
          </div>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="bases" id="bases"></div>
  </div>

  <div class="footer">Acompanhamento ‚Äî UTEP Nordeste</div>

  <!-- Modal Notas -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle" id="modalTitle">Notas</div>
          <div class="modalSub" id="modalSub">‚Äî</div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="closeModal">Fechar</button>
        </div>
      </div>

      <div class="split">
        <div>
          <label>Seu nome</label>
          <input id="noteAuthor" placeholder="Ex.: Jo√£o Silva" />
        </div>
        <div>
          <label>Status da execu√ß√£o</label>
          <select id="noteStatus">
            <option value="executada">‚úÖ Executada</option>
            <option value="problema">‚ö†Ô∏è Com problema</option>
            <option value="nao_executada">‚õî N√£o executada</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Adicionar nota</label>
        <textarea id="noteText" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn" id="saveNote">Salvar nota</button>
      </div>

      <div class="muted" id="notesHint" style="margin-top:10px;"></div>
      <div class="noteList" id="noteList"></div>
    </div>
  </div>

  <script type="module">
    // ========= CONFIGURE AQUI =========
    const SUPABASE_URL = https://yyfhnuafwzeglwcpnmkd.supabase.co;
    const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5ZmhudWFmd3plZ2x3Y3BubWtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjM4NzgsImV4cCI6MjA4NjM5OTg3OH0.OzMXz2_O6rnnmgDchXMBH_ZPG8YzrRU8SFQQ_98Xi5A;
    const TABLE_OBRAS = "obras";
    const TABLE_NOTES = "notes";
    // ==================================

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --------- elementos ---------
    const errBox = document.getElementById("err");
    const basesEl = document.getElementById("bases");
    const selDateLbl = document.getElementById("selDateLbl");

    const filtersPanel = document.getElementById("filtersPanel");
    const toggleFiltersBtn = document.getElementById("toggleFilters");
    const clearFiltersBtn = document.getElementById("clearFilters");
    const reloadBtn = document.getElementById("reload");
    const exportWhatsBtn = document.getElementById("exportWhats");

    const fCriterio = document.getElementById("fCriterio");
    const fAgente = document.getElementById("fAgente");
    const fGerencia = document.getElementById("fGerencia");
    const fStatus = document.getElementById("fStatus");
    const fBusca = document.getElementById("fBusca");

    const colsBox = document.getElementById("colsBox");

    // calend√°rio
    const calGrid = document.getElementById("calGrid");
    const monthLbl = document.getElementById("monthLbl");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");

    // modal
    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const noteAuthor = document.getElementById("noteAuthor");
    const noteStatus = document.getElementById("noteStatus");
    const noteText = document.getElementById("noteText");
    const saveNoteBtn = document.getElementById("saveNote");
    const noteList = document.getElementById("noteList");
    const notesHint = document.getElementById("notesHint");

    // --------- helpers ---------
    function showError(msg){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    function clearError(){
      errBox.style.display = "none";
      errBox.textContent = "";
    }
    const pad2 = (n)=> String(n).padStart(2,"0");
    function fmtBR(d){
      if(!(d instanceof Date)) return "-";
      return `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
    }
    function fmtBRDateTime(iso){
      if(!iso) return "";
      const d = new Date(iso);
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function startOfDayUTC(d){
      return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    }
    function parseBRDateToUTC(v){
      if(!v) return null;
      if (typeof v === "string"){
        const s = v.trim();
        if (/^\d{4}-\d{2}-\d{2}/.test(s)){
          const [y,m,d] = s.split("T")[0].split("-").map(Number);
          return new Date(Date.UTC(y,m-1,d));
        }
        const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(m){
          const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
          return new Date(Date.UTC(yy,mm-1,dd));
        }
      }
      if (v instanceof Date){
        return new Date(Date.UTC(v.getFullYear(), v.getMonth(), v.getDate()));
      }
      return null;
    }

    function pick(o, keys){
      for (const k of keys){
        if (o && o[k] !== undefined && o[k] !== null && String(o[k]).trim() !== "") return o[k];
      }
      return null;
    }
    function pickLoose(o, contains){
      const low = contains.toLowerCase();
      for (const k of Object.keys(o||{})){
        if (k.toLowerCase().includes(low)){
          const v = o[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") return v;
        }
      }
      return null;
    }
    function uniqSorted(arr){
      const s = [...new Set(arr.filter(x=>x && String(x).trim() !== "-" && String(x).trim() !== ""))];
      s.sort((a,b)=> String(a).localeCompare(String(b)));
      return s;
    }

    // --------- Colunas extras (liga/desliga) ---------
    const EXTRA_COLS = [
      { key:"base_oper_prog", label:"BASE_OPER_PROG" },
      { key:"status_si", label:"STATUS_SI" },
      { key:"st_carteira", label:"ST_CARTEIRA" },
      { key:"prioridade_principal", label:"PRIORIDADE_PRINCIPAL" },
      { key:"prioridade_todas", label:"PRIORIDADE_TODAS" },
      { key:"vl_projeto", label:"VL_PROJETO" },
      { key:"vl_prev_unit", label:"VL_PREV_UNIT" },
      { key:"data_revisao_orcamento", label:"DATA_REVISAO_ORCAMENTO" },
      { key:"status_revisao_orcamento", label:"STATUS_REVISAO_ORCAMENTO" },
      { key:"estratificacao", label:"ESTRATIFICACAO" },
      { key:"estratificacao_matriz", label:"ESTRATIFICACAO_MATRIZ" },
      { key:"status_prazo_cart", label:"STATUS_PRAZO_CART" },
      { key:"obras_ouro", label:"OBRAS_OURO" }
    ];

    let selectedExtras = new Set(JSON.parse(localStorage.getItem("extras_cols") || "[]"));

    function renderColsChooser(){
      colsBox.innerHTML = "";
      EXTRA_COLS.forEach(c=>{
        const wrap = document.createElement("div");
        wrap.className = "colItem";
        wrap.innerHTML = `
          <input type="checkbox" ${selectedExtras.has(c.key) ? "checked": ""} />
          <div style="font-weight:900;">${escapeHtml(c.label)}</div>
        `;
        const chk = wrap.querySelector("input");
        chk.addEventListener("change", ()=>{
          if(chk.checked) selectedExtras.add(c.key);
          else selectedExtras.delete(c.key);
          localStorage.setItem("extras_cols", JSON.stringify([...selectedExtras]));
          renderBases();
        });
        colsBox.appendChild(wrap);
      });
    }

    // --------- State ---------
    const state = {
      obrasAll: [],
      obrasFiltered: [],
      selectedUTC: null,
      monthCursor: null,
      filters: { criterio:"ALL", agente:"ALL", gerencia:"ALL", status:"ALL", busca:"" }
    };

    // --------- Base (Alagoinhas / Ribeira / Paulo Afonso) ---------
    function normBaseName(v){
      const t = String(v||"").toUpperCase().trim();
      if (!t) return "";
      if (t.includes("ALAGOIN")) return "Alagoinhas";
      if (t.includes("RIBEIRA") || t.includes("POMBAL")) return "Ribeira do Pombal";
      if (t.includes("PAULO") && t.includes("AFONSO")) return "Paulo Afonso";
      return "";
    }
    function inferBaseFromText(txt){
      return normBaseName(txt);
    }

    // --------- Normaliza√ß√£o da obra ---------
    function normalizeObra(o){
      const nota = String(pick(o, ["nota","NOTA","Nota"]) ?? "").trim() || null;
      const titulo = String(pick(o, ["titulo","TITULO","Titulo"]) ?? "").trim() || "-";
      const projeto = String(pick(o, ["projeto","PROJETO","Projeto"]) ?? pickLoose(o,"projeto") ?? "").trim() || "-";
      const municipio = String(pick(o, ["municipio","MUNICIPIO","Municipio"]) ?? "").trim() || "-";
      const criterio = String(pick(o, ["criterio","CRITERIO","Criterio"]) ?? "").trim() || "-";
      const agente = String(pick(o, ["agente_responsavel","AGENTE_RESPONSAVEL"]) ?? pickLoose(o,"agente") ?? "").trim() || "-";
      const gerencia = String(pick(o, ["gerencia","GERENCIA"]) ?? "").trim() || "-";
      const status = String(pick(o, ["status","STATUS"]) ?? "").trim() || "-";

      const fimRaw = pick(o, ["previsao_execucao_fim","PREVISAO_EXECUCAO_FIM"]);
      const fim = parseBRDateToUTC(fimRaw);

      // Base oficial (se existir): BASE_OPER_PROG
      const base_oper_prog = String(pick(o, ["base_oper_prog","BASE_OPER_PROG"]) ?? "").trim() || "-";
      let base = normBaseName(base_oper_prog);
      if(!base){
        // tenta localidade/municipio
        const localidade = String(pick(o, ["localidade","LOCALIDADE"]) ?? "").trim();
        base = inferBaseFromText(localidade || municipio) || "Outros";
      }

      // Extras (s√≥ guardamos no objeto para exibir quando selecionado)
      const status_si = String(pick(o, ["status_si","STATUS_SI"]) ?? "").trim() || "-";
      const st_carteira = String(pick(o, ["st_carteira","ST_CARTEIRA"]) ?? "").trim() || "-";
      const prioridade_principal = String(pick(o, ["prioridade_principal","PRIORIDADE_PRINCIPAL"]) ?? "").trim() || "-";
      const prioridade_todas = String(pick(o, ["prioridade_todas","PRIORIDADE_TODAS"]) ?? "").trim() || "-";
      const vl_projeto = String(pick(o, ["vl_projeto","VL_PROJETO"]) ?? "").trim() || "-";
      const vl_prev_unit = String(pick(o, ["vl_prev_unit","VL_PREV_UNIT"]) ?? "").trim() || "-";
      const data_revisao_orcamento = String(pick(o, ["data_revisao_orcamento","DATA_REVISAO_ORCAMENTO"]) ?? "").trim() || "-";
      const status_revisao_orcamento = String(pick(o, ["status_revisao_orcamento","STATUS_REVISAO_ORCAMENTO"]) ?? "").trim() || "-";
      const estratificacao = String(pick(o, ["estratificacao","ESTRATIFICACAO"]) ?? "").trim() || "-";
      const estratificacao_matriz = String(pick(o, ["estratificacao_matriz","ESTRATIFICACAO_MATRIZ"]) ?? "").trim() || "-";
      const status_prazo_cart = String(pick(o, ["status_prazo_cart","STATUS_PRAZO_CART"]) ?? "").trim() || "-";
      const obras_ouro = String(pick(o, ["obras_ouro","OBRAS_OURO"]) ?? "").trim() || "-";

      return {
        raw:o,
        nota, titulo, projeto, municipio, criterio, agente, gerencia, status,
        fim, base,
        // extras (keys iguais ao EXTRA_COLS)
        base_oper_prog, status_si, st_carteira, prioridade_principal, prioridade_todas,
        vl_projeto, vl_prev_unit, data_revisao_orcamento, status_revisao_orcamento,
        estratificacao, estratificacao_matriz, status_prazo_cart, obras_ouro
      };
    }

    // --------- UI events ---------
    toggleFiltersBtn.addEventListener("click", ()=>{
      const open = filtersPanel.style.display !== "none";
      filtersPanel.style.display = open ? "none" : "block";
      toggleFiltersBtn.textContent = open ? "Mostrar filtros" : "Ocultar filtros";
    });

    clearFiltersBtn.addEventListener("click", ()=>{
      state.filters = { criterio:"ALL", agente:"ALL", gerencia:"ALL", status:"ALL", busca:"" };
      fCriterio.value = "ALL";
      fAgente.value = "ALL";
      fGerencia.value = "ALL";
      fStatus.value = "ALL";
      fBusca.value = "";
      applyAll();
    });

    reloadBtn.addEventListener("click", async ()=>{
      await loadObras();
      applyAll();
    });

    function onFilterChange(){
      state.filters.criterio = fCriterio.value;
      state.filters.agente = fAgente.value;
      state.filters.gerencia = fGerencia.value;
      state.filters.status = fStatus.value;
      state.filters.busca = (fBusca.value || "").trim().toLowerCase();
      applyAll();
    }
    [fCriterio,fAgente,fGerencia,fStatus].forEach(el=> el.addEventListener("change", onFilterChange));
    fBusca.addEventListener("input", onFilterChange);

    exportWhatsBtn.addEventListener("click", ()=>{
      const sel = state.selectedUTC;
      if(!sel){ alert("Selecione uma data no calend√°rio."); return; }

      const list = getListForSelectedDayOnly();
      if(!list.length){
        alert("N√£o h√° obras com prazo final para a data selecionada.");
        return;
      }
      const msg = buildWhatsAppMessage(sel, list);
      window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
    });

    // --------- Calendar ---------
    prevMonthBtn.addEventListener("click", ()=>{
      const d = new Date(state.monthCursor);
      d.setUTCMonth(d.getUTCMonth()-1);
      state.monthCursor = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
      renderCalendar();
    });
    nextMonthBtn.addEventListener("click", ()=>{
      const d = new Date(state.monthCursor);
      d.setUTCMonth(d.getUTCMonth()+1);
      state.monthCursor = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
      renderCalendar();
    });

    function renderCalendar(){
      const cursor = state.monthCursor;
      const monthNames = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      monthLbl.textContent = `${monthNames[cursor.getUTCMonth()]} ${cursor.getUTCFullYear()}`;

      calGrid.innerHTML = "";
      const dows = ["D","S","T","Q","Q","S","S"];
      dows.forEach(x=>{
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = x;
        calGrid.appendChild(el);
      });

      const first = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1));
      const last = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth()+1, 0));
      const firstDow = first.getUTCDay();
      const daysInMonth = last.getUTCDate();

      const prevLast = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), 0));
      const prevDays = prevLast.getUTCDate();

      const today = startOfDayUTC(new Date());

      for(let i=0;i<42;i++){
        const dayIndex = i - firstDow + 1;
        let dateUTC, label, muted=false;

        if(dayIndex <= 0){
          const dd = prevDays + dayIndex;
          dateUTC = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth()-1, dd));
          label = dd;
          muted=true;
        }else if(dayIndex > daysInMonth){
          const dd = dayIndex - daysInMonth;
          dateUTC = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth()+1, dd));
          label = dd;
          muted=true;
        }else{
          dateUTC = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), dayIndex));
          label = dayIndex;
        }

        const cell = document.createElement("div");
        cell.className = "day";
        if(muted) cell.classList.add("mutedDay");
        if(dateUTC.getTime() === today.getTime()) cell.classList.add("today");
        if(state.selectedUTC && dateUTC.getTime() === state.selectedUTC.getTime()) cell.classList.add("selected");
        cell.textContent = label;

        cell.addEventListener("click", ()=>{
          state.selectedUTC = dateUTC;
          if(muted){
            state.monthCursor = new Date(Date.UTC(dateUTC.getUTCFullYear(), dateUTC.getUTCMonth(), 1));
          }
          selDateLbl.textContent = fmtBR(state.selectedUTC);
          renderCalendar();
          applyAll();
        });

        calGrid.appendChild(cell);
      }
    }

    // --------- Load obras ---------
    async function loadObras(){
      clearError();

      if (!SUPABASE_URL.includes("http") || SUPABASE_ANON_KEY.includes("COLE_")) {
        showError("‚ö†Ô∏è Configure SUPABASE_URL e SUPABASE_ANON_KEY no topo do index.html.");
        return;
      }

      try{
        const { data, error } = await supabase
          .from(TABLE_OBRAS)
          .select("*")
          .limit(10000);

        if(error) throw error;

        state.obrasAll = (data || []).map(normalizeObra);

        // filtros
        const criterios = uniqSorted(state.obrasAll.map(o=>o.criterio));
        const agentes = uniqSorted(state.obrasAll.map(o=>o.agente));
        const gerencias = uniqSorted(state.obrasAll.map(o=>o.gerencia));
        const statuses = uniqSorted(state.obrasAll.map(o=>o.status));

        fillSelect(fCriterio, ["ALL", ...criterios], "ALL", "Todos");
        fillSelect(fAgente, ["ALL", ...agentes], "ALL", "Todos");
        fillSelect(fGerencia, ["ALL", ...gerencias], "ALL", "Todos");
        fillSelect(fStatus, ["ALL", ...statuses], "ALL", "Todos");

      }catch(e){
        showError("Erro ao carregar obras. Verifique internet e RLS/policies no Supabase. Detalhe: " + (e?.message || String(e)));
      }
    }

    function fillSelect(sel, values, selected, labelAll){
      sel.innerHTML = "";
      values.forEach(v=>{
        const op = document.createElement("option");
        op.value = v;
        op.textContent = v === "ALL" ? labelAll : v;
        sel.appendChild(op);
      });
      sel.value = selected;
    }

    // --------- Filter + render ---------
    function applyAll(){
      let arr = state.obrasAll.slice();
      const F = state.filters;

      if(F.criterio !== "ALL") arr = arr.filter(o=> o.criterio === F.criterio);
      if(F.agente !== "ALL") arr = arr.filter(o=> o.agente === F.agente);
      if(F.gerencia !== "ALL") arr = arr.filter(o=> o.gerencia === F.gerencia);
      if(F.status !== "ALL") arr = arr.filter(o=> o.status === F.status);

      if(F.busca){
        arr = arr.filter(o=>{
          const hay = `${o.nota||""} ${o.titulo||""} ${o.municipio||""} ${o.projeto||""} ${o.criterio||""}`.toLowerCase();
          return hay.includes(F.busca);
        });
      }

      state.obrasFiltered = arr;
      renderBases();
    }

    function inRange(d, a, b){
      return d && d.getTime() >= a.getTime() && d.getTime() <= b.getTime();
    }

    // regra: se tem obras no dia, mostra elas; sen√£o, pr√≥ximas at√© 5 dias
    function selectForDate(obras, selectedUTC){
      const target = selectedUTC;
      const next5 = new Date(target);
      next5.setUTCDate(next5.getUTCDate() + 5);

      const sameDay = obras.filter(o=> o.fim && o.fim.getTime() === target.getTime());
      if(sameDay.length) return { mode:"today", list: sameDay };

      const upcoming = obras
        .map(o=>({ o, fim: o.fim }))
        .filter(x=> inRange(x.fim, target, next5))
        .sort((a,b)=> a.fim - b.fim)
        .map(x=>x.o);

      return { mode:"upcoming", list: upcoming };
    }

    function statusTag(txt){
      const t = (txt||"").toLowerCase();
      if (t.includes("aprov") || t.includes("ok")) return "ok";
      if (t.includes("pend") || t.includes("aguard") || t.includes("anal")) return "warn";
      if (t.includes("cancel") || t.includes("reprov")) return "bad";
      return "";
    }

    function renderBases(){
      const sel = state.selectedUTC;
      if(!sel){
        basesEl.innerHTML = `<div class="panel"><b>Selecione um dia no calend√°rio.</b></div>`;
        return;
      }

      const bases = ["Alagoinhas", "Ribeira do Pombal", "Paulo Afonso"];
      const byBase = new Map(bases.map(b=>[b, []]));
      for(const o of state.obrasFiltered){
        if(byBase.has(o.base)) byBase.get(o.base).push(o);
      }

      basesEl.innerHTML = "";

      bases.forEach(baseName=>{
        const arr = byBase.get(baseName) || [];
        const pickRes = selectForDate(arr, sel);

        const block = document.createElement("div");
        block.className = "baseBlock";

        const countText = pickRes.mode === "today"
          ? `${pickRes.list.length} do dia`
          : `${pickRes.list.length} pr√≥ximas (at√© 5 dias)`;

        block.innerHTML = `
          <div class="baseHeader">
            <div class="baseTitle">${escapeHtml(baseName)}</div>
            <div class="count">${escapeHtml(countText)}</div>
          </div>
          <div class="cards"></div>
        `;

        const cards = block.querySelector(".cards");
        if(!pickRes.list.length){
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "Sem obras para o dia e sem pr√≥ximas dentro de 5 dias com os filtros atuais.";
          cards.appendChild(empty);
        }else{
          pickRes.list.forEach(o=> cards.appendChild(renderCard(o)));
        }

        basesEl.appendChild(block);
      });
    }

    function renderCard(o){
      const el = document.createElement("div");
      el.className = "card";

      const fimLbl = o.fim ? fmtBR(o.fim) : "-";
      const stClass = statusTag(o.status);

      const extrasHtml = EXTRA_COLS
        .filter(c => selectedExtras.has(c.key))
        .map(c => `<span class="tag">${escapeHtml(c.label)}: ${escapeHtml(o[c.key] ?? "-")}</span>`)
        .join("");

      el.innerHTML = `
        <div class="cardTop">
          <div>
            <div class="title">${escapeHtml(o.titulo || "-")}</div>
            <div class="meta">
              <span class="tag">NOTA: ${escapeHtml(o.nota || "-")}</span>
              <span class="tag">PROJETO: ${escapeHtml(o.projeto || "-")}</span>
              <span class="tag">MUNIC√çPIO: ${escapeHtml(o.municipio || "-")}</span>
              <span class="tag">FIM: ${escapeHtml(fimLbl)}</span>
              <span class="tag">CRIT√âRIO: ${escapeHtml(o.criterio || "-")}</span>
              <span class="tag ${stClass}">STATUS: ${escapeHtml(o.status || "-")}</span>
              ${extrasHtml}
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary small">Notas</button>
          </div>
        </div>
      `;

      el.querySelector("button").addEventListener("click", ()=> openNotes(o));
      return el;
    }

    // --------- WhatsApp (somente do dia) ---------
    function getListForSelectedDayOnly(){
      const sel = state.selectedUTC;
      return state.obrasFiltered
        .filter(o => o.fim && o.fim.getTime() === sel.getTime())
        .filter(o => ["Alagoinhas","Ribeira do Pombal","Paulo Afonso"].includes(o.base))
        .sort((a,b)=> a.base.localeCompare(b.base) || String(a.nota||"").localeCompare(String(b.nota||"")));
    }

    function buildWhatsAppMessage(selectedUTC, list){
      const dateLbl = fmtBR(selectedUTC);

      const byBase = new Map([
        ["Alagoinhas", []],
        ["Ribeira do Pombal", []],
        ["Paulo Afonso", []],
      ]);
      list.forEach(o=> byBase.get(o.base).push(o));

      let msg = `üìå UTEP Nordeste ‚Äî Obras com prazo FINAL hoje (${dateLbl})\n`;

      for(const [baseName, arr] of byBase.entries()){
        msg += `\nüè∑Ô∏è ${baseName}\n`;
        if(!arr.length){ msg += `‚Ä¢ (nenhuma)\n`; continue; }
        arr.forEach(o=>{
          msg += `‚Ä¢ Nota ${o.nota || "-"} | Projeto ${o.projeto || "-"} | ${o.municipio || "-"} | ${o.titulo || "-"}\n`;
        });
      }
      msg += `\n(gerado automaticamente pelo dashboard)`;
      return msg;
    }

    // --------- Notes (Supabase) ---------
    let currentNotaForNotes = null;
    let currentObraForNotes = null;

    closeModalBtn.addEventListener("click", ()=> closeModal());
    modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });

    function closeModal(){
      modalOverlay.style.display = "none";
      currentNotaForNotes = null;
      currentObraForNotes = null;
    }

    async function openNotes(obra){
      clearError();
      currentObraForNotes = obra;
      currentNotaForNotes = obra.nota;

      modalTitle.textContent = `Notas ‚Äî NOTA ${obra.nota || "-"}`;
      modalSub.textContent = `${obra.projeto || "-"} ‚Ä¢ ${obra.municipio || "-"} ‚Ä¢ ${obra.criterio || "-"}`;

      notesHint.textContent = "";
      noteText.value = "";
      noteStatus.value = "executada";
      noteList.innerHTML = `<div class="muted">Carregando...</div>`;
      modalOverlay.style.display = "flex";

      if(!obra.nota){
        notesHint.textContent = "‚ö†Ô∏è Esta obra n√£o tem NOTA preenchida, ent√£o n√£o d√° para vincular notas.";
        noteList.innerHTML = "";
        return;
      }
      await loadNotes(obra.nota);
    }

    saveNoteBtn.addEventListener("click", async ()=>{
      const author = (noteAuthor.value || "").trim();
      const txt = (noteText.value || "").trim();
      const st = noteStatus.value;

      if(!currentNotaForNotes){ alert("N√£o encontrei a NOTA desta obra."); return; }
      if(!author){ alert("Informe seu nome."); return; }
      if(!txt){ alert("Escreva a anota√ß√£o."); return; }

      try{
        saveNoteBtn.disabled = true;
        saveNoteBtn.textContent = "Salvando...";

        const payload = { nota: currentNotaForNotes, author, note: txt, status: st };
        const { error } = await supabase.from(TABLE_NOTES).insert(payload);
        if(error) throw error;

        noteText.value = "";
        await loadNotes(currentNotaForNotes);
      }catch(e){
        showError("Erro ao salvar nota: " + (e?.message || String(e)));
      }finally{
        saveNoteBtn.disabled = false;
        saveNoteBtn.textContent = "Salvar nota";
      }
    });

    async function loadNotes(nota){
      try{
        const { data, error } = await supabase
          .from(TABLE_NOTES)
          .select("*")
          .eq("nota", nota)
          .order("created_at", { ascending:false })
          .limit(200);

        if(error) throw error;

        if(!data || !data.length){
          noteList.innerHTML = `<div class="muted">Sem anota√ß√µes ainda.</div>`;
          return;
        }

        noteList.innerHTML = "";
        data.forEach(n=>{
          const st = (n.status || "").toLowerCase();
          const tagClass =
            st === "executada" ? "ok" :
            st === "problema" ? "warn" :
            st === "nao_executada" ? "bad" : "";

          const stLbl =
            st === "executada" ? "‚úÖ Executada" :
            st === "problema" ? "‚ö†Ô∏è Com problema" :
            st === "nao_executada" ? "‚õî N√£o executada" :
            (n.status || "-");

          const div = document.createElement("div");
          div.className = "noteItem";
          div.innerHTML = `
            <div class="noteTop">
              <div><b>${escapeHtml(n.author || "‚Äî")}</b> ‚Ä¢ ${escapeHtml(fmtBRDateTime(n.created_at) || "")}</div>
              <div class="tag ${tagClass}">${escapeHtml(stLbl)}</div>
            </div>
            <div class="noteTxt">${escapeHtml(n.note || "")}</div>
          `;
          noteList.appendChild(div);
        });

      }catch(e){
        showError("Erro ao carregar notas: " + (e?.message || String(e)));
        notesHint.textContent = "Verifique as policies (SELECT/INSERT) na tabela notes.";
        noteList.innerHTML = "";
      }
    }

    // --------- init ---------
    async function init(){
      // default: hoje
      const now = new Date();
      state.selectedUTC = startOfDayUTC(new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())));
      state.monthCursor = new Date(Date.UTC(state.selectedUTC.getUTCFullYear(), state.selectedUTC.getUTCMonth(), 1));
      selDateLbl.textContent = fmtBR(state.selectedUTC);

      renderColsChooser();
      renderCalendar();

      await loadObras();
      applyAll();
    }

    await init();
  </script>
</body>
</html>
