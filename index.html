
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Acompanhamento UTEP</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .card {
      background: #1e293b;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    input, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: none;
    }

    button {
      background: #22c55e;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }

    .nota {
      background: #334155;
      padding: 8px;
      border-radius: 6px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<h1>Acompanhamento de Obras</h1>

<div id="lista"></div>

<script>
const supabase = window.supabase.createClient(
  "https://yyfhnuaffwzeglwcpnmkd.supabase.co",
  "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx"
);

async function carregarObras() {
  const { data } = await supabase.from("obras").select("*").limit(20);

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  data.forEach(obra => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <b>Nota:</b> ${obra.NOTA || "-"}<br>
      <b>Projeto:</b> ${obra.PROJETO || "-"}<br><br>

      <input placeholder="Seu nome" id="nome-${obra.NOTA}">
      <textarea placeholder="Adicionar anotação" id="texto-${obra.NOTA}"></textarea>
      <button onclick="salvarNota('${obra.NOTA}')">Salvar nota</button>

      <div id="notas-${obra.NOTA}"></div>
    `;

    lista.appendChild(div);

    carregarNotas(obra.NOTA);
  });
}

async function carregarNotas(nota) {
  const { data } = await supabase
    .from("notes")
    .select("*")
    .eq("nota", nota)
    .order("created_at", { ascending: false });

  const container = document.getElementById(`notas-${nota}`);
  container.innerHTML = "";

  data.forEach(n => {
    const el = document.createElement("div");
    el.className = "nota";
    el.innerHTML = `<b>${n.autor}</b> (${new Date(n.created_at).toLocaleString()})<br>${n.texto}`;
    container.appendChild(el);
  });
}

async function salvarNota(nota) {
  const nome = document.getElementById(`nome-${nota}`).value;
  const texto = document.getElementById(`texto-${nota}`).value;

  if (!nome || !texto) return alert("Preencha nome e nota");

  await supabase.from("notes").insert({
    nota,
    autor: nome,
    texto
  });

  carregarNotas(nota);
}

carregarObras();
</script>

</body>
</html>
