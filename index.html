<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento de Obras - UTEP Nordeste</title>
  <style>
    :root{
      --bg:#071b12;
      --card:#0d261a;
      --card2:#103022;
      --text:#eafff3;
      --muted:#b9e6cd;
      --accent:#66c28a;     /* verde cana */
      --accent2:#2ea86a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(102,194,138,.18), transparent 55%),
                  radial-gradient(800px 500px at 85% 5%, rgba(46,168,106,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title h1{margin:0;font-size:30px;letter-spacing:.3px}
    .title .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .rightTop{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 12px;
      color:var(--text);
      font-size:13px;
      display:flex;align-items:center;gap:8px;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      background:linear-gradient(135deg, var(--accent2), var(--accent));
      color:#052012;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(46,168,106,.20);
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      box-shadow:none;
    }
    .btn.whats{
      background:linear-gradient(135deg, #25D366, #1fb85a);
      color:#062012;
    }
    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin:14px 0 10px;
    }
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .tabs button{
      background:transparent;
      border:0;
      color:var(--muted);
      font-weight:700;
      cursor:pointer;
      padding:8px 10px;
      border-radius:10px;
    }
    .tabs button.active{
      color:var(--text);
      background:rgba(102,194,138,.12);
      border:1px solid rgba(102,194,138,.25);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .filters{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .filters{grid-template-columns:1fr}
      .title h1{font-size:24px}
      body{padding:12px}
    }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select, input[type="date"]{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    option{color:#08170f}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .hint b{color:var(--text)}
    .error{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,107,107,.10);
      border:1px solid rgba(255,107,107,.30);
      color:#ffdada;
      display:none;
      white-space:pre-wrap;
    }

    .sections{margin-top:14px;display:grid;gap:12px}
    .baseBlock{
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      overflow:hidden;
    }
    .baseHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      background:linear-gradient(90deg, rgba(102,194,138,.18), rgba(46,168,106,.08));
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .baseHead h2{margin:0;font-size:16px}
    .baseHead .count{
      color:var(--muted);
      font-size:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
    }

    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 820px;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    th{color:var(--muted);font-size:12px}
    tr:hover td{background:rgba(102,194,138,.06)}
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      white-space:nowrap;
    }
    .tag.exec{background:rgba(46,168,106,.20);border-color:rgba(46,168,106,.35)}
    .tag.prob{background:rgba(255,204,102,.20);border-color:rgba(255,204,102,.35);color:#fff3d6}
    .tag.nao{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.35);color:#ffdada}

    .small{color:var(--muted);font-size:12px}
    .actionsCell{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .miniBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:7px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    /* modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(760px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(13,38,26,.96), rgba(9,25,17,.96));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(102,194,138,.10);
    }
    .modalHead h3{margin:0;font-size:16px}
    .modalHead .meta{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.3}
    .modalBody{padding:14px 16px;display:grid;gap:10px}
    textarea, input[type="text"]{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:14px;
      padding:12px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){ .row2{grid-template-columns:1fr} }

    .modalFoot{
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .notesList{
      margin-top:6px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .noteItem{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .noteItem:last-child{border-bottom:0}
    .noteTop{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .noteTop b{font-size:13px}
    .noteText{margin-top:6px;color:var(--text);font-size:13px;white-space:pre-wrap}
    .footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      opacity:.9;
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div class="title">
      <h1>Acompanhamento de Obras</h1>
      <div class="sub">UTEP Nordeste ‚Ä¢ Supabase + GitHub Pages</div>
    </div>

    <div class="rightTop">
      <div class="pill">
        <b id="todayLabel">--/--/----</b>
      </div>
      <button class="btn secondary" id="reloadBtn">Recarregar</button>
    </div>
  </div>

  <div class="toolbar">
    <div class="tabs">
      <button class="active" id="tabFiltros">Filtros</button>
      <button id="tabDetalhes">+ Detalhes</button>
      <button class="btn whats" id="whatsBtn">Exportar WhatsApp (dia)</button>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <div>
        <label>Data (prazo final)</label>
        <input type="date" id="datePick" />
      </div>
      <div>
        <label>Base</label>
        <select id="baseSel">
          <option value="__ALL__">Todas</option>
          <option value="Alagoinhas">Alagoinhas</option>
          <option value="Ribeira do Pombal">Ribeira do Pombal</option>
          <option value="Paulo Afonso">Paulo Afonso</option>
        </select>
      </div>
      <div>
        <label>Crit√©rio</label>
        <select id="criterioSel">
          <option value="__ALL__">Todos</option>
        </select>
      </div>
      <div>
        <label>Munic√≠pio</label>
        <select id="munSel">
          <option value="__ALL__">Todos</option>
        </select>
      </div>
    </div>

    <div class="hint">
      Regras: mostra obras com <b>prazo final</b> na data escolhida. Se n√£o houver, mostra as <b>5 mais pr√≥ximas</b> dentro de <b>5 dias</b>.
    </div>

    <div id="err" class="error"></div>
  </div>

  <div id="sections" class="sections"></div>

  <div class="footer">
    UTEP Nordeste ‚Ä¢ Atualiza automaticamente quando voc√™ fizer commit no GitHub Pages
  </div>
</div>

<!-- MODAL NOTAS -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3 id="mTitle">Notas</h3>
        <div class="meta" id="mMeta"></div>
      </div>
      <button class="miniBtn" id="mCloseTop">Fechar</button>
    </div>
    <div class="modalBody">
      <div class="row2">
        <div>
          <label>Seu nome</label>
          <input type="text" id="mAutor" placeholder="Ex.: Jo√£o Silva" />
        </div>
        <div>
          <label>Status</label>
          <select id="mStatus">
            <option value="EXECUTADA">Executada</option>
            <option value="PROBLEMAS">Houve problemas</option>
            <option value="NAO_EXECUTADA">N√£o foi executada</option>
          </select>
        </div>
      </div>

      <div>
        <label>Adicionar nota</label>
        <textarea id="mTexto" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
      </div>

      <div>
        <label>Hist√≥rico (mais recentes primeiro)</label>
        <div class="notesList" id="mList"></div>
        <div class="small" id="mListHint"></div>
      </div>

      <div class="error" id="mErr"></div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="mClose">Fechar</button>
      <button class="btn" id="mSave">Salvar nota</button>
    </div>
  </div>
</div>

<script>
/** ===========================
 *  CONFIG (PREENCHA AQUI)
 *  ===========================
 */
const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx"; 

/** ===========================
 *  TABELAS / COLUNAS
 *  ===========================
 */
const TABLE_OBRAS = "obras";
const TABLE_NOTES = "notes";

// Campo de prazo final (ajuste se seu banco tiver outro nome)
const FIELD_PRAZO = "PREVISAO_EXECUCAO_FIM"; // data do prazo final

// Campos principais esperados em obras
const F = {
  NOTA: "NOTA",
  PROJETO: "PROJETO",
  TITULO: "TITULO",
  MUNICIPIO: "MUNICIPIO",
  CRITERIO: "CRITERIO",
  BASE: "BASE", // se n√£o existir, a gente deriva pelo munic√≠pio
};

// Campos da tabela notes
const N = {
  obra_nota: "obra_nota",
  autor: "autor",
  status: "status",
  note: "note",
  created_at: "created_at",
};

/** ===========================
 *  UTIL
 *  ===========================
 */
const $ = (id)=>document.getElementById(id);

function showErr(msg){
  const el = $("err");
  el.style.display = "block";
  el.textContent = msg;
}
function clearErr(){
  const el = $("err");
  el.style.display = "none";
  el.textContent = "";
}
function fmtBR(iso){
  if(!iso) return "";
  // aceita "YYYY-MM-DD" ou ISO completo
  const d = new Date(iso);
  if(String(d) === "Invalid Date") return String(iso);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function fmtBRDateTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(String(d) === "Invalid Date") return String(iso);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yy} ${hh}:${mi}`;
}
function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDaysISO(iso, days){
  const d = new Date(iso+"T00:00:00");
  d.setDate(d.getDate()+days);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function normalizeNota(v){
  if(v===null || v===undefined) return null;
  // vira string, remove espa√ßos e remove final ".0"
  let s = String(v).trim();
  if(s.endsWith(".0")) s = s.slice(0,-2);
  return s;
}
function getBaseFromMunicipio(m){
  const s = String(m||"").toUpperCase();
  // voc√™ pode refinar isso depois se precisar
  if(s.includes("ALAGOIN")) return "Alagoinhas";
  if(s.includes("RIBEIRA") || s.includes("POMBAL")) return "Ribeira do Pombal";
  if(s.includes("PAULO") || s.includes("AFONSO")) return "Paulo Afonso";
  return "Outros";
}

/** ===========================
 *  SUPABASE REST (SEM supabase-js)
 *  ===========================
 */
async function supaGet(path){
  const url = `${SUPABASE_URL}/rest/v1/${path}`;
  const res = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type":"application/json",
    }
  });
  const txt = await res.text();
  if(!res.ok){
    let extra = txt;
    try{ extra = JSON.stringify(JSON.parse(txt), null, 2); }catch(e){}
    throw new Error(`HTTP ${res.status} - ${res.statusText}\n${extra}`);
  }
  return txt ? JSON.parse(txt) : null;
}
async function supaPost(path, body){
  const url = `${SUPABASE_URL}/rest/v1/${path}`;
  const res = await fetch(url, {
    method:"POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type":"application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  if(!res.ok){
    let extra = txt;
    try{ extra = JSON.stringify(JSON.parse(txt), null, 2); }catch(e){}
    throw new Error(`HTTP ${res.status} - ${res.statusText}\n${extra}`);
  }
  return txt ? JSON.parse(txt) : null;
}

/** ===========================
 *  APP STATE
 *  ===========================
 */
let allRows = [];
let showDetails = false;
let currentShownDayISO = todayISO();
let modalNota = null; // string (nota normalizada)

function buildCriteriaOptions(rows){
  const set = new Set();
  rows.forEach(r=>{
    const c = (r[F.CRITERIO] ?? r[F.CRITERIO.toLowerCase()]);
    if(c) set.add(String(c));
  });
  const sel = $("criterioSel");
  const cur = sel.value;
  sel.innerHTML = `<option value="__ALL__">Todos</option>` + [...set].sort().map(v=>`<option>${escapeHtml(v)}</option>`).join("");
  if([...sel.options].some(o=>o.value===cur)) sel.value = cur;
}
function buildMunicipioOptions(rows){
  const set = new Set();
  rows.forEach(r=>{
    const m = (r[F.MUNICIPIO] ?? r[F.MUNICIPIO.toLowerCase()]);
    if(m) set.add(String(m));
  });
  const sel = $("munSel");
  const cur = sel.value;
  sel.innerHTML = `<option value="__ALL__">Todos</option>` + [...set].sort().map(v=>`<option>${escapeHtml(v)}</option>`).join("");
  if([...sel.options].some(o=>o.value===cur)) sel.value = cur;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function rowPrazoISO(r){
  const v = r[FIELD_PRAZO] ?? r[FIELD_PRAZO.toLowerCase()];
  if(!v) return null;
  // se vier "YYYY-MM-DD" ok; se vier dd/mm/aaaa, converte
  const s = String(v).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){
    const [dd,mm,yy] = s.split("/");
    return `${yy}-${mm}-${dd}`;
  }
  // tenta Date
  const d = new Date(s);
  if(String(d)==="Invalid Date") return null;
  return d.toISOString().slice(0,10);
}

function applyFilters(){
  const base = $("baseSel").value;
  const criterio = $("criterioSel").value;
  const mun = $("munSel").value;

  // data alvo
  const target = $("datePick").value || todayISO();

  // primeiro filtra por base/criterio/municipio
  const filtered = allRows.filter(r=>{
    const municipio = r[F.MUNICIPIO] ?? r[F.MUNICIPIO.toLowerCase()];
    const baseCalc = r[F.BASE] ?? r[F.BASE.toLowerCase()] ?? getBaseFromMunicipio(municipio);

    const crit = r[F.CRITERIO] ?? r[F.CRITERIO.toLowerCase()];
    const m = municipio ? String(municipio) : "";

    if(base !== "__ALL__" && baseCalc !== base) return false;
    if(criterio !== "__ALL__" && String(crit||"") !== criterio) return false;
    if(mun !== "__ALL__" && m !== mun) return false;
    return true;
  });

  // agora aplica a regra do ‚Äúdia‚Äù / fallback 5 pr√≥ximas em 5 dias
  const dayRows = filtered.filter(r=> rowPrazoISO(r) === target);

  let chosenRows = [];
  let chosenDay = target;

  if(dayRows.length > 0){
    chosenRows = dayRows;
  }else{
    const limit = addDaysISO(target, 5);
    const future = filtered
      .map(r=>({r, prazo: rowPrazoISO(r)}))
      .filter(x=>x.prazo && x.prazo > target && x.prazo <= limit)
      .sort((a,b)=> a.prazo.localeCompare(b.prazo));

    chosenRows = future.slice(0, 5).map(x=>x.r);
    chosenDay = target; // continua sendo o ‚Äúdia escolhido‚Äù, mas mostrando pr√≥ximas
  }

  currentShownDayISO = chosenDay;
  renderSections(chosenRows, filtered);
}

function groupByBase(rows){
  const groups = { "Alagoinhas": [], "Ribeira do Pombal": [], "Paulo Afonso": [] };
  rows.forEach(r=>{
    const municipio = r[F.MUNICIPIO] ?? r[F.MUNICIPIO.toLowerCase()];
    const baseCalc = r[F.BASE] ?? r[F.BASE.toLowerCase()] ?? getBaseFromMunicipio(municipio);
    if(groups[baseCalc]) groups[baseCalc].push(r);
  });
  return groups;
}

function renderSections(rowsToShow, rowsFiltered){
  const container = $("sections");
  container.innerHTML = "";

  // atualiza filtros dinamicamente com base em tudo carregado (ou filtrado)
  buildCriteriaOptions(allRows);
  buildMunicipioOptions(allRows);

  const groups = groupByBase(rowsToShow);

  const bases = ["Alagoinhas","Ribeira do Pombal","Paulo Afonso"];
  bases.forEach(base=>{
    const rows = groups[base] || [];
    const block = document.createElement("div");
    block.className = "baseBlock";
    block.innerHTML = `
      <div class="baseHead">
        <h2>${escapeHtml(base)}</h2>
        <div class="count">${rows.length} obra(s)</div>
      </div>
      <div class="tableWrap">
        ${renderTable(rows)}
      </div>
    `;
    container.appendChild(block);
  });
}

function renderTable(rows){
  if(!rows || rows.length===0){
    return `<div style="padding:12px;color:var(--muted)">Sem obras para exibir nesta base.</div>`;
  }

  // ordena por prazo final (mesmo dia vai empatar)
  rows = [...rows].sort((a,b)=>{
    const pa = rowPrazoISO(a)||"";
    const pb = rowPrazoISO(b)||"";
    return pa.localeCompare(pb);
  });

  const thExtra = showDetails ? `
    <th>Crit√©rio</th>
    <th>Munic√≠pio</th>
  ` : "";

  const tdExtra = (r)=>{
    if(!showDetails) return "";
    const crit = r[F.CRITERIO] ?? r[F.CRITERIO.toLowerCase()] ?? "";
    const mun = r[F.MUNICIPIO] ?? r[F.MUNICIPIO.toLowerCase()] ?? "";
    return `
      <td>${escapeHtml(crit)}</td>
      <td>${escapeHtml(mun)}</td>
    `;
  };

  return `
  <table>
    <thead>
      <tr>
        <th>Prazo final</th>
        <th>NOTA</th>
        <th>PROJETO</th>
        <th>T√çTULO</th>
        <th>A√ß√µes</th>
        ${thExtra}
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>{
        const prazo = rowPrazoISO(r);
        const nota = normalizeNota(r[F.NOTA] ?? r[F.NOTA.toLowerCase()]);
        const projeto = r[F.PROJETO] ?? r[F.PROJETO.toLowerCase()] ?? "";
        const titulo = r[F.TITULO] ?? r[F.TITULO.toLowerCase()] ?? "";
        return `
          <tr>
            <td>${escapeHtml(fmtBR(prazo))}</td>
            <td><span class="tag">${escapeHtml(nota||"")}</span></td>
            <td>${escapeHtml(projeto||"")}</td>
            <td>${escapeHtml(titulo||"")}</td>
            <td class="actionsCell">
              <button class="miniBtn" onclick="openNotes('${escapeHtml(nota||"")}')">Notas</button>
            </td>
            ${tdExtra(r)}
          </tr>
        `;
      }).join("")}
    </tbody>
  </table>
  `;
}

/** ===========================
 *  NOTES MODAL
 *  ===========================
 */
async function openNotes(notaStr){
  modalNota = normalizeNota(notaStr);
  $("mErr").style.display="none";
  $("mErr").textContent="";
  $("mTexto").value="";
  $("mStatus").value="EXECUTADA";

  $("mTitle").textContent = `Notas - NOTA ${modalNota || ""}`;

  // achar infos da obra
  const obra = allRows.find(r=> normalizeNota(r[F.NOTA] ?? r[F.NOTA.toLowerCase()]) === modalNota);
  const mun = obra ? (obra[F.MUNICIPIO] ?? obra[F.MUNICIPIO.toLowerCase()] ?? "") : "";
  const tit = obra ? (obra[F.TITULO] ?? obra[F.TITULO.toLowerCase()] ?? "") : "";
  const proj = obra ? (obra[F.PROJETO] ?? obra[F.PROJETO.toLowerCase()] ?? "") : "";
  $("mMeta").textContent = [proj, tit, mun].filter(Boolean).join(" ‚Ä¢ ");

  $("backdrop").style.display="flex";
  await loadNotes();
}

function closeNotes(){
  $("backdrop").style.display="none";
  modalNota = null;
}

function statusTag(s){
  if(s==="EXECUTADA") return `<span class="tag exec">Executada</span>`;
  if(s==="PROBLEMAS") return `<span class="tag prob">Houve problemas</span>`;
  if(s==="NAO_EXECUTADA") return `<span class="tag nao">N√£o executada</span>`;
  return `<span class="tag">${escapeHtml(s||"")}</span>`;
}

async function loadNotes(){
  $("mList").innerHTML = `<div class="noteItem">Carregando...</div>`;
  $("mListHint").textContent = "";

  try{
    const nota = modalNota;
    if(!nota){
      $("mList").innerHTML = `<div class="noteItem">NOTA inv√°lida.</div>`;
      return;
    }

    // busca notes por obra_nota
    const data = await supaGet(`${TABLE_NOTES}?select=${encodeURIComponent("autor,status,note,created_at")}&${N.obra_nota}=eq.${encodeURIComponent(nota)}&order=${N.created_at}.desc`);
    if(!data || data.length===0){
      $("mList").innerHTML = `<div class="noteItem">Sem anota√ß√µes ainda.</div>`;
      return;
    }

    $("mList").innerHTML = data.map(n=>{
      const autor = n[N.autor] || "‚Äî";
      const st = n[N.status] || "";
      const dt = n[N.created_at] || "";
      const txt = n[N.note] || "";
      return `
        <div class="noteItem">
          <div class="noteTop">
            <div><b>${escapeHtml(autor)}</b> <span class="small">‚Ä¢ ${escapeHtml(fmtBRDateTime(dt))}</span></div>
            <div>${statusTag(st)}</div>
          </div>
          <div class="noteText">${escapeHtml(txt)}</div>
        </div>
      `;
    }).join("");

  }catch(e){
    $("mList").innerHTML = `<div class="noteItem">N√£o consegui carregar notas.</div>`;
    $("mListHint").textContent = "Verifique internet e as policies (SELECT) da tabela notes.";
    $("mErr").style.display="block";
    $("mErr").textContent = String(e.message || e);
  }
}

async function saveNote(){
  $("mErr").style.display="none";
  $("mErr").textContent="";

  const autor = $("mAutor").value.trim();
  const status = $("mStatus").value;
  const texto = $("mTexto").value.trim();
  const nota = modalNota;

  if(!autor){
    $("mErr").style.display="block";
    $("mErr").textContent="Informe seu nome.";
    return;
  }
  if(!texto){
    $("mErr").style.display="block";
    $("mErr").textContent="Escreva uma anota√ß√£o antes de salvar.";
    return;
  }
  if(!nota){
    $("mErr").style.display="block";
    $("mErr").textContent="NOTA inv√°lida.";
    return;
  }

  try{
    await supaPost(`${TABLE_NOTES}`, [{
      [N.obra_nota]: nota,
      [N.autor]: autor,
      [N.status]: status,
      [N.note]: texto
    }]);

    $("mTexto").value="";
    await loadNotes();
  }catch(e){
    $("mErr").style.display="block";
    $("mErr").textContent=String(e.message || e);
  }
}

/** ===========================
 *  WHATSAPP EXPORT
 *  ===========================
 */
function exportWhats(){
  // usa as obras do dia que est√£o renderizadas (por base)
  // pega do DOM por simplicidade: varre as tabelas
  const blocks = document.querySelectorAll(".baseBlock");
  const day = $("datePick").value || todayISO();
  const dayBR = fmtBR(day);

  let msg = `üìã *Obras do dia (${dayBR})* - UTEP Nordeste\n`;

  blocks.forEach(b=>{
    const base = b.querySelector(".baseHead h2")?.textContent?.trim();
    const rows = [...b.querySelectorAll("tbody tr")];
    if(rows.length===0) return;

    msg += `\nüè∑Ô∏è *${base}*\n`;
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      const prazo = tds[0]?.textContent?.trim() || "";
      const nota = tds[1]?.textContent?.trim() || "";
      const projeto = tds[2]?.textContent?.trim() || "";
      const titulo = tds[3]?.textContent?.trim() || "";
      msg += `‚Ä¢ ${prazo} | ${nota} | ${projeto} | ${titulo}\n`;
    });
  });

  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}

/** ===========================
 *  LOAD OBRAS
 *  ===========================
 */
async function loadObras(){
  clearErr();
  $("sections").innerHTML = "";

  // Mostra data de hoje no topo
  $("todayLabel").textContent = fmtBR(todayISO());

  try{
    // puxa s√≥ os campos que usamos + campo de prazo
    const cols = [
      F.NOTA, F.PROJETO, F.TITULO, F.MUNICIPIO, F.CRITERIO, F.BASE, FIELD_PRAZO
    ];

    const select = cols.map(c=>`"${c}"`).join(",");
    const data = await supaGet(`${TABLE_OBRAS}?select=${encodeURIComponent(select)}`);

    if(!data || data.length===0){
      showErr("Tabela 'obras' est√° vazia ou n√£o retornou dados.");
      allRows = [];
      return;
    }

    // normaliza NOTA e base
    allRows = data.map(r=>{
      const rr = {...r};
      rr[F.NOTA] = normalizeNota(rr[F.NOTA] ?? rr[F.NOTA.toLowerCase()]);
      const mun = rr[F.MUNICIPIO] ?? rr[F.MUNICIPIO.toLowerCase()];
      rr[F.BASE] = rr[F.BASE] ?? rr[F.BASE.toLowerCase()] ?? getBaseFromMunicipio(mun);
      return rr;
    });

    // popular selects de crit√©rio/munic√≠pio
    buildCriteriaOptions(allRows);
    buildMunicipioOptions(allRows);

    applyFilters();

  }catch(e){
    showErr(
`N√£o consegui carregar dados da tabela '${TABLE_OBRAS}'.\n\nDetalhe: ${e.message || e}\n\nVerifique:
- SUPABASE_URL e ANON_KEY (sb_publishable)
- RLS/policies da tabela obras (SELECT para anon)
- Se a tabela se chama '${TABLE_OBRAS}'`
    );
  }
}

/** ===========================
 *  UI EVENTS
 *  ===========================
 */
$("reloadBtn").addEventListener("click", loadObras);
$("datePick").addEventListener("change", applyFilters);
$("baseSel").addEventListener("change", applyFilters);
$("criterioSel").addEventListener("change", applyFilters);
$("munSel").addEventListener("change", applyFilters);

$("tabDetalhes").addEventListener("click", ()=>{
  showDetails = !showDetails;
  $("tabDetalhes").classList.toggle("active", showDetails);
  applyFilters();
});

$("whatsBtn").addEventListener("click", exportWhats);

$("mClose").addEventListener("click", closeNotes);
$("mCloseTop").addEventListener("click", closeNotes);
$("backdrop").addEventListener("click", (e)=>{ if(e.target.id==="backdrop") closeNotes(); });
$("mSave").addEventListener("click", saveNote);

// deixa fun√ß√£o global pro onclick do bot√£o "Notas"
window.openNotes = openNotes;

// init
(function init(){
  const iso = todayISO();
  $("datePick").value = iso;
  loadObras();
})();
</script>
</body>
</html>
