<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento Diário SLA - UTEP Nordeste</title>

  <style>
    :root{
      --bg:#0b1f14;
      --card:#0f2a1c;
      --card2:#103122;
      --text:#eafff2;
      --muted:#bfe8cf;
      --accent:#2fbf71;   /* verde cana */
      --accent2:#1e9e5a;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --ok:#2fbf71;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(47,191,113,.18), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(47,191,113,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,31,20,.78);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .sub{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(47,191,113,.20), rgba(47,191,113,.08));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:.15s transform, .15s opacity;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
    }
    .btn.ghost{
      background: transparent;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.04);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:14px;
      max-width:1100px;
      margin:0 auto;
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .filters{
      display:none;
      margin-top:10px;
      gap:10px;
      grid-template-columns: repeat(12, 1fr);
    }
    .filters.show{display:grid}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    select,input[type="date"],input[type="text"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    .fcol{grid-column: span 6;}
    .fcol3{grid-column: span 3;}
    .fcol4{grid-column: span 4;}
    .fcol12{grid-column: span 12;}

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .err{
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
      color:#ffdede;
      padding:10px;
      border-radius:12px;
      display:none;
      white-space:pre-wrap;
    }

    .bases{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .baseCard{
      background:linear-gradient(180deg, rgba(47,191,113,.12), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
    }
    .baseHeader{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .baseTitle{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .baseMeta{font-size:12px;color:var(--muted)}

    .tableWrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 860px;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    th{
      position:sticky; top:0;
      background: rgba(15,42,28,.95);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size:12px;
      letter-spacing:.25px;
      text-transform:uppercase;
    }
    tr:hover td{background: rgba(255,255,255,.03)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(47,191,113,.35); color:#d7ffe9}
    .tag.warn{border-color: rgba(255,209,102,.35); color:#fff1c7}
    .tag.bad{border-color: rgba(255,107,107,.35); color:#ffdede}
    .linkBtn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:14px; z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      max-height: 88vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,49,34,.98), rgba(15,42,28,.98));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:8px;
    }
    .modalTitle{margin:0;font-size:16px}
    .modalSub{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .modalGrid{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
      margin-top:10px;
    }
    textarea{
      width:100%;
      min-height: 90px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      resize:vertical;
    }
    .notesList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .noteItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.04);
    }
    .noteTop{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:6px;
    }
    .noteAuthor{font-weight:800}
    .noteWhen{color:var(--muted); font-size:12px}
    .noteText{white-space:pre-wrap; margin:0; color:#eafff2}
    .footer{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      padding:14px 0 20px;
    }

    @media (max-width: 760px){
      table{min-width: 760px}
      .fcol, .fcol4, .fcol3{grid-column: span 12;}
      .btn{width:100%}
      .row{width:100%}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Acompanhamento de Obras</h1>
        <div class="sub">UTEP Nordeste • Supabase + GitHub Pages</div>
      </div>

      <div class="row">
        <span class="pill" id="versao">Versão: V3.0 FINAL</span>
        <button class="btn secondary" id="btnHoje">Hoje</button>
        <button class="btn secondary" id="btnAmanha">Amanhã</button>
        <input type="date" id="dataRef" />
        <button class="btn" id="btnRecarregar">Recarregar</button>
      </div>

      <div class="row">
        <button class="btn ghost" id="btnFiltros">Filtros</button>
        <button class="btn ghost" id="btnDetalhes">+ Detalhes</button>
        <button class="btn" id="btnWhats">Exportar WhatsApp (dia)</button>
      </div>
    </div>

    <div class="filters panel" id="filters">
      <div class="fcol3">
        <label>Base</label>
        <select id="fBase">
          <option value="">Todas</option>
          <option value="ALAGOINHAS">Alagoinhas</option>
          <option value="RIBEIRA DO POMBAL">Ribeira do Pombal</option>
          <option value="PAULO AFONSO">Paulo Afonso</option>
        </select>
      </div>

      <div class="fcol3">
        <label>Critério</label>
        <select id="fCriterio"><option value="">Todos</option></select>
      </div>

      <div class="fcol3">
        <label>Município</label>
        <select id="fMunicipio"><option value="">Todos</option></select>
      </div>

      <div class="fcol3">
        <label>Projeto</label>
        <select id="fProjeto"><option value="">Todos</option></select>
      </div>

      <div class="fcol12">
        <div class="hint">
          Regras: mostra obras com <b>prazo final</b> na data escolhida. Se não houver, mostra as <b>5 mais próximas</b> dentro de <b>5 dias</b> (por base).
        </div>
        <div class="err" id="errBox"></div>
      </div>
    </div>
  </div>
</header>

<main class="grid">
  <div class="panel">
    <div class="bases" id="bases"></div>
  </div>
</main>

<div class="footer">UTEP Nordeste • Atualiza automaticamente quando você fizer commit no GitHub.</div>

<!-- Modal de Notas -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3 class="modalTitle" id="mTitle">Notas</h3>
        <div class="modalSub" id="mSub"></div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnFecharModal">Fechar</button>
      </div>
    </div>

    <div class="modalGrid">
      <div>
        <label>Seu nome (obrigatório)</label>
        <input type="text" id="mAuthor" placeholder="Ex.: João Silva" />
      </div>

      <div>
        <label>Status da execução</label>
        <select id="mStatus">
          <option value="EXECUTADA">Executada</option>
          <option value="PROBLEMAS">Houve problemas</option>
          <option value="NAO_EXECUTADA">Não foi executada</option>
        </select>
      </div>

      <div>
        <label>Adicionar nota</label>
        <textarea id="mNote" placeholder="Escreva a observação desta obra..."></textarea>
      </div>

      <div class="row">
        <button class="btn" id="btnSalvarNota">Salvar nota</button>
      </div>

      <div>
        <div class="hint">Notas registradas (todos veem):</div>
        <div class="notesList" id="mList"></div>
      </div>

      <div class="err" id="mErr"></div>
    </div>
  </div>
</div>

<!-- Supabase (sem module/import para evitar erro em GitHub Pages) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/** =========================
 *  CONFIG (SUBSTITUA AQUI)
 *  ========================= */
const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co"; // OK (seu print)
const SUPABASE_ANON_KEY = "COLE_AQUI_SUA_SB_PUBLISHABLE_KEY";     // troque

/** =========================
 *  TABELAS
 *  ========================= */
const TBL_OBRAS = "obras";
const TBL_NOTES = "notes";

/** =========================
 *  CAMPOS (tentamos ler por nomes comuns)
 *  ========================= */
const FIELD_NOTA = "nota";
const FIELD_TITULO = "titulo";
const FIELD_PROJETO = "projeto";
const FIELD_MUNICIPIO = "municipio";
const FIELD_CRITERIO = "criterio";
const FIELD_BASE = "base";
const FIELD_PRAZO = "previsao_execucao_fim";
const FIELD_EXTRA_BASE_OPER = "base_oper_prog"; // nova coluna opcional

/** =========================
 *  UI
 *  ========================= */
const elBases = document.getElementById("bases");
const elErr = document.getElementById("errBox");
const elFilters = document.getElementById("filters");
const btnFiltros = document.getElementById("btnFiltros");
const btnDetalhes = document.getElementById("btnDetalhes");
const btnRecarregar = document.getElementById("btnRecarregar");
const btnWhats = document.getElementById("btnWhats");
const dataRef = document.getElementById("dataRef");
const btnHoje = document.getElementById("btnHoje");
const btnAmanha = document.getElementById("btnAmanha");

const fBase = document.getElementById("fBase");
const fCriterio = document.getElementById("fCriterio");
const fMunicipio = document.getElementById("fMunicipio");
const fProjeto = document.getElementById("fProjeto");

let showDetails = false;
let cachedRows = [];
let client = null;

function setError(msg){
  if(!msg){
    elErr.style.display = "none";
    elErr.textContent = "";
    return;
  }
  elErr.style.display = "block";
  elErr.textContent = msg;
}

function yyyy_mm_dd(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ddmmyyyy(iso){
  if(!iso) return "";
  const s = String(iso).slice(0,10);
  const [y,m,d] = s.split("-");
  if(!y||!m||!d) return s;
  return `${d}/${m}/${y}`;
}
function normUpper(v){
  return String(v ?? "").trim().toUpperCase();
}
function safeStr(v){
  return (v === null || v === undefined) ? "" : String(v);
}
function getField(row, key){
  // tenta key direto, e variações comuns (maiúsculo)
  if(row && Object.prototype.hasOwnProperty.call(row, key)) return row[key];
  const up = key.toUpperCase();
  if(row && Object.prototype.hasOwnProperty.call(row, up)) return row[up];
  return null;
}
function notaKey(v){
  // normaliza "910233..." e "910233....0" para bater
  const s = safeStr(v).trim();
  return s.endsWith(".0") ? s.slice(0,-2) : s;
}

/** =========================
 *  SUPABASE INIT
 *  ========================= */
function initSupabase(){
  try{
    client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }catch(e){
    setError("Erro ao iniciar Supabase: " + e.message);
  }
}

/** =========================
 *  FETCH OBRAS
 *  ========================= */
async function fetchObras(){
  setError("");
  elBases.innerHTML = `<div class="hint">Carregando obras...</div>`;

  const { data, error } = await client
    .from(TBL_OBRAS)
    .select("*")
    .limit(2000);

  if(error){
    elBases.innerHTML = "";
    setError(
      "Não consegui carregar dados da tabela 'obras'.\n\n" +
      "Detalhe: " + (error.message || JSON.stringify(error)) +
      "\n\nVerifique:\n- SUPABASE_URL e ANON_KEY\n- RLS/policies da tabela obras (SELECT para anon)\n- Se a tabela se chama 'obras'\n"
    );
    return;
  }

  cachedRows = Array.isArray(data) ? data : [];
  if(cachedRows.length === 0){
    elBases.innerHTML = "";
    setError("Tabela 'obras' retornou 0 registros. Verifique se importou o CSV na tabela correta.");
    return;
  }

  buildFilterOptions(cachedRows);
  render();
}

/** =========================
 *  FILTROS
 *  ========================= */
function uniqueSorted(list){
  const set = new Set(list.filter(v=>v!=="" && v!==null && v!==undefined));
  return Array.from(set).sort((a,b)=>String(a).localeCompare(String(b), "pt-BR"));
}

function fillSelect(selectEl, values){
  const current = selectEl.value;
  selectEl.innerHTML = `<option value="">Todos</option>` + values.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");
  selectEl.value = current;
}

function buildFilterOptions(rows){
  const criterios = uniqueSorted(rows.map(r=>normUpper(getField(r, FIELD_CRITERIO))));
  const municipios = uniqueSorted(rows.map(r=>normUpper(getField(r, FIELD_MUNICIPIO))));
  const projetos = uniqueSorted(rows.map(r=>safeStr(getField(r, FIELD_PROJETO)).trim()).filter(Boolean));

  fillSelect(fCriterio, criterios);
  fillSelect(fMunicipio, municipios);
  fillSelect(fProjeto, projetos);
}

/** =========================
 *  REGRAS DO DIA / PRÓXIMAS
 *  ========================= */
function filterByUI(rows){
  const baseSel = normUpper(fBase.value);
  const critSel = normUpper(fCriterio.value);
  const munSel = normUpper(fMunicipio.value);
  const projSel = safeStr(fProjeto.value).trim();

  return rows.filter(r=>{
    const base = normUpper(getField(r, FIELD_BASE));
    const crit = normUpper(getField(r, FIELD_CRITERIO));
    const mun  = normUpper(getField(r, FIELD_MUNICIPIO));
    const proj = safeStr(getField(r, FIELD_PROJETO)).trim();

    if(baseSel && base !== baseSel) return false;
    if(critSel && crit !== critSel) return false;
    if(munSel  && mun  !== munSel)  return false;
    if(projSel && proj !== projSel) return false;
    return true;
  });
}

function toDateOnly(iso){
  // iso "2026-02-02" ou timestamp
  const s = safeStr(iso).slice(0,10);
  const [y,m,d] = s.split("-");
  if(!y||!m||!d) return null;
  return new Date(Number(y), Number(m)-1, Number(d));
}

function withinDays(date, ref, days){
  const ms = date.getTime() - ref.getTime();
  const diff = Math.floor(ms / (1000*60*60*24));
  return diff >= 0 && diff <= days;
}

function pickForBase(rowsAll, baseName, refDate){
  const baseU = normUpper(baseName);
  const rows = rowsAll.filter(r=>normUpper(getField(r, FIELD_BASE)) === baseU);

  const dayISO = yyyy_mm_dd(refDate);

  const today = rows.filter(r=>{
    const prazo = safeStr(getField(r, FIELD_PRAZO)).slice(0,10);
    return prazo === dayISO;
  });

  if(today.length > 0){
    return { mode:"HOJE", items: sortByPrazo(today).slice(0, 200) };
  }

  // se não tem no dia -> pega próximos até 5 dias
  const upcoming = rows
    .map(r=>{
      const d = toDateOnly(getField(r, FIELD_PRAZO));
      return { r, d };
    })
    .filter(x=>x.d && withinDays(x.d, refDate, 5))
    .sort((a,b)=>a.d - b.d)
    .map(x=>x.r)
    .slice(0,5);

  return { mode:"PROXIMAS", items: upcoming };
}

function sortByPrazo(rows){
  return rows.slice().sort((a,b)=>{
    const da = toDateOnly(getField(a, FIELD_PRAZO))?.getTime() ?? 0;
    const db = toDateOnly(getField(b, FIELD_PRAZO))?.getTime() ?? 0;
    return da - db;
  });
}

/** =========================
 *  RENDER
 *  ========================= */
function render(){
  setError("");
  const ref = dataRef.value ? toDateOnly(dataRef.value) : new Date();
  const rows = filterByUI(cachedRows);

  const bases = [
    { key:"ALAGOINHAS", label:"Alagoinhas" },
    { key:"RIBEIRA DO POMBAL", label:"Ribeira do Pombal" },
    { key:"PAULO AFONSO", label:"Paulo Afonso" }
  ];

  const cards = bases.map(b=>{
    const picked = pickForBase(rows, b.key, ref);
    return renderBaseCard(b.label, b.key, picked.mode, picked.items, ref);
  });

  elBases.innerHTML = cards.join("");
  bindNotesButtons();
}

function renderBaseCard(label, baseKey, mode, items, refDate){
  const dayStr = ddmmyyyy(yyyy_mm_dd(refDate));
  const meta = mode === "HOJE"
    ? `Obras com prazo final em <b>${dayStr}</b>`
    : `Sem obras no dia • Mostrando <b>5 próximas</b> (até +5 dias)`;

  if(!items || items.length === 0){
    return `
      <div class="baseCard">
        <div class="baseHeader">
          <div>
            <div class="baseTitle">${label}</div>
            <div class="baseMeta">${meta}</div>
          </div>
          <span class="tag bad">0 obras</span>
        </div>
        <div class="hint">Nada para exibir com os filtros atuais.</div>
      </div>
    `;
  }

  const rowsHtml = items.map(r=>{
    const nota = safeStr(getField(r, FIELD_NOTA));
    const projeto = safeStr(getField(r, FIELD_PROJETO));
    const titulo = safeStr(getField(r, FIELD_TITULO));
    const municipio = safeStr(getField(r, FIELD_MUNICIPIO));
    const criterio = safeStr(getField(r, FIELD_CRITERIO));
    const prazo = ddmmyyyy(getField(r, FIELD_PRAZO));

    const extraBaseOper = safeStr(getField(r, FIELD_EXTRA_BASE_OPER));

    return `
      <tr>
        <td><b>${nota}</b></td>
        <td>${projeto || `<span class="tag warn">sem projeto</span>`}</td>
        <td>${titulo}</td>
        <td>${municipio}</td>
        <td>${prazo}</td>
        ${showDetails ? `<td>${criterio}</td>` : ``}
        ${showDetails ? `<td>${extraBaseOper}</td>` : ``}
        <td>
          <button class="linkBtn" data-nota="${String(nota).replaceAll('"','&quot;')}" data-base="${baseKey}">
            Notas
          </button>
        </td>
      </tr>
    `;
  }).join("");

  const thExtras = showDetails
    ? `<th>Critério</th><th>BASE_OPER_PROG</th>`
    : ``;

  const tdCount = items.length;

  return `
    <div class="baseCard">
      <div class="baseHeader">
        <div>
          <div class="baseTitle">${label}</div>
          <div class="baseMeta">${meta}</div>
        </div>
        <span class="tag ${mode==="HOJE" ? "ok" : "warn"}">${tdCount} obras</span>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Nota</th>
              <th>Projeto</th>
              <th>Título</th>
              <th>Município</th>
              <th>Prazo Final</th>
              ${thExtras}
              <th>Anotações</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

/** =========================
 *  WHATSAPP EXPORT (só do dia)
 *  ========================= */
function exportWhats(){
  const ref = dataRef.value ? toDateOnly(dataRef.value) : new Date();
  const rows = filterByUI(cachedRows);

  const dayISO = yyyy_mm_dd(ref);
  const dayStr = ddmmyyyy(dayISO);

  const bases = [
    { key:"ALAGOINHAS", label:"Alagoinhas" },
    { key:"RIBEIRA DO POMBAL", label:"Ribeira do Pombal" },
    { key:"PAULO AFONSO", label:"Paulo Afonso" }
  ];

  let txt = `*Obras com prazo final HOJE (${dayStr})*\n\n`;
  let total = 0;

  for(const b of bases){
    const list = rows.filter(r=>{
      return normUpper(getField(r, FIELD_BASE)) === b.key
        && safeStr(getField(r, FIELD_PRAZO)).slice(0,10) === dayISO;
    });

    if(list.length === 0) continue;
    total += list.length;

    txt += `*${b.label}*\n`;
    for(const r of list){
      const nota = safeStr(getField(r, FIELD_NOTA));
      const proj = safeStr(getField(r, FIELD_PROJETO));
      const tit  = safeStr(getField(r, FIELD_TITULO));
      const mun  = safeStr(getField(r, FIELD_MUNICIPIO));
      txt += `- ${nota} | ${proj} | ${tit} | ${mun}\n`;
    }
    txt += `\n`;
  }

  if(total === 0){
    alert("Não há obras com prazo final para o dia selecionado. (WhatsApp exporta somente as do dia.)");
    return;
  }

  const url = "https://wa.me/?text=" + encodeURIComponent(txt);
  window.open(url, "_blank");
}

/** =========================
 *  NOTAS (SUPABASE)
 *  ========================= */
const backdrop = document.getElementById("backdrop");
const btnFecharModal = document.getElementById("btnFecharModal");
const btnSalvarNota = document.getElementById("btnSalvarNota");
const mTitle = document.getElementById("mTitle");
const mSub = document.getElementById("mSub");
const mAuthor = document.getElementById("mAuthor");
const mStatus = document.getElementById("mStatus");
const mNote = document.getElementById("mNote");
const mList = document.getElementById("mList");
const mErr = document.getElementById("mErr");

let currentNota = null;
let currentBase = null;

function openModal({nota, base}){
  currentNota = notaKey(nota);
  currentBase = base;
  mTitle.textContent = `Notas - Nota ${nota}`;
  mSub.textContent = `Base: ${base}`;
  mErr.style.display = "none";
  mErr.textContent = "";
  mNote.value = "";
  backdrop.style.display = "flex";
  loadNotes();
}

function closeModal(){
  backdrop.style.display = "none";
  currentNota = null;
  currentBase = null;
}

btnFecharModal.addEventListener("click", closeModal);
backdrop.addEventListener("click", (e)=>{
  if(e.target === backdrop) closeModal();
});

function formatWhen(iso){
  if(!iso) return "";
  try{
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }catch{
    return iso;
  }
}

function statusTag(s){
  const v = normUpper(s);
  if(v === "EXECUTADA") return `<span class="tag ok">Executada</span>`;
  if(v === "PROBLEMAS") return `<span class="tag warn">Problemas</span>`;
  if(v === "NAO_EXECUTADA") return `<span class="tag bad">Não executada</span>`;
  return `<span class="tag">${safeStr(s)}</span>`;
}

async function loadNotes(){
  if(!currentNota) return;

  mList.innerHTML = `<div class="hint">Carregando notas...</div>`;

  // tenta bater tanto nota "com .0" quanto sem
  const notaRaw = safeStr(currentNota);
  const notaDot = notaRaw.endsWith(".0") ? notaRaw : (notaRaw + ".0");

  const { data, error } = await client
    .from(TBL_NOTES)
    .select("*")
    .or(`nota.eq.${notaRaw},nota.eq.${notaDot}`)
    .order("created_at", { ascending:false })
    .limit(200);

  if(error){
    mList.innerHTML = "";
    mErr.style.display = "block";
    mErr.textContent = "Não consegui carregar notas. Verifique internet e policies no Supabase.\n\n" + (error.message || JSON.stringify(error));
    return;
  }

  const notes = Array.isArray(data) ? data : [];
  if(notes.length === 0){
    mList.innerHTML = `<div class="hint">Nenhuma nota ainda.</div>`;
    return;
  }

  mList.innerHTML = notes.map(n=>{
    const author = safeStr(getField(n,"author"));
    const note = safeStr(getField(n,"note"));
    const status = safeStr(getField(n,"status"));
    const when = formatWhen(getField(n,"created_at"));

    return `
      <div class="noteItem">
        <div class="noteTop">
          <div><span class="noteAuthor">${author || "—"}</span> ${statusTag(status)}</div>
          <div class="noteWhen">${when}</div>
        </div>
        <p class="noteText">${note ? note.replaceAll("<","&lt;").replaceAll(">","&gt;") : ""}</p>
      </div>
    `;
  }).join("");
}

btnSalvarNota.addEventListener("click", async ()=>{
  mErr.style.display = "none";
  mErr.textContent = "";

  const author = mAuthor.value.trim();
  const status = mStatus.value;
  const note = mNote.value.trim();

  if(!author){
    mErr.style.display = "block";
    mErr.textContent = "Informe seu nome.";
    return;
  }
  if(!note){
    mErr.style.display = "block";
    mErr.textContent = "Escreva uma nota antes de salvar.";
    return;
  }

  // salva nota usando nota normalizada + também com .0 para garantir match
  const notaRaw = safeStr(currentNota);
  const notaDot = notaRaw.endsWith(".0") ? notaRaw : (notaRaw + ".0");

  const payload = {
    nota: notaDot, // padroniza com .0 pois sua tabela 'obras' usa assim
    author,
    status,
    note
  };

  const { error } = await client
    .from(TBL_NOTES)
    .insert(payload);

  if(error){
    mErr.style.display = "block";
    mErr.textContent = "Erro ao salvar nota.\n\n" + (error.message || JSON.stringify(error));
    return;
  }

  mNote.value = "";
  await loadNotes();
});

/** =========================
 *  BIND BOTÕES NOTAS
 *  ========================= */
function bindNotesButtons(){
  document.querySelectorAll('button[data-nota]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const nota = btn.getAttribute("data-nota");
      const base = btn.getAttribute("data-base") || "";
      openModal({nota, base});
    });
  });
}

/** =========================
 *  EVENTOS
 *  ========================= */
btnFiltros.addEventListener("click", ()=>{
  elFilters.classList.toggle("show");
});

btnDetalhes.addEventListener("click", ()=>{
  showDetails = !showDetails;
  btnDetalhes.textContent = showDetails ? "– Detalhes" : "+ Detalhes";
  render();
});

btnRecarregar.addEventListener("click", fetchObras);
btnWhats.addEventListener("click", exportWhats);

[fBase, fCriterio, fMunicipio, fProjeto].forEach(el=>{
  el.addEventListener("change", render);
});

btnHoje.addEventListener("click", ()=>{
  const d = new Date();
  dataRef.value = yyyy_mm_dd(d);
  render();
});
btnAmanha.addEventListener("click", ()=>{
  const d = new Date();
  d.setDate(d.getDate()+1);
  dataRef.value = yyyy_mm_dd(d);
  render();
});
dataRef.addEventListener("change", render);

/** =========================
 *  START
 *  ========================= */
(function start(){
  // default = hoje
  const d = new Date();
  dataRef.value = yyyy_mm_dd(d);

  initSupabase();

  // valida se user colou a key
  if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("COLE_AQUI")){
    setError(
      "Você ainda não colou a SB publishable key no index.html.\n\n" +
      "Vá em Settings → API Keys → Publishable key e cole em SUPABASE_ANON_KEY."
    );
    elBases.innerHTML = "";
    return;
  }

  fetchObras();
})();
</script>
</body>
</html>