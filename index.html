<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acompanhamento de Obras</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1f13;
      --card:#0f2a1a;
      --line:#1f4d31;
      --text:#eafff1;
      --muted:#a6d7bb;
      --accent:#6fbf4a;
      --dark:#07140d;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    body{font-family:Arial, sans-serif;background:var(--bg);color:var(--text);margin:0;padding:14px}
    h1{margin:6px 0 8px;text-align:center;font-size:24px}
    .sub{max-width:1100px;margin:0 auto 12px;text-align:center;color:var(--muted);font-size:13px;line-height:1.35}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin-bottom:12px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn-green{background:var(--accent);color:#07210f}
    .btn-gray{background:#1e3a2a;color:#fff}
    .btn-ghost{background:transparent;color:#fff;border:1px solid var(--line)}
    .input{
      background:var(--dark);
      border:1px solid var(--line);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      min-width:260px;
    }
    select{background:var(--dark);border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px;width:100%}

    .filters{max-width:1100px;margin:0 auto 12px;display:none}
    .filters.on{display:block}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .label{color:var(--muted);font-size:12px;margin-bottom:6px}

    .wrap{max-width:1100px;margin:0 auto}
    .error{max-width:1100px;margin:0 auto 12px;background:#7f1d1d;border:1px solid #ef4444;color:#fff;padding:10px;border-radius:12px;display:none;white-space:pre-wrap}
    .footer{max-width:1100px;margin:22px auto 8px;text-align:center;color:var(--muted);font-size:12px}

    /* CALEND√ÅRIO */
    .calWrap{max-width:1100px;margin:0 auto 12px}
    .calCard{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:12px}
    .calHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .calTitle{font-weight:900}
    .calBtns{display:flex;gap:10px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .calDow{color:var(--muted);font-size:12px;text-align:center}
    .day{
      text-align:center;
      padding:10px 0;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .day.muted{opacity:.35;cursor:default}
    .day.today{border-color:rgba(111,191,74,.5)}
    .day.sel{background:rgba(111,191,74,.35);border-color:var(--accent)}
    .day:hover{border-color:rgba(111,191,74,.35)}
    .calInfo{margin-top:10px;color:var(--muted);font-size:13px}

    /* BASES */
    .bases{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .baseCol{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .baseHead{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .baseTitle{font-weight:900}
    .baseMeta{color:var(--muted);font-size:12px}

    /* OBRA */
    .card{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:16px;padding:12px;margin-top:10px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .title{font-size:15px;font-weight:900;margin-top:4px}
    .topRight{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}

    .kvs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .kv{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:2px}
    .kv span{font-weight:900}

    .moreCols{display:none}
    .moreOn .moreCols{display:flex}

    .empty{margin:10px 0;text-align:center;color:var(--muted);font-size:13px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .b-ok{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
    .b-warn{border-color:rgba(245,158,11,.55); background:rgba(245,158,11,.12)}
    .b-bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
    .b-none{opacity:.9}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .modalBack.on{display:flex}
    .modal{width:min(900px,100%);background:rgba(15,42,26,.98);border:1px solid var(--line);border-radius:16px;padding:14px}
    .modalHead{display:flex;gap:10px;justify-content:space-between;align-items:flex-start}
    .modalTitle{font-weight:900;font-size:18px;margin:0}
    input, textarea{
      width:100%;
      background:var(--dark);
      border:1px solid var(--line);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
    }
    textarea{min-height:84px;resize:vertical}

    .noteItem{background:rgba(0,0,0,.35);border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
    .noteTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .noteText{margin-top:8px;white-space:pre-wrap;line-height:1.35}

    @media (max-width:1080px){
      .bases{grid-template-columns:1fr}
      .input{min-width:0;width:100%}
    }
  </style>
</head>

<body>
  <h1>Acompanhamento de Obras</h1>
  <div class="sub" id="subtitle">Carregando...</div>

  <!-- CALEND√ÅRIO -->
  <div class="calWrap">
    <div class="calCard">
      <div class="calHead">
        <div>
          <div class="calTitle" id="calTitle">Calend√°rio</div>
          <div class="calInfo" id="calInfo">Selecionado: -</div>
        </div>
        <div class="calBtns">
          <button class="btn btn-ghost" id="prevMonth">‚óÄ</button>
          <button class="btn btn-ghost" id="todayBtn">Hoje</button>
          <button class="btn btn-ghost" id="nextMonth">‚ñ∂</button>
        </div>
      </div>

      <div class="calGrid" id="calDow"></div>
      <div class="calGrid" id="calDays"></div>
    </div>
  </div>

  <div class="toolbar">
    <input class="input" id="q" placeholder="Buscar (nota, projeto, t√≠tulo)..." />
    <button class="btn btn-gray" id="toggleFilters">Mostrar filtros</button>
    <button class="btn btn-ghost" id="clearFilters">Limpar filtros</button>
    <button class="btn btn-gray" id="toggleCols">Mostrar mais colunas</button>
    <button class="btn btn-gray" id="exportCsv">Exportar CSV (tela)</button>
    <button class="btn btn-gray" id="waToday">WhatsApp (somente do dia)</button>
    <button class="btn btn-green" id="reload">Recarregar</button>
  </div>

  <div class="wrap">
    <div id="err" class="error"></div>

    <div id="filters" class="filters">
      <div class="calCard">
        <div class="row">
          <div class="meta"><b>Filtros</b> (selecionou ‚Üí atualiza)</div>
        </div>

        <div style="height:12px"></div>

        <div class="grid">
          <div>
            <div class="label">CRIT√âRIO</div>
            <select id="fCriterio"></select>
          </div>
          <div>
            <div class="label">MUNIC√çPIO</div>
            <select id="fMunicipio"></select>
          </div>
          <div>
            <div class="label">AGENTE RESPONS√ÅVEL (AR)</div>
            <select id="fAR"></select>
          </div>
          <div>
            <div class="label">BASE</div>
            <select id="fBase"></select>
          </div>
        </div>
      </div>
    </div>

    <div class="bases" id="bases"></div>

    <div class="footer">UTEP Nordeste ‚Ä¢ Supabase ‚Ä¢ Obras do dia por base (ou 5 pr√≥ximas) ‚Ä¢ Notas</div>
  </div>

  <!-- MODAL NOTAS -->
  <div id="modalBack" class="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <p class="modalTitle" id="modalTitle">Notas</p>
          <div class="meta" id="modalMeta"></div>
        </div>
        <button class="btn btn-gray" id="closeModal">Fechar</button>
      </div>

      <div style="height:10px"></div>

      <div class="grid" style="grid-template-columns:1fr 1fr 2fr;gap:10px">
        <div>
          <div class="label">Seu nome</div>
          <input id="noteAuthor" placeholder="Ex.: Jo√£o Silva"/>
        </div>
        <div>
          <div class="label">Status da execu√ß√£o</div>
          <select id="noteStatus">
            <option value="Executada">‚úÖ Executada</option>
            <option value="Houve problemas">‚ö†Ô∏è Houve problemas</option>
            <option value="N√£o foi executada">‚ùå N√£o foi executada</option>
          </select>
        </div>
        <div>
          <div class="label">Adicionar nota</div>
          <textarea id="noteText" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button class="btn btn-green" id="saveNote">Salvar nota</button>
      </div>

      <div style="height:10px"></div>
      <div id="notesList"></div>
    </div>
  </div>

<script>
/* ====== SUPABASE ====== */
const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UTIL ====== */
const $ = (id)=>document.getElementById(id);

function showErr(msg){ $("err").style.display="block"; $("err").textContent=String(msg); }
function clearErr(){ $("err").style.display="none"; $("err").textContent=""; }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function normKey(k){
  return String(k || "")
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/g, "");
}

function pick(obj, keys){
  for(const k of keys){
    if(obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
  }
  return "";
}

function pickLoose(obj, wanted){
  if(!obj) return "";
  const target = normKey(wanted);
  for (const k of Object.keys(obj)){
    if (normKey(k) === target){
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
  }
  return "";
}

function pickAnyLoose(obj, wantedList){
  for(const w of wantedList){
    const v = pickLoose(obj, w);
    if(v) return v;
  }
  return "";
}

function parseAnyDate(v){
  if(!v) return null;
  const s = String(v).trim();
  if(!s) return null;

  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(m){
    const [_, dd, mm, yyyy] = m;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd));
  }
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m2){
    const [_, yyyy, mm, dd] = m2;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd));
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function sameDay(a,b){
  return a && b &&
    a.getFullYear()===b.getFullYear() &&
    a.getMonth()===b.getMonth() &&
    a.getDate()===b.getDate();
}
function fmtBR(d){
  if(!d) return "-";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

/* ====== STATUS ====== */
function unpackStatus(texto){
  const s = String(texto ?? "");
  const m = s.match(/^\s*\[\[STATUS:(.+?)\]\]\s*\n?/);
  if(m){
    return { status: m[1].trim(), texto: s.replace(m[0], "").trim() };
  }
  return { status: "", texto: s };
}
function statusBadge(status){
  const st = (status||"").toLowerCase();
  if(st.includes("executada")) return `<span class="badge b-ok">‚úÖ Executada</span>`;
  if(st.includes("problema")) return `<span class="badge b-warn">‚ö†Ô∏è Problemas</span>`;
  if(st.includes("n√£o") || st.includes("nao")) return `<span class="badge b-bad">‚ùå N√£o executada</span>`;
  return `<span class="badge b-none">‚ÑπÔ∏è Sem status</span>`;
}

/* ====== BASES FIXAS (CORRIGIDO) ====== */
const BASES = ["Alagoinhas","Ribeira do Pombal","Paulo Afonso"];

/* ====== STATE ====== */
let ALL = [];
let FILTERS = { criterio:"", municipio:"", ar:"", base:"" };
let selectedDate = startOfDay(new Date());
let viewMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
let showMoreCols = false;

let LAST_STATUS_BY_NOTA = new Map();

let currentNota = null;
let currentMeta = null;

let CURRENT_TODAY_ALL_BASES = [];

/* ====== CALEND√ÅRIO ====== */
const DOW = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];

function renderCalendar(){
  $("calTitle").textContent = viewMonth.toLocaleDateString("pt-BR", { month:"long", year:"numeric" })
    .replace(/^./, c=>c.toUpperCase());
  $("calInfo").textContent = `Selecionado: ${fmtBR(selectedDate)}`;

  $("calDow").innerHTML = DOW.map(d=>`<div class="calDow">${d}</div>`).join("");

  const firstDay = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1);
  const startIdx = firstDay.getDay();
  const start = new Date(firstDay);
  start.setDate(start.getDate() - startIdx);

  const days = [];
  for(let i=0;i<42;i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i);

    const inMonth = d.getMonth() === viewMonth.getMonth();
    const isToday = sameDay(d, startOfDay(new Date()));
    const isSel = sameDay(d, selectedDate);

    days.push({ date:d, label:d.getDate(), inMonth, isToday, isSel });
  }

  $("calDays").innerHTML = days.map(x=>{
    const cls = [
      "day",
      x.inMonth ? "" : "muted",
      x.isToday ? "today" : "",
      x.isSel ? "sel" : ""
    ].filter(Boolean).join(" ");

    const click = x.inMonth ? `onclick="selectDay('${x.date.toISOString()}')"` : "";
    return `<div class="${cls}" ${click}>${x.label}</div>`;
  }).join("");
}

function selectDay(iso){
  const d = new Date(iso);
  selectedDate = startOfDay(d);
  renderCalendar();
  render();
}
window.selectDay = selectDay;

/* ====== DETECTA BASE ====== */
function normalizeBaseLabel(b){
  const s = String(b || "").trim();
  const nk = normKey(s);

  if(nk.includes("alagoinha")) return "Alagoinhas";
  if(nk.includes("ribeiradopombal") || (nk.includes("pombal") && nk.includes("ribeira"))) return "Ribeira do Pombal";
  if(nk.includes("pauloafonso") || (nk.includes("afonso") && nk.includes("paulo"))) return "Paulo Afonso";

  // tenta match exato
  for(const B of BASES){
    if(normKey(B) === nk) return B;
  }
  return s;
}

function inferBaseFromText(o){
  const blob = [
    o.baseRaw, o.municipio, o.localidade, o.titulo, o.projeto
  ].filter(Boolean).join(" ");
  const nk = normKey(blob);

  if(nk.includes("alagoinha")) return "Alagoinhas";
  if(nk.includes("ribeiradopombal") || (nk.includes("pombal") && nk.includes("ribeira"))) return "Ribeira do Pombal";
  if(nk.includes("pauloafonso") || (nk.includes("afonso") && nk.includes("paulo"))) return "Paulo Afonso";

  return "";
}

function getBaseFromRow(o){
  // tenta por nomes comuns de coluna
  const baseRaw =
    pick(o, ["BASE","base","Base"]) ||
    pickAnyLoose(o, ["base", "base_operacional", "baseoperacional", "base operacional", "regional", "regiao", "regi√£o", "polo", "p√≥lo", "subregional", "sub-regional", "sub regional"]) ||
    "";

  return baseRaw;
}

function normalizeObra(o){
  const nota = pick(o, ["nota","NOTA"]) || pickLoose(o, "nota");
  const titulo = pick(o, ["titulo","TITULO"]) || pickLoose(o, "titulo");

  const projeto =
    pick(o, ["projeto","PROJETO","Projeto","NOME_PROJETO","NOME DO PROJETO"]) ||
    pickLoose(o, "projeto") ||
    pickLoose(o, "nomeprojeto");

  const criterio = pick(o, ["criterio","CRITERIO","criterio_","CRITERIO_"]) || pickLoose(o, "criterio");
  const municipio = pick(o, ["municipio","MUNICIPIO"]) || pickLoose(o, "municipio");

  const ar =
    pick(o, ["agente_responsavel","AGENTE_RESPONSAVEL","AR","ar"]) ||
    pickLoose(o, "agenteresponsavel") ||
    pickLoose(o, "responsavel") ||
    "";

  const localidade = pick(o, ["localidade","LOCALIDADE"]) || pickLoose(o, "localidade");
  const gerencia = pick(o, ["gerencia","GERENCIA"]) || pickLoose(o, "gerencia");

  const fimRaw =
    pick(o, ["previsao_execucao_fim","PREVISAO_EXECUCAO_FIM"]) ||
    pickAnyLoose(o, ["previsaoexecucaofim","previsaofim","previsao_fim","prazo_final","prazofinal","fim"]) ||
    "";

  const dtFim = parseAnyDate(fimRaw);

  const baseRaw = getBaseFromRow(o);
  let base = normalizeBaseLabel(baseRaw);

  // se n√£o bateu nas 3 bases, tenta inferir pelo texto
  if(!BASES.includes(base)){
    const inferred = inferBaseFromText({ baseRaw, municipio, localidade, titulo, projeto });
    if(inferred) base = inferred;
  }

  return { raw:o, nota, projeto, titulo, criterio, municipio, ar, localidade, gerencia, dtFim, base, baseRaw };
}

function uniqSorted(arr){
  return Array.from(new Set(arr.filter(Boolean).map(x=>String(x).trim())))
    .sort((a,b)=>a.localeCompare(b,"pt-BR"));
}
function fillSelect(sel, values, allLabel){
  const cur = sel.value;
  sel.innerHTML = "";
  values.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v ? v : allLabel;
    sel.appendChild(opt);
  });
  if(values.includes(cur)) sel.value = cur;
}

function buildFilterOptions(){
  const norm = ALL.map(normalizeObra);

  fillSelect($("fCriterio"), ["", ...uniqSorted(norm.map(x=>x.criterio))], "Todos");
  fillSelect($("fMunicipio"), ["", ...uniqSorted(norm.map(x=>x.municipio))], "Todos");
  fillSelect($("fAR"), ["", ...uniqSorted(norm.map(x=>x.ar))], "Todos");
  fillSelect($("fBase"), ["", ...BASES], "Todas");
}

function applyFilters(list){
  return list.filter(x=>{
    if(FILTERS.criterio && String(x.criterio) !== FILTERS.criterio) return false;
    if(FILTERS.municipio && String(x.municipio) !== FILTERS.municipio) return false;
    if(FILTERS.ar && String(x.ar) !== FILTERS.ar) return false;
    if(FILTERS.base && String(x.base) !== FILTERS.base) return false;
    return true;
  });
}
function applySearch(list){
  const q = ($("q").value || "").trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>{
    const a = `${x.nota||""} ${x.projeto||""} ${x.titulo||""} ${x.base||""}`.toLowerCase();
    return a.includes(q);
  });
}

async function hydrateLastStatus(notas){
  LAST_STATUS_BY_NOTA = new Map();
  const unique = Array.from(new Set((notas||[]).filter(Boolean).map(String)));
  if(unique.length === 0) return;

  const slice = unique.slice(0, 400);
  const { data, error } = await sb
    .from("notes")
    .select("nota,texto,created_at")
    .in("nota", slice)
    .order("created_at", { ascending:false });

  if(error || !data) return;

  for(const n of data){
    const key = String(n.nota);
    if(!LAST_STATUS_BY_NOTA.has(key)){
      const parsed = unpackStatus(n.texto);
      LAST_STATUS_BY_NOTA.set(key, parsed.status || "");
    }
  }
}

/* ====== FETCH ====== */
async function fetchObras(){
  clearErr();
  $("subtitle").textContent = "Carregando obras...";
  $("bases").innerHTML = `<div class="empty">Carregando...</div>`;

  const { data, error } = await sb.from("obras").select("*").limit(5000);
  if(error){
    showErr("Erro ao carregar obras:\n" + JSON.stringify(error, null, 2));
    $("bases").innerHTML = "";
    $("subtitle").textContent = "Erro ao carregar.";
    return;
  }

  ALL = data || [];
  buildFilterOptions();
  render();
}

/* ====== RENDER POR BASE ====== */
async function render(){
  const day = startOfDay(selectedDate);

  let norm = applySearch(applyFilters(ALL.map(normalizeObra)));

  // se alguma obra ficou sem base, ela n√£o aparece. Mas agora a infer√™ncia cobre a maioria.
  const byBase = new Map();
  for(const B of BASES) byBase.set(B, []);
  for(const o of norm){
    if(BASES.includes(o.base)) byBase.get(o.base).push(o);
  }

  CURRENT_TODAY_ALL_BASES = [];
  const cardsToHydrate = [];

  const sections = [];

  for(const B of BASES){
    const arr = (byBase.get(B) || []).filter(x=>x.dtFim);

    const todayList = arr
      .filter(x => sameDay(startOfDay(x.dtFim), day))
      .sort((a,b)=>a.dtFim - b.dtFim);

    CURRENT_TODAY_ALL_BASES.push(...todayList);

    let shown = todayList;
    let label = `Do dia (${fmtBR(day)})`;

    if(shown.length === 0){
      const proximas = arr
        .filter(x => startOfDay(x.dtFim) >= day)
        .sort((a,b)=>a.dtFim - b.dtFim)
        .slice(0, 5);

      shown = proximas;
      label = `Sem obras no dia. Mostrando as 5 mais pr√≥ximas`;
    }

    cardsToHydrate.push(...shown.map(x=>x.nota));
    sections.push({ base: B, label, shown });
  }

  $("subtitle").innerHTML =
    `Selecionado: <b>${fmtBR(day)}</b> ‚Ä¢ Em cada base: obras do dia; se n√£o tiver, <b>5 mais pr√≥ximas</b>.<br/>
     <span class="meta">WhatsApp envia <b>somente</b> as obras do dia (todas as bases).</span>`;

  await hydrateLastStatus(cardsToHydrate);

  const moreClass = showMoreCols ? "moreOn" : "";

  $("bases").innerHTML = sections.map(sec=>{
    const list = sec.shown;

    const inner = (list.length === 0)
      ? `<div class="empty">Sem obras nessa base (com filtros/busca atuais).</div>`
      : list.map(o=>{
          const prazo = o.dtFim ? fmtBR(o.dtFim) : "-";
          const lastSt = LAST_STATUS_BY_NOTA.get(String(o.nota)) || "";
          return `
            <div class="card ${moreClass}">
              <div class="row">
                <div>
                  <div class="title">${escapeHtml(o.titulo || "(Sem t√≠tulo)")}</div>
                  <div class="meta">${escapeHtml(o.criterio || "")} ‚Ä¢ ${escapeHtml(o.municipio || "")}</div>
                </div>
                <div class="topRight">
                  ${statusBadge(lastSt)}
                  <button class="btn btn-gray" onclick="openNotes('${escapeHtml(String(o.nota))}')">Notas</button>
                </div>
              </div>

              <div class="kvs">
                <div class="kv"><b>NOTA</b><span>${escapeHtml(o.nota || "-")}</span></div>
                <div class="kv"><b>PROJETO</b><span>${escapeHtml(o.projeto || "-")}</span></div>
                <div class="kv"><b>PRAZO FINAL</b><span>${escapeHtml(prazo)}</span></div>
                <div class="kv"><b>AR</b><span>${escapeHtml(o.ar || "-")}</span></div>
              </div>

              <div class="kvs moreCols">
                <div class="kv"><b>LOCALIDADE</b><span>${escapeHtml(o.localidade || "-")}</span></div>
                <div class="kv"><b>GER√äNCIA</b><span>${escapeHtml(o.gerencia || "-")}</span></div>
              </div>
            </div>
          `;
        }).join("");

    return `
      <div class="baseCol">
        <div class="baseHead">
          <div>
            <div class="baseTitle">${escapeHtml(sec.base)}</div>
            <div class="baseMeta">${escapeHtml(sec.label)}</div>
          </div>
          <div class="baseMeta">Qtd: <b>${list.length}</b></div>
        </div>
        ${inner}
      </div>
    `;
  }).join("");
}

/* ====== WHATSAPP ====== */
function buildWhatsAppMessage(){
  const d = startOfDay(selectedDate);
  const dataStr = fmtBR(d);

  if(!CURRENT_TODAY_ALL_BASES || CURRENT_TODAY_ALL_BASES.length === 0){
    return `üìå Acompanhamento UTEP\n\nNenhuma obra com prazo final em *${dataStr}* (de acordo com filtros/busca).`;
  }

  const map = new Map();
  for(const B of BASES) map.set(B, []);
  for(const o of CURRENT_TODAY_ALL_BASES){
    const b = BASES.includes(o.base) ? o.base : "Outros";
    if(!map.has(b)) map.set(b, []);
    map.get(b).push(o);
  }

  let out = `üìå *Acompanhamento UTEP ‚Äî Obras do dia*\nüìÖ *${dataStr}*\n\n`;

  for(const B of BASES){
    const arr = (map.get(B) || []);
    if(arr.length === 0) continue;

    out += `*${B}* (${arr.length})\n`;
    arr.forEach((o, i)=>{
      const prazo = o.dtFim ? fmtBR(o.dtFim) : "-";
      out += `‚Ä¢ ${i+1}) Nota: ${o.nota || "-"} | Projeto: ${o.projeto || "-"}\n  T√≠tulo: ${o.titulo || "-"}\n  Munic√≠pio: ${o.municipio || "-"} | AR: ${o.ar || "-"} | Prazo: ${prazo}\n`;
    });
    out += "\n";
  }

  return out.trim();
}

function exportWhatsAppToday(){
  const msg = buildWhatsAppMessage();
  window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
}

/* ====== CSV ====== */
function exportCsv(){
  const d = startOfDay(selectedDate);
  let norm = applySearch(applyFilters(ALL.map(normalizeObra)));

  const rows = [];
  for(const B of BASES){
    const arr = norm.filter(x => x.base === B && x.dtFim);

    const todayList = arr
      .filter(x => sameDay(startOfDay(x.dtFim), d))
      .sort((a,b)=>a.dtFim - b.dtFim);

    let shown = todayList;
    if(shown.length === 0){
      shown = arr
        .filter(x => startOfDay(x.dtFim) >= d)
        .sort((a,b)=>a.dtFim - b.dtFim)
        .slice(0, 5);
    }

    for(const x of shown){
      rows.push({
        BASE: x.base || "",
        NOTA: x.nota || "",
        PROJETO: x.projeto || "",
        TITULO: x.titulo || "",
        CRITERIO: x.criterio || "",
        MUNICIPIO: x.municipio || "",
        AR: x.ar || "",
        PRAZO_FINAL: x.dtFim ? fmtBR(x.dtFim) : "",
        LOCALIDADE: x.localidade || "",
        GERENCIA: x.gerencia || ""
      });
    }
  }

  if(rows.length === 0){
    alert("Nada para exportar.");
    return;
  }

  const headers = Object.keys(rows[0]);
  const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
  const csv = [
    headers.join(";"),
    ...rows.map(r=>headers.map(h=>esc(r[h])).join(";"))
  ].join("\n");

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `acompanhamento_bases_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ====== NOTAS ====== */
async function openNotes(nota){
  currentNota = String(nota);

  $("modalBack").classList.add("on");
  $("notesList").innerHTML = `<div class="meta">Carregando notas...</div>`;
  $("noteText").value = "";

  const found = ALL.map(normalizeObra).find(x=>String(x.nota) === currentNota);
  currentMeta = found || null;

  $("modalTitle").textContent = `Notas - Nota ${currentNota}`;
  $("modalMeta").innerHTML = currentMeta
    ? `${escapeHtml(currentMeta.titulo || "")} ‚Ä¢ ${escapeHtml(currentMeta.municipio || "")} ‚Ä¢ ${escapeHtml(currentMeta.base || "")}`
    : "";

  await loadNotes();
}
function closeNotes(){
  $("modalBack").classList.remove("on");
  currentNota = null;
  currentMeta = null;
}

async function loadNotes(){
  if(!currentNota) return;

  const { data, error } = await sb
    .from("notes")
    .select("id,nota,autor,texto,created_at")
    .eq("nota", currentNota)
    .order("created_at", { ascending:false });

  if(error){
    $("notesList").innerHTML = `<div class="meta">Erro ao carregar notas:<br>${escapeHtml(JSON.stringify(error))}</div>`;
    return;
  }

  if(!data || data.length === 0){
    $("notesList").innerHTML = `<div class="meta">Sem notas ainda.</div>`;
    return;
  }

  $("notesList").innerHTML = data.map(n=>{
    const dt = n.created_at ? new Date(n.created_at).toLocaleString("pt-BR") : "-";
    const parsed = unpackStatus(n.texto);
    return `
      <div class="noteItem">
        <div class="noteTop">
          <div><b>${escapeHtml(n.autor || "(sem autor)")}</b></div>
          <div>${escapeHtml(dt)}</div>
        </div>
        <div style="margin-top:8px">${statusBadge(parsed.status)}</div>
        <div class="noteText">${escapeHtml(parsed.texto || "")}</div>
      </div>
    `;
  }).join("");
}

async function saveNote(){
  if(!currentNota) return;

  const autor = $("noteAuthor").value.trim();
  const texto = $("noteText").value.trim();
  const status = $("noteStatus").value;

  if(!autor || !texto){
    showErr("Preencha seu nome e a anota√ß√£o antes de salvar.");
    return;
  }
  clearErr();

  const textoFinal = `[[STATUS:${status}]]\n${texto}`;

  const { error } = await sb.from("notes").insert({
    nota: currentNota,
    autor,
    texto: textoFinal
  });

  if(error){
    showErr("Erro ao salvar nota:\n" + JSON.stringify(error, null, 2));
    return;
  }

  $("noteText").value = "";
  await loadNotes();
  await render();
}

/* ====== EVENTOS UI ====== */
$("toggleFilters").addEventListener("click", ()=>{
  const box = $("filters");
  box.classList.toggle("on");
  $("toggleFilters").textContent = box.classList.contains("on") ? "Ocultar filtros" : "Mostrar filtros";
});

$("clearFilters").addEventListener("click", ()=>{
  FILTERS = { criterio:"", municipio:"", ar:"", base:"" };
  $("fCriterio").value = "";
  $("fMunicipio").value = "";
  $("fAR").value = "";
  $("fBase").value = "";
  render();
});

$("toggleCols").addEventListener("click", ()=>{
  showMoreCols = !showMoreCols;
  $("toggleCols").textContent = showMoreCols ? "Ocultar colunas extras" : "Mostrar mais colunas";
  render();
});

$("reload").addEventListener("click", fetchObras);
$("exportCsv").addEventListener("click", exportCsv);
$("waToday").addEventListener("click", exportWhatsAppToday);

$("fCriterio").addEventListener("change", (e)=>{ FILTERS.criterio = e.target.value; render(); });
$("fMunicipio").addEventListener("change", (e)=>{ FILTERS.municipio = e.target.value; render(); });
$("fAR").addEventListener("change", (e)=>{ FILTERS.ar = e.target.value; render(); });
$("fBase").addEventListener("change", (e)=>{ FILTERS.base = e.target.value; render(); });

$("q").addEventListener("input", ()=>{
  window.clearTimeout(window.__tq);
  window.__tq = window.setTimeout(()=>render(), 150);
});

$("closeModal").addEventListener("click", closeNotes);
$("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeNotes(); });
$("saveNote").addEventListener("click", saveNote);

$("prevMonth").addEventListener("click", ()=>{
  viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth()-1, 1);
  renderCalendar();
});
$("nextMonth").addEventListener("click", ()=>{
  viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 1);
  renderCalendar();
});
$("todayBtn").addEventListener("click", ()=>{
  selectedDate = startOfDay(new Date());
  viewMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
  renderCalendar();
  render();
});

window.openNotes = openNotes;

/* INIT */
(function init(){
  $("bases").innerHTML = BASES.map(b=>`
    <div class="baseCol">
      <div class="baseHead">
        <div>
          <div class="baseTitle">${escapeHtml(b)}</div>
          <div class="baseMeta">Carregando...</div>
        </div>
      </div>
      <div class="empty">Aguardando dados...</div>
    </div>
  `).join("");

  renderCalendar();
  fetchObras();
})();
</script>

</body>
</html>