<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento de Obras</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#06110b; --bg1:#0a1a11;
      --card:rgba(255,255,255,.03);
      --line:rgba(255,255,255,.08);
      --text:#e9fff1; --muted:#b6d9c2;
      --accent:#2fbf71; --accent2:#1a8f52;
      --warn:#ffcc66; --bad:#ff6b6b;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 15% 10%, rgba(47,191,113,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(47,191,113,.12), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 40px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:6px 0 14px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{margin:0;font-size:30px;font-weight:900}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .rightTop{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .badge{
      font-family:var(--mono);
      background:rgba(47,191,113,.18);
      border:1px solid rgba(47,191,113,.35);
      padding:8px 10px;border-radius:999px;
      display:flex;gap:8px;align-items:center;
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      cursor:pointer;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      padding:10px 14px;font-weight:800;color:var(--text);
      background:rgba(255,255,255,.08); backdrop-filter: blur(8px);
    }
    .btnAccent{
      background:linear-gradient(180deg, rgba(47,191,113,.95), rgba(26,143,82,.95));
      border-color:rgba(47,191,113,.65);
      color:#06110b;
    }
    .btnGhost{background:transparent;border-color:rgba(47,191,113,.35)}
    .panel{
      margin-top:16px;background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .panelHead h2{margin:0;font-size:16px}
    .filters{
      padding:16px;display:grid;grid-template-columns: 1.2fr 1fr 1fr;
      gap:14px;
    }
    @media(max-width:900px){ .filters{grid-template-columns:1fr} }
    .field label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    .field input,.field select{
      width:100%;padding:11px 12px;border-radius:12px;outline:none;
      border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);
    }
    .hint{padding:0 16px 14px;color:var(--muted);font-size:13px}
    .err{
      margin:0 16px 16px;padding:14px;border-radius:14px;
      border:1px solid rgba(255,107,107,.38);background:rgba(255,107,107,.09);
      color:#ffd6d6;display:none;white-space:pre-wrap;
    }
    .detailsBox{
      margin:0 16px 16px;padding:12px;border-radius:16px;
      border:1px solid rgba(47,191,113,.18);background:rgba(47,191,113,.06);
      display:none;
    }
    .detailsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:800px){ .detailsGrid{grid-template-columns:1fr 1fr 1fr 1fr} }
    .chk{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.12);
      color:var(--muted);font-size:13px;
    }
    .gridBases{padding:16px;display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:980px){ .gridBases{grid-template-columns:1fr 1fr 1fr} }
    .baseCard{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;overflow:hidden;
    }
    .baseHead{
      padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(47,191,113,.10), rgba(0,0,0,0));
    }
    .baseHead .name{font-weight:900}
    .count{font-family:var(--mono);color:var(--muted);font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .items{padding:10px;display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      border-radius:16px;padding:12px;
    }
    .title{margin:0;font-weight:900;font-size:14px;line-height:1.25}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    .chipStrong{border-color:rgba(47,191,113,.35);background:rgba(47,191,113,.10);color:var(--text)}
    .meta{margin-top:10px;color:var(--muted);font-size:13px;display:grid;gap:8px}
    .metaRow{display:flex;gap:10px;flex-wrap:wrap}
    .metaRow b{color:var(--text)}
    .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .smallBtn{padding:9px 12px;border-radius:12px;font-weight:900}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{width:min(860px,100%);background:linear-gradient(180deg, rgba(15,34,23,.98), rgba(10,26,17,.98));
      border:1px solid rgba(255,255,255,.10);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .modalHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .modalHead h3{margin:0;font-size:16px}
    .modalHead .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .modalBody{padding:14px 16px}
    .modalGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .modalGrid{grid-template-columns:1.1fr .9fr} }
    .noteList{border:1px solid rgba(255,255,255,.08);border-radius:16px;background:rgba(0,0,0,.18);padding:10px;min-height:220px;max-height:360px;overflow:auto}
    .noteItem{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);margin-bottom:10px}
    .noteItem:last-child{margin-bottom:0}
    .noteTop{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .noteAuthor{font-weight:900}
    .noteDate{color:var(--muted);font-family:var(--mono);font-size:12px}
    .noteTxt{margin-top:8px;white-space:pre-wrap}
    textarea{width:100%;min-height:120px;resize:vertical;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);outline:none}
    .modalActions{padding:14px 16px;border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .miniErr{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,107,107,.38);background:rgba(255,107,107,.09);color:#ffd6d6;display:none;white-space:pre-wrap;font-size:13px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Acompanhamento de Obras</h1>
        <div class="sub">UTEP Nordeste ‚Ä¢ Supabase + GitHub Pages</div>
      </div>
      <div class="rightTop">
        <div class="badge"><span>üìÖ</span><span id="todayLabel">--/--/----</span></div>
        <div class="btnRow">
          <button id="btnReload">Recarregar</button>
        </div>
      </div>
    </header>

    <section class="panel">
      <div class="panelHead">
        <h2>Filtros</h2>
        <div class="btnRow">
          <button class="btnGhost" id="btnToggleDetails">+ Detalhes</button>
          <button class="btnAccent" id="btnWhats">Exportar WhatsApp (dia)</button>
        </div>
      </div>

      <div class="filters">
        <div class="field">
          <label>Data (prazo final)</label>
          <input id="datePick" type="date" />
        </div>

        <div class="field">
          <label>Base</label>
          <select id="basePick">
            <option value="todas">Todas</option>
            <option value="alagoinhas">Alagoinhas</option>
            <option value="ribeira do pombal">Ribeira do Pombal</option>
            <option value="paulo afonso">Paulo Afonso</option>
          </select>
        </div>

        <div class="field">
          <label>Munic√≠pio</label>
          <select id="munPick">
            <option value="todos">Todos</option>
          </select>
        </div>
      </div>

      <div class="detailsBox" id="detailsBox">
        <div class="hint" style="padding:0 0 10px;margin:0">
          Marque colunas extras para mostrar (as principais ficam fixas).
        </div>
        <div class="detailsGrid" id="detailsGrid"></div>
      </div>

      <div class="hint">
        <b>Regras:</b> mostra obras com <b>prazo_final</b> na data escolhida. Se n√£o houver, mostra as <b>5 mais pr√≥ximas dentro de 5 dias</b> (por base).
      </div>

      <div class="err" id="errBox"></div>
      <div class="gridBases" id="basesGrid"></div>
    </section>
  </div>

  <!-- Modal Notas -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">Notas</h3>
          <div class="sub" id="modalSub">‚Äî</div>
        </div>
        <button class="smallBtn" id="btnCloseModal">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <div>
            <div class="noteList" id="noteList"></div>
          </div>

          <div>
            <div class="field" style="margin-bottom:10px">
              <label>Seu nome</label>
              <input id="inpAuthor" placeholder="Ex.: Jo√£o Silva" />
            </div>

            <div class="field" style="margin-bottom:10px">
              <label>Status da execu√ß√£o</label>
              <select id="selStatus">
                <option value="executada">Executada</option>
                <option value="problemas">Houve problemas</option>
                <option value="nao_executada">N√£o foi executada</option>
              </select>
            </div>

            <div class="field">
              <label>Adicionar nota</label>
              <textarea id="txtNote" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
            </div>

            <div class="miniErr" id="miniErr"></div>
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btnGhost" id="btnRefreshNotes">Atualizar notas</button>
        <button class="btnAccent" id="btnSaveNote">Salvar nota</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG (SUAS CHAVES)
     ***********************/
    const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co";
    const SUPABASE_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx";

    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Tabelas
    const TABLE_OBRAS = "obras";
    const TABLE_NOTES = "notes";

    // Colunas (min√∫sculas)
    const COL_NOTA = "nota";
    const COL_PROJETO = "projeto";
    const COL_BASE = "base_oper_prog";
    const COL_MUNICIPIO = "municipio";
    const COL_PRAZO = "prazo_final";          // ‚úÖ AGORA USA A COLUNA DATE
    const COL_PRAZO_TEXTO = "previsao_execucao_fim"; // s√≥ para exibir se quiser

    // Notes (min√∫sculas)
    const NOTE_COL_NOTA = "nota";
    const NOTE_COL_AUTHOR = "author";
    const NOTE_COL_NOTE = "note";
    const NOTE_COL_STATUS = "status_execucao";
    const NOTE_COL_CREATED = "created_at";

    /***********************
     * UI refs
     ***********************/
    const todayLabel = document.getElementById("todayLabel");
    const datePick = document.getElementById("datePick");
    const basePick = document.getElementById("basePick");
    const munPick = document.getElementById("munPick");
    const btnReload = document.getElementById("btnReload");
    const btnWhats = document.getElementById("btnWhats");
    const errBox = document.getElementById("errBox");
    const basesGrid = document.getElementById("basesGrid");
    const btnToggleDetails = document.getElementById("btnToggleDetails");
    const detailsBox = document.getElementById("detailsBox");
    const detailsGrid = document.getElementById("detailsGrid");

    // Modal
    const overlay = document.getElementById("overlay");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const noteList = document.getElementById("noteList");
    const inpAuthor = document.getElementById("inpAuthor");
    const selStatus = document.getElementById("selStatus");
    const txtNote = document.getElementById("txtNote");
    const btnSaveNote = document.getElementById("btnSaveNote");
    const btnRefreshNotes = document.getElementById("btnRefreshNotes");
    const miniErr = document.getElementById("miniErr");

    /***********************
     * Helpers
     ***********************/
    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymdFromDate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function brFromISO(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if(isNaN(d.getTime())) return String(iso);
      return pad2(d.getDate())+"/"+pad2(d.getMonth()+1)+"/"+d.getFullYear();
    }
    function timeBR(iso){
      const d = new Date(iso);
      if(isNaN(d.getTime())) return "";
      return brFromISO(d)+" "+pad2(d.getHours())+":"+pad2(d.getMinutes());
    }
    function norm(v){ return String(v ?? "").trim().toLowerCase(); }
    function showErr(msg){ errBox.style.display="block"; errBox.textContent=msg; }
    function hideErr(){ errBox.style.display="none"; errBox.textContent=""; }
    function showMiniErr(msg){ miniErr.style.display="block"; miniErr.textContent=msg; }
    function hideMiniErr(){ miniErr.style.display="none"; miniErr.textContent=""; }
    function safeGet(row, col){ return row?.[col] ?? ""; }

    function baseOf(row){
      return String(safeGet(row, COL_BASE) || "").trim() || "‚Äî";
    }

    function getPrazoYMD(row){
      // agora √© DATE no banco; pode vir "YYYY-MM-DD" ou timestamp
      const v = safeGet(row, COL_PRAZO);
      if(!v) return "";
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
      const d = new Date(s);
      if(!isNaN(d.getTime())) return ymdFromDate(d);
      return "";
    }

    function withinDays(dateStr, startStr, days){
      const a = new Date(startStr+"T00:00:00");
      const b = new Date(dateStr+"T00:00:00");
      const diff = Math.round((b - a) / (1000*60*60*24));
      return diff >= 0 && diff <= days;
    }

    function statusChip(status){
      const s = norm(status);
      if(s==="executada") return '<span class="chip chipStrong">‚úÖ Executada</span>';
      if(s==="problemas") return '<span class="chip" style="border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.10);color:#ffe6b5">‚ö†Ô∏è Problemas</span>';
      if(s==="nao_executada") return '<span class="chip" style="border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.10);color:#ffd6d6">‚ùå N√£o executada</span>';
      return '<span class="chip">‚Äî</span>';
    }

    /***********************
     * Extras
     ***********************/
    const EXTRA_COLUMNS = [
      { key: "base_oper_prog", label: "base_oper_prog" },
      { key: "criterio", label: "crit√©rio" },
      { key: "gerencia", label: "ger√™ncia" },
      { key: "localidade", label: "localidade" },
      { key: "status", label: "status" },
      { key: "status_si", label: "status_si" },
    ];
    const extraOn = new Set(["criterio"]);

    function renderExtraToggles(){
      detailsGrid.innerHTML = "";
      EXTRA_COLUMNS.forEach(c=>{
        const div = document.createElement("label");
        div.className = "chk";
        div.innerHTML = `<input type="checkbox" ${extraOn.has(c.key) ? "checked":""} />
                         <span>${c.label}</span>`;
        div.querySelector("input").addEventListener("change",(e)=>{
          if(e.target.checked) extraOn.add(c.key); else extraOn.delete(c.key);
          renderAll();
        });
        detailsGrid.appendChild(div);
      });
    }

    /***********************
     * Data
     ***********************/
    let allRows = [];
    let currentNota = null;

    const BASES_ORDER = ["Alagoinhas", "Ribeira do Pombal", "Paulo Afonso"];

    async function loadObras(){
      hideErr();
      basesGrid.innerHTML = "";

      // pega tudo
      const { data, error } = await sb.from(TABLE_OBRAS).select("*");

      if(error){
        showErr(
          "Erro ao carregar 'obras': " + error.message + "\n\n" +
          "Checar:\n- Policy SELECT para anon em obras\n- coluna 'prazo_final' existe\n- dados importados"
        );
        allRows = [];
        return;
      }

      allRows = Array.isArray(data) ? data : [];
      buildMunicipiosOptions();
      renderAll();
    }

    function buildMunicipiosOptions(){
      const set = new Set();
      allRows.forEach(r=>{
        const m = safeGet(r, COL_MUNICIPIO);
        if(m) set.add(String(m).trim());
      });
      const arr = Array.from(set).sort((a,b)=>a.localeCompare(b,"pt-BR"));
      munPick.innerHTML = `<option value="todos">Todos</option>` + arr.map(m=>`<option value="${m}">${m}</option>`).join("");
    }

    function filterBase(row){
      const pick = basePick.value;
      if(pick==="todas") return true;
      return norm(baseOf(row)) === pick;
    }
    function filterMunicipio(row){
      const pick = munPick.value;
      if(pick==="todos") return true;
      return String(safeGet(row, COL_MUNICIPIO) || "").trim() === pick;
    }

    function pickDayRows(){
      const target = datePick.value;
      const candidates = allRows.filter(r => filterBase(r) && filterMunicipio(r));

      const sameDay = candidates.filter(r => getPrazoYMD(r) === target);
      if(sameDay.length > 0){
        return sameDay.sort((a,b)=> String(safeGet(a,COL_NOTA)).localeCompare(String(safeGet(b,COL_NOTA)),"pt-BR"));
      }

      const next = candidates
        .filter(r => {
          const d = getPrazoYMD(r);
          if(!d) return false;
          return withinDays(d, target, 5);
        })
        .sort((a,b)=>{
          const da = getPrazoYMD(a), db = getPrazoYMD(b);
          if(da !== db) return da.localeCompare(db);
          return String(safeGet(a,COL_NOTA)).localeCompare(String(safeGet(b,COL_NOTA)),"pt-BR");
        });

      return next; // por base a gente corta 5
    }

    function splitByBase(rows){
      const map = new Map();
      BASES_ORDER.forEach(b=>map.set(b, []));
      map.set("Outros", []);
      rows.forEach(r=>{
        const b = baseOf(r);
        const key = BASES_ORDER.find(x => norm(x) === norm(b)) || "Outros";
        map.get(key).push(r);
      });
      return map;
    }

    function renderAll(){
      const rows = pickDayRows();
      const map = splitByBase(rows);
      basesGrid.innerHTML = "";

      // se hoje tem obras, n√£o limita tanto; se n√£o tem, mostra 5 por base
      const hasSameDay = allRows
        .filter(r => filterBase(r) && filterMunicipio(r))
        .some(r => getPrazoYMD(r) === datePick.value);

      BASES_ORDER.forEach(baseName=>{
        const list = map.get(baseName) || [];
        const displayList = hasSameDay ? list.slice(0, 25) : list.slice(0, 5);

        const card = document.createElement("div");
        card.className = "baseCard";
        card.innerHTML = `
          <div class="baseHead">
            <div class="name">${baseName}</div>
            <div class="count">${displayList.length} obra(s)</div>
          </div>
          <div class="items"></div>
        `;
        const holder = card.querySelector(".items");

        if(displayList.length === 0){
          const empty = document.createElement("div");
          empty.className = "item";
          empty.innerHTML = `<div style="color:var(--muted)">Sem obras nesta base (dia/5 dias).</div>`;
          holder.appendChild(empty);
        }else{
          displayList.forEach(r => holder.appendChild(renderItem(r)));
        }

        basesGrid.appendChild(card);
      });
    }

    function renderItem(r){
      const nota = safeGet(r, COL_NOTA);
      const projeto = safeGet(r, COL_PROJETO);
      const municipio = safeGet(r, COL_MUNICIPIO);
      const prazo = safeGet(r, COL_PRAZO);
      const base = baseOf(r);

      const chips = [
        `<span class="chip chipStrong">üìå Nota: ${nota || "‚Äî"}</span>`,
        `<span class="chip">üß© Projeto: ${projeto || "‚Äî"}</span>`,
        `<span class="chip">üìç ${municipio || "‚Äî"}</span>`,
        `<span class="chip">üè∑Ô∏è Base: ${base || "‚Äî"}</span>`,
        `<span class="chip">üóìÔ∏è Prazo: ${brFromISO(prazo)}</span>`
      ];

      const extras = [];
      EXTRA_COLUMNS.forEach(c=>{
        if(!extraOn.has(c.key)) return;
        const v = r[c.key];
        if(v === undefined || v === null || String(v).trim()==="") return;
        extras.push(`<div class="metaRow"><b>${c.label}:</b> <span>${String(v)}</span></div>`);
      });

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <p class="title">${projeto || "Obra"} <span style="color:var(--muted);font-weight:700">‚Ä¢ ${municipio || "‚Äî"}</span></p>
        <div class="chips">${chips.join("")}</div>
        ${extras.length ? `<div class="meta">${extras.join("")}</div>` : ``}
        <div class="actions">
          <button class="smallBtn btnGhost">Anota√ß√µes</button>
        </div>
      `;
      el.querySelector("button").addEventListener("click", ()=>{
        openNotesModal({
          nota, base, municipio, projeto, prazo
        });
      });
      return el;
    }

    /***********************
     * WhatsApp (somente do dia)
     ***********************/
    function buildWhatsText(){
      const target = datePick.value;

      const dayRows = allRows
        .filter(r => filterBase(r) && filterMunicipio(r))
        .filter(r => getPrazoYMD(r) === target);

      if(dayRows.length === 0){
        return `üìå Obras do dia (${brFromISO(target)}):\n\nNenhuma obra com prazo final hoje.`;
      }

      const map = splitByBase(dayRows);
      let out = `üìå Obras do dia (${brFromISO(target)})\n`;

      BASES_ORDER.forEach(baseName=>{
        const list = map.get(baseName) || [];
        out += `\nüè∑Ô∏è ${baseName} (${list.length})\n`;
        if(list.length === 0){ out += `- (sem obras)\n`; return; }
        list.forEach(r=>{
          const nota = safeGet(r, COL_NOTA);
          const proj = safeGet(r, COL_PROJETO);
          const mun = safeGet(r, COL_MUNICIPIO);
          out += `- Nota ${nota}${proj ? " ‚Ä¢ "+proj : ""} ‚Ä¢ ${mun || "‚Äî"}\n`;
        });
      });

      return out.trim();
    }

    function openWhats(){
      const text = buildWhatsText();
      window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
    }

    /***********************
     * Notes modal
     ***********************/
    function openNotesModal(ctx){
      currentNota = ctx.nota;
      hideMiniErr();
      txtNote.value = "";
      modalTitle.textContent = `Notas ‚Ä¢ Nota ${ctx.nota || "‚Äî"}`;
      modalSub.textContent = `${ctx.base || "‚Äî"} ‚Ä¢ ${ctx.municipio || "‚Äî"} ‚Ä¢ Prazo: ${brFromISO(ctx.prazo)}`;
      overlay.style.display = "flex";
      loadNotesForNota(currentNota);
    }

    function closeNotesModal(){
      overlay.style.display = "none";
      currentNota = null;
      noteList.innerHTML = "";
      hideMiniErr();
    }

    async function loadNotesForNota(nota){
      noteList.innerHTML = `<div style="color:var(--muted)">Carregando...</div>`;
      const { data, error } = await sb
        .from(TABLE_NOTES)
        .select(`${NOTE_COL_AUTHOR},${NOTE_COL_NOTE},${NOTE_COL_STATUS},${NOTE_COL_CREATED}`)
        .eq(NOTE_COL_NOTA, nota)
        .order(NOTE_COL_CREATED, { ascending: false });

      if(error){
        noteList.innerHTML = `<div style="color:#ffd6d6">Erro ao carregar notas: ${error.message}</div>`;
        return;
      }

      const rows = Array.isArray(data) ? data : [];
      if(rows.length === 0){
        noteList.innerHTML = `<div style="color:var(--muted)">Ainda n√£o h√° anota√ß√µes para esta nota.</div>`;
        return;
      }

      noteList.innerHTML = rows.map(r=>`
        <div class="noteItem">
          <div class="noteTop">
            <div class="noteAuthor">${r[NOTE_COL_AUTHOR] || "‚Äî"}</div>
            <div class="noteDate">${timeBR(r[NOTE_COL_CREATED])}</div>
          </div>
          <div class="noteTxt">${(r[NOTE_COL_NOTE] || "").replace(/</g,"&lt;")}</div>
          <div style="margin-top:8px">${statusChip(r[NOTE_COL_STATUS])}</div>
        </div>
      `).join("");
    }

    async function saveNote(){
      hideMiniErr();
      if(!currentNota){ showMiniErr("Sem nota selecionada."); return; }
      const author = inpAuthor.value.trim();
      const note = txtNote.value.trim();
      const status = selStatus.value;
      if(!author){ showMiniErr("Digite seu nome."); return; }
      if(!note){ showMiniErr("Digite a anota√ß√£o."); return; }

      const payload = {
        [NOTE_COL_NOTA]: currentNota,
        [NOTE_COL_AUTHOR]: author,
        [NOTE_COL_NOTE]: note,
        [NOTE_COL_STATUS]: status
      };

      const { error } = await sb.from(TABLE_NOTES).insert(payload);
      if(error){ showMiniErr("Erro ao salvar: " + error.message); return; }

      txtNote.value = "";
      await loadNotesForNota(currentNota);
    }

    /***********************
     * Events + init
     ***********************/
    btnReload.addEventListener("click", loadObras);
    btnWhats.addEventListener("click", openWhats);
    btnToggleDetails.addEventListener("click", ()=>{
      const open = detailsBox.style.display === "block";
      detailsBox.style.display = open ? "none" : "block";
      btnToggleDetails.textContent = open ? "+ Detalhes" : "‚àí Detalhes";
    });

    basePick.addEventListener("change", renderAll);
    munPick.addEventListener("change", renderAll);
    datePick.addEventListener("change", renderAll);

    btnCloseModal.addEventListener("click", closeNotesModal);
    overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeNotesModal(); });
    btnSaveNote.addEventListener("click", saveNote);
    btnRefreshNotes.addEventListener("click", ()=> currentNota && loadNotesForNota(currentNota));

    (function init(){
      const now = new Date();
      todayLabel.textContent = pad2(now.getDate())+"/"+pad2(now.getMonth()+1)+"/"+now.getFullYear();
      datePick.value = ymdFromDate(now);
      renderExtraToggles();
      loadObras();
    })();
  </script>
</body>
</html>
