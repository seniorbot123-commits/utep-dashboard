<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acompanhamento de Obras</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#0f172a;
      color:#fff;
      margin:0;
      padding:16px;
    }

    h1{ text-align:center; }

    .toolbar{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-bottom:20px;
    }

    .btn{
      background:#22c55e;
      border:none;
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
    }

    .card{
      background:#111b2e;
      border:1px solid #334155;
      border-radius:14px;
      padding:16px;
      margin-bottom:16px;
    }

    .meta{ color:#94a3b8; font-size:14px; }

    input, textarea{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid #334155;
      background:#020617;
      color:#fff;
    }

    textarea{ min-height:70px; }

    .notaBox{ margin-top:12px; }

    .notaTop{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      color:#94a3b8;
    }

    .error{
      background:#7f1d1d;
      padding:10px;
      border-radius:10px;
      margin-bottom:12px;
      display:none;
      white-space:pre-wrap;
    }

    .footer{
      text-align:center;
      margin-top:30px;
      color:#94a3b8;
      font-size:13px;
    }
  </style>
</head>

<body>

<h1>Acompanhamento de Obras</h1>

<div class="toolbar">
  <button class="btn" id="reload">Recarregar</button>
</div>

<div id="err" class="error"></div>
<div id="lista"></div>

<div class="footer">
  UTEP Nordeste • Supabase + GitHub Pages
</div>

<script>
const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function showErr(msg){
  const el=document.getElementById("err");
  el.style.display="block";
  el.textContent=String(msg);
}

function clearErr(){
  const el=document.getElementById("err");
  el.style.display="none";
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

async function carregarObras(){
  clearErr();

  const lista=document.getElementById("lista");
  lista.innerHTML="Carregando obras...";

  const { data, error } = await sb
    .from("obras")
    .select("*")
    .limit(2000);

  if(error){
    showErr("Erro ao carregar obras:\n" + JSON.stringify(error, null, 2));
    lista.innerHTML="";
    return;
  }

  if(!data.length){
    lista.innerHTML="Nenhuma obra encontrada.";
    return;
  }

  lista.innerHTML="";

  for(const obra of data){

    const nota = obra.nota || obra.NOTA || "-";
    const projeto = obra.projeto || obra.PROJETO || "-";
    const titulo = obra.titulo || obra.TITULO || "-";

    const div=document.createElement("div");
    div.className="card";

    div.innerHTML=`
      <div><b>Nota:</b> ${escapeHtml(nota)}</div>
      <div><b>Projeto:</b> ${escapeHtml(projeto)}</div>
      <div class="meta"><b>Título:</b> ${escapeHtml(titulo)}</div>

      <br>

      <label>Seu nome</label>
      <input id="nome-${nota}" placeholder="Ex: João Silva">

      <br><br>

      <label>Adicionar anotação</label>
      <textarea id="texto-${nota}" placeholder="Escreva a observação..."></textarea>

      <br>
      <button class="btn" onclick="salvarNota('${nota}')">Salvar nota</button>

      <div id="notas-${nota}" class="notaBox">
        Carregando notas...
      </div>
    `;

    lista.appendChild(div);

    if(nota !== "-") carregarNotas(nota);
  }
}

async function carregarNotas(nota){
  const box=document.getElementById(`notas-${nota}`);
  if(!box) return;

  const { data, error } = await sb
    .from("notes")
    .select("*")
    .eq("nota", String(nota))
    .order("created_at",{ascending:false});

  if(error){
    box.innerHTML="Erro ao carregar notas.";
    return;
  }

  if(!data.length){
    box.innerHTML="Sem notas ainda.";
    return;
  }

  box.innerHTML=data.map(n=>{
    const dt = new Date(n.created_at).toLocaleString("pt-BR");

    return `
      <div class="card" style="background:#020617">
        <div class="notaTop">
          <b>${escapeHtml(n.autor)}</b>
          <span>${dt}</span>
        </div>
        <div style="margin-top:6px">${escapeHtml(n.texto)}</div>
      </div>
    `;
  }).join("");
}

async function salvarNota(nota){
  clearErr();

  const autor=document.getElementById(`nome-${nota}`).value.trim();
  const texto=document.getElementById(`texto-${nota}`).value.trim();

  if(!autor || !texto){
    showErr("Preencha nome e anotação.");
    return;
  }

  const { error } = await sb
    .from("notes")
    .insert({ nota:String(nota), autor, texto });

  if(error){
    showErr("Erro ao salvar nota:\n" + JSON.stringify(error,null,2));
    return;
  }

  document.getElementById(`texto-${nota}`).value="";
  carregarNotas(nota);
}

document.getElementById("reload").onclick = carregarObras;

carregarObras();
</script>

</body>
</html>
