<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento de Obras</title>

  <style>
    :root{
      --bg:#071a13;
      --bg2:#0c2a20;
      --card:#0e2f24;
      --card2:#10382b;
      --text:#e8fff4;
      --muted:#b9e6d2;
      --line:rgba(232,255,244,.12);
      --accent:#7CFCB8;     /* verde cana */
      --accent2:#3ddc97;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 50% -10%, rgba(124,252,184,.20), transparent 55%),
                  radial-gradient(900px 700px at 100% 20%, rgba(61,220,151,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg), #04110c 70%);
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }
    header{
      max-width:1200px;
      margin:0 auto 14px auto;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .title h1{margin:0;font-size:34px;letter-spacing:.2px}
    .title .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .rightTop{
      display:flex;flex-direction:column;gap:10px;align-items:flex-end;
      min-width:210px;
    }
    .badgeRow{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(124,252,184,.12);
      border:1px solid rgba(124,252,184,.22);
      color:var(--text);
      padding:8px 12px;border-radius:999px;font-size:13px;
    }
    .btn{
      border:0;cursor:pointer;
      padding:10px 14px;border-radius:12px;
      background:linear-gradient(180deg, rgba(124,252,184,.22), rgba(61,220,151,.16));
      border:1px solid rgba(124,252,184,.26);
      color:var(--text);
      box-shadow:var(--shadow);
      transition:.15s transform ease, .15s opacity ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .wrap{
      max-width:1200px;margin:0 auto;
      display:grid;gap:14px;
    }
    .panel{
      background:linear-gradient(180deg, rgba(16,56,43,.72), rgba(10,34,26,.66));
      border:1px solid rgba(232,255,244,.12);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      display:flex;flex-wrap:wrap;gap:12px;
      align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      padding:9px 12px;border-radius:12px;
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(124,252,184,.35);
      background:rgba(124,252,184,.14);
    }
    .filters{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{color:var(--muted);font-size:13px}
    input, select{
      width:100%;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(232,255,244,.14);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    input[type="date"]{color-scheme:dark}
    .rule{
      padding:0 16px 14px 16px;
      color:var(--muted);
      font-size:13px;
    }
    .error{
      margin:0 16px 16px 16px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      color:#ffeaea;
      white-space:pre-wrap;
      font-family:var(--mono);
      font-size:12px;
    }
    .gridBases{
      padding:14px 16px 18px 16px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .baseBlock{
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .baseHead{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid var(--line);
      background:rgba(124,252,184,.08);
    }
    .baseHead .name{font-weight:700}
    .baseHead .count{color:var(--muted);font-size:13px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(232,255,244,.10);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      background:rgba(0,0,0,.10);
      position:sticky; top:0;
      z-index:1;
    }
    tr:hover td{background:rgba(124,252,184,.06)}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:rgba(124,252,184,.12);
      border:1px solid rgba(124,252,184,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.warn{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.25)}
    .tag.danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.25)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .linkBtn{
      cursor:pointer;
      padding:8px 10px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      font-size:12px;
    }
    .footer{
      max-width:1200px;margin:16px auto 0 auto;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(700px, 100%);
      background:linear-gradient(180deg, rgba(16,56,43,.92), rgba(10,34,26,.92));
      border:1px solid rgba(232,255,244,.14);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .modalHead h3{margin:0;font-size:16px}
    .modalBody{padding:14px}
    .modalGrid{
      display:grid;grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .modalGrid .field:last-child{grid-column:1/-1}
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(232,255,244,.14);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-family:var(--sans);
    }
    .notesList{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .noteItem{
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }
    .noteMeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .noteMeta .who{font-weight:700}
    .noteMeta .when{color:var(--muted);font-size:12px}
    .noteText{margin-top:8px;color:var(--text);white-space:pre-wrap}
    .modalFoot{
      display:flex;gap:10px;justify-content:flex-end;
      padding:12px 14px;border-top:1px solid var(--line);
    }

    @media (max-width:900px){
      .filters{grid-template-columns:1fr}
      .modalGrid{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start}
      .rightTop{align-items:flex-start}
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Acompanhamento de Obras</h1>
      <div class="sub">UTEP Nordeste ‚Ä¢ Supabase + GitHub Pages</div>
    </div>

    <div class="rightTop">
      <div class="badgeRow">
        <div class="pill" id="todayPill">Data: --/--/----</div>
        <div class="pill">Vers√£o: VFinal</div>
      </div>
      <button class="btn secondary" id="btnReload">Recarregar</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="panelHead">
        <div class="tabs">
          <div class="tab active" id="tabFiltros">Filtros</div>
          <div class="tab" id="tabDetalhes">+ Detalhes</div>
          <button class="btn" id="btnWhats">Exportar WhatsApp (dia)</button>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btnHoje">Hoje</button>
        </div>
      </div>

      <div class="filters">
        <div class="field">
          <label>Data (prazo final)</label>
          <input type="date" id="fData" />
        </div>

        <div class="field">
          <label>Base</label>
          <select id="fBase">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="field">
          <label>Munic√≠pio</label>
          <select id="fMunicipio">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Crit√©rio</label>
          <select id="fCriterio">
            <option value="">Todos</option>
          </select>
        </div>
      </div>

      <div class="rule" id="ruleText">
        Regras: mostra obras com <b>prazo final</b> na data escolhida. Se n√£o houver, mostra as <b>5 mais pr√≥ximas dentro de 5 dias</b>, separadas por Base.
      </div>

      <div id="errBox" class="error" style="display:none"></div>

      <div class="gridBases" id="gridBases"></div>
    </div>

    <div class="footer">
      UTEP Nordeste ‚Ä¢ Atualiza automaticamente quando voc√™ fizer commit no GitHub Pages.
    </div>
  </div>

  <!-- Modal notas -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">Notas</h3>
          <div class="muted" id="modalSub"></div>
        </div>
        <button class="linkBtn" id="btnClose">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <div class="field">
            <label>Seu nome</label>
            <input id="nAutor" placeholder="Ex.: Jo√£o Silva" />
          </div>

          <div class="field">
            <label>Status</label>
            <select id="nStatus">
              <option value="executada">Executada</option>
              <option value="problemas">Houve problemas</option>
              <option value="nao_executada">N√£o foi executada</option>
            </select>
          </div>

          <div class="field">
            <label>Adicionar nota</label>
            <textarea id="nTexto" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btnSalvarNota">Salvar nota</button>
          <button class="btn secondary" id="btnRecarregarNotas">Recarregar notas</button>
        </div>

        <div class="notesList" id="notesList">
          <div class="muted">Carregando notas‚Ä¶</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn secondary" id="btnClose2">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======= CONFIG (suas credenciais) =======
    const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co".trim();
    const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx".trim();

    // ======= APP =======
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // nomes de coluna (auto-detect)
    let COL_BASE = "base_oper_prog";      // fallback
    let COL_PRAZO = "PREVISAO_EXECUCAO_FIM";
    let COL_NOTA  = "nota";               // tudo min√∫sculo (seu caso)
    let COL_MUN   = "municipio";
    let COL_CRIT  = "criterio";
    let COL_PROJ  = "projeto";

    // toggles de colunas extras
    let showExtras = false;

    // estado
    let allRows = [];
    let bases = [];
    let municipios = [];
    let criterios = [];

    // modal state
    let currentObra = null; // row
    let currentNotaKey = null; // string

    // helpers
    const $ = (id) => document.getElementById(id);

    function fmtDateBR(iso){
      if(!iso) return "";
      // iso pode vir "2026-02-13" ou timestamp
      const d = new Date(iso);
      if(String(d) === "Invalid Date"){
        // tenta yyyy-mm-dd puro
        const parts = String(iso).slice(0,10).split("-");
        if(parts.length===3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return String(iso);
      }
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    function fmtDateInput(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    function normalizeNota(v){
      if(v === null || v === undefined) return "";
      let s = String(v).trim();
      // remove .0 no final
      s = s.replace(/\.0$/,"");
      return s;
    }

    function showError(msg){
      const box = $("errBox");
      box.style.display = "block";
      box.textContent = msg;
    }
    function clearError(){
      const box = $("errBox");
      box.style.display = "none";
      box.textContent = "";
    }

    async function detectColumns(){
      // tenta descobrir se BASE_OPER_PROG veio mai√∫sculo (raro) ou min√∫sculo
      // e se projeto existe mesmo
      // estrat√©gia: faz select com head (limit 1) e captura erro 42703
      const tests = [
        { key:"COL_BASE", candidates:["base_oper_prog", "BASE_OPER_PROG", '"BASE_OPER_PROG"'] },
        { key:"COL_PROJ", candidates:["projeto", "PROJETO", '"PROJETO"'] },
        { key:"COL_PRAZO", candidates:["PREVISAO_EXECUCAO_FIM", "previsao_execucao_fim"] },
        { key:"COL_MUN", candidates:["municipio", "MUNICIPIO"] },
        { key:"COL_CRIT", candidates:["criterio", "CRITERIO"] },
        { key:"COL_NOTA", candidates:["nota", "NOTA"] },
      ];

      for(const t of tests){
        let chosen = null;
        for(const c of t.candidates){
          const sel = `${c}`;
          const { error } = await sb.from("obras").select(sel, { head:true, count:"exact" }).limit(1);
          if(!error){
            chosen = c;
            break;
          }
        }
        if(chosen){
          if(t.key==="COL_BASE") COL_BASE = chosen;
          if(t.key==="COL_PROJ") COL_PROJ = chosen;
          if(t.key==="COL_PRAZO") COL_PRAZO = chosen;
          if(t.key==="COL_MUN") COL_MUN = chosen;
          if(t.key==="COL_CRIT") COL_CRIT = chosen;
          if(t.key==="COL_NOTA") COL_NOTA = chosen;
        }
      }
    }

    function getField(row, col){
      // se col vier '"BASE_OPER_PROG"' precisamos acessar row.BASE_OPER_PROG
      const clean = col.replaceAll('"',"");
      return row?.[clean];
    }

    async function loadAll(){
      clearError();

      // valida config b√°sica
      if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
        showError("Faltou SUPABASE_URL ou SUPABASE_ANON_KEY.");
        return;
      }

      await detectColumns();

      // busca dados (puxa campos principais + extras comuns)
      const selectCols = [
        `${COL_NOTA}`,
        `${COL_PROJ}`,
        `${COL_BASE}`,
        `${COL_MUN}`,
        `${COL_CRIT}`,
        `${COL_PRAZO}`,
        "titulo",
        "gerencia",
        "status",
      ].join(",");

      const { data, error } = await sb
        .from("obras")
        .select(selectCols)
        .limit(5000);

      if(error){
        showError(
`N√£o consegui carregar dados da tabela 'obras'.

Detalhe: ${error.message}

Verifique:
- SUPABASE_URL e ANON_KEY (sb_publishable)
- RLS/policies da tabela obras (SELECT para anon)
- Se a tabela se chama 'obras'`
        );
        return;
      }

      allRows = data || [];
      buildFacets();
      render();
    }

    function buildFacets(){
      const setBase = new Set();
      const setMun = new Set();
      const setCrit = new Set();

      for(const r of allRows){
        const b = (getField(r, COL_BASE) ?? "").toString().trim();
        const m = (getField(r, COL_MUN) ?? "").toString().trim();
        const c = (getField(r, COL_CRIT) ?? "").toString().trim();
        if(b) setBase.add(b);
        if(m) setMun.add(m);
        if(c) setCrit.add(c);
      }

      bases = Array.from(setBase).sort((a,b)=>a.localeCompare(b));
      municipios = Array.from(setMun).sort((a,b)=>a.localeCompare(b));
      criterios = Array.from(setCrit).sort((a,b)=>a.localeCompare(b));

      // popular selects
      const baseSel = $("fBase");
      baseSel.innerHTML = `<option value="">Todas</option>` + bases.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

      const munSel = $("fMunicipio");
      munSel.innerHTML = `<option value="">Todos</option>` + municipios.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");

      const critSel = $("fCriterio");
      critSel.innerHTML = `<option value="">Todos</option>` + criterios.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function parseDateOnly(v){
      if(!v) return null;
      // pega s√≥ yyyy-mm-dd
      const s = String(v).slice(0,10);
      const d = new Date(s + "T00:00:00");
      if(String(d)==="Invalid Date") return null;
      return d;
    }

    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }

    function sameDay(a,b){
      return a && b &&
        a.getFullYear()===b.getFullYear() &&
        a.getMonth()===b.getMonth() &&
        a.getDate()===b.getDate();
    }

    function render(){
      clearError();

      const chosenDate = $("fData").value ? new Date($("fData").value + "T00:00:00") : null;
      const fBase = $("fBase").value;
      const fMun = $("fMunicipio").value;
      const fCrit = $("fCriterio").value;

      let rows = allRows.slice();

      // filtros
      if(fBase){
        rows = rows.filter(r => (getField(r, COL_BASE) ?? "").toString().trim() === fBase);
      }
      if(fMun){
        rows = rows.filter(r => (getField(r, COL_MUN) ?? "").toString().trim() === fMun);
      }
      if(fCrit){
        rows = rows.filter(r => (getField(r, COL_CRIT) ?? "").toString().trim() === fCrit);
      }

      // regra do dia
      let dayRows = [];
      if(chosenDate){
        dayRows = rows.filter(r => {
          const d = parseDateOnly(getField(r, COL_PRAZO));
          return d && sameDay(d, chosenDate);
        });
      }

      // se n√£o tiver do dia, pega pr√≥ximas 5 dentro de 5 dias (por base)
      // mas mant√©m "vitrine" por base sempre
      const basesToShow = (fBase ? [fBase] : (bases.length ? bases : ["(Sem base)"]));

      const container = $("gridBases");
      container.innerHTML = "";

      // agrupamento por base
      for(const b of basesToShow){
        const baseRows = rows.filter(r => (getField(r, COL_BASE) ?? "").toString().trim() === b);

        let showList = [];
        let label = "";

        if(chosenDate){
          const inDay = baseRows.filter(r => {
            const d = parseDateOnly(getField(r, COL_PRAZO));
            return d && sameDay(d, chosenDate);
          });

          if(inDay.length){
            showList = inDay.sort((a,b)=> (getField(a,COL_PRAZO) || "").localeCompare(getField(b,COL_PRAZO) || ""));
            label = `Obras do dia (${inDay.length})`;
          }else{
            const maxDate = addDays(chosenDate, 5);
            const upcoming = baseRows
              .map(r => ({ r, d: parseDateOnly(getField(r, COL_PRAZO)) }))
              .filter(x => x.d && x.d >= chosenDate && x.d <= maxDate)
              .sort((x,y)=> x.d - y.d)
              .slice(0,5)
              .map(x=>x.r);

            showList = upcoming;
            label = `Sem obras no dia ‚Ä¢ Pr√≥ximas at√© +5 dias (${upcoming.length})`;
          }
        }else{
          // sem data -> pega as mais pr√≥ximas a partir de hoje por base
          const today = new Date(); today.setHours(0,0,0,0);
          const maxDate = addDays(today, 5);
          const upcoming = baseRows
            .map(r => ({ r, d: parseDateOnly(getField(r, COL_PRAZO)) }))
            .filter(x => x.d && x.d >= today && x.d <= maxDate)
            .sort((x,y)=> x.d - y.d)
            .slice(0,5)
            .map(x=>x.r);

          showList = upcoming;
          label = `Pr√≥ximas at√© +5 dias (${upcoming.length})`;
        }

        // se n√£o tem nada e a base n√£o tem linhas, pula
        if(!baseRows.length && fBase) continue;

        container.appendChild(renderBaseBlock(b, label, showList));
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderBaseBlock(baseName, label, list){
      const wrap = document.createElement("div");
      wrap.className = "baseBlock";

      const head = document.createElement("div");
      head.className = "baseHead";
      head.innerHTML = `<div class="name">${escapeHtml(baseName || "Sem base")}</div><div class="count">${escapeHtml(label)}</div>`;
      wrap.appendChild(head);

      const table = document.createElement("table");
      const thead = document.createElement("thead");

      // colunas fixas (sem INICIO)
      const fixedCols = [
        { k: COL_NOTA, name:"nota", label:"Nota", cls:"nowrap" },
        { k: COL_PROJ, name:"projeto", label:"Projeto", cls:"nowrap" },
        { k: COL_PRAZO, name:"prazo", label:"Prazo final", cls:"nowrap" },
        { k: "titulo", name:"titulo", label:"T√≠tulo", cls:"" },
        { k: COL_MUN, name:"municipio", label:"Munic√≠pio", cls:"nowrap" },
        { k: COL_CRIT, name:"criterio", label:"Crit√©rio", cls:"nowrap" },
        { k: "status", name:"status", label:"Status", cls:"nowrap" },
      ];

      // extras (toggle)
      const extraCols = [
        { k: "gerencia", label:"Ger√™ncia", cls:"nowrap" },
      ];

      const cols = showExtras ? fixedCols.concat(extraCols) : fixedCols;

      thead.innerHTML = `<tr>${cols.map(c=>`<th class="${c.cls||""}">${escapeHtml(c.label)}</th>`).join("")}<th class="nowrap">A√ß√µes</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      if(!list.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="${cols.length+1}" class="muted">Nenhuma obra para exibir nesta base.</td>`;
        tbody.appendChild(tr);
      }else{
        for(const row of list){
          const tr = document.createElement("tr");
          const cells = cols.map(c=>{
            let v = (c.k === COL_PRAZO) ? fmtDateBR(getField(row, COL_PRAZO)) : getField(row, c.k);
            if(c.k === COL_NOTA) v = normalizeNota(v);
            if(v === null || v === undefined || v === "") v = "‚Äî";
            return `<td class="${c.cls||""}">${escapeHtml(v)}</td>`;
          }).join("");

          const notaKey = normalizeNota(getField(row, COL_NOTA));
          const sub = `${normalizeNota(getField(row, COL_NOTA))} ‚Ä¢ ${(getField(row, COL_MUN)||"").toString()} ‚Ä¢ ${(getField(row, COL_CRIT)||"").toString()}`;

          tr.innerHTML =
            cells +
            `<td class="nowrap">
              <button class="linkBtn" data-nota="${escapeHtml(notaKey)}" data-sub="${escapeHtml(sub)}">Notas</button>
            </td>`;

          tbody.appendChild(tr);
        }
      }

      table.appendChild(tbody);
      wrap.appendChild(table);

      // bind notes buttons
      wrap.querySelectorAll("button[data-nota]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const nota = btn.getAttribute("data-nota");
          const sub = btn.getAttribute("data-sub");
          openNotes(nota, sub);
        });
      });

      return wrap;
    }

    function buildWhatsText(){
      const chosenDate = $("fData").value ? new Date($("fData").value + "T00:00:00") : null;
      if(!chosenDate){
        return "Selecione uma data primeiro.";
      }

      const fBase = $("fBase").value;
      const fMun = $("fMunicipio").value;
      const fCrit = $("fCriterio").value;

      let rows = allRows.slice();
      if(fBase) rows = rows.filter(r => (getField(r, COL_BASE) ?? "").toString().trim() === fBase);
      if(fMun) rows = rows.filter(r => (getField(r, COL_MUN) ?? "").toString().trim() === fMun);
      if(fCrit) rows = rows.filter(r => (getField(r, COL_CRIT) ?? "").toString().trim() === fCrit);

      const day = rows.filter(r=>{
        const d = parseDateOnly(getField(r, COL_PRAZO));
        return d && sameDay(d, chosenDate);
      });

      const dateBR = fmtDateBR($("fData").value);

      if(!day.length){
        return `üìå Obras do dia (${dateBR})\n\nNenhuma obra com prazo final hoje pelos filtros selecionados.`;
      }

      // agrupa por base
      const byBase = new Map();
      for(const r of day){
        const b = (getField(r, COL_BASE) ?? "Sem base").toString().trim() || "Sem base";
        if(!byBase.has(b)) byBase.set(b, []);
        byBase.get(b).push(r);
      }

      let msg = `üìå Obras do dia (${dateBR})\n`;
      for(const [b, list] of Array.from(byBase.entries()).sort((a,b)=>a[0].localeCompare(b[0]))){
        msg += `\nüè∑Ô∏è Base: ${b}\n`;
        for(const r of list){
          const nota = normalizeNota(getField(r, COL_NOTA));
          const proj = getField(r, COL_PROJ) || "‚Äî";
          const titulo = getField(r, "titulo") || "‚Äî";
          const mun = getField(r, COL_MUN) || "‚Äî";
          msg += `- Nota ${nota} ‚Ä¢ ${proj} ‚Ä¢ ${mun} ‚Ä¢ ${titulo}\n`;
        }
      }
      return msg.trim();
    }

    function openWhats(){
      const txt = buildWhatsText();
      const url = "https://wa.me/?text=" + encodeURIComponent(txt);
      window.open(url, "_blank");
    }

    // ======= NOTAS =======
    async function openNotes(notaKey, sub){
      currentNotaKey = notaKey;
      $("modalTitle").textContent = `Notas - Nota ${notaKey}`;
      $("modalSub").textContent = sub || "";
      $("overlay").style.display = "flex";
      $("nTexto").value = "";
      await loadNotes();
    }

    function closeNotes(){
      $("overlay").style.display = "none";
      currentNotaKey = null;
    }

    function statusTag(status){
      if(status==="executada") return `<span class="tag">Executada</span>`;
      if(status==="problemas") return `<span class="tag warn">Problemas</span>`;
      if(status==="nao_executada") return `<span class="tag danger">N√£o executada</span>`;
      return `<span class="tag">${escapeHtml(status||"‚Äî")}</span>`;
    }

    async function loadNotes(){
      const list = $("notesList");
      list.innerHTML = `<div class="muted">Carregando notas‚Ä¶</div>`;

      // tenta buscar pelo nota em texto (sem .0)
      const { data, error } = await sb
        .from("notes")
        .select("id, nota, autor, texto, status, created_at")
        .eq("nota", currentNotaKey)
        .order("created_at", { ascending:false });

      if(error){
        list.innerHTML =
          `<div class="error">Erro ao carregar notas: ${escapeHtml(error.message)}</div>`;
        return;
      }

      if(!data || !data.length){
        list.innerHTML = `<div class="muted">Nenhuma nota ainda. Adicione a primeira acima.</div>`;
        return;
      }

      list.innerHTML = data.map(n=>{
        const when = n.created_at ? new Date(n.created_at).toLocaleString("pt-BR") : "‚Äî";
        return `
          <div class="noteItem">
            <div class="noteMeta">
              <div class="who">${escapeHtml(n.autor || "‚Äî")}</div>
              ${statusTag(n.status)}
              <div class="when">${escapeHtml(when)}</div>
            </div>
            <div class="noteText">${escapeHtml(n.texto || "")}</div>
          </div>
        `;
      }).join("");
    }

    async function saveNote(){
      const autor = $("nAutor").value.trim();
      const texto = $("nTexto").value.trim();
      const status = $("nStatus").value;

      if(!autor){
        alert("Informe seu nome.");
        return;
      }
      if(!texto){
        alert("Escreva a nota.");
        return;
      }

      const payload = {
        nota: currentNotaKey,
        autor,
        texto,
        status
        // created_at geralmente √© autom√°tico no Supabase
      };

      const { error } = await sb.from("notes").insert(payload);
      if(error){
        alert("Erro ao salvar nota: " + error.message);
        return;
      }

      $("nTexto").value = "";
      await loadNotes();
    }

    // ======= UI events =======
    function setToday(){
      const now = new Date();
      now.setHours(0,0,0,0);
      $("fData").value = fmtDateInput(now);
      $("todayPill").textContent = "Data: " + fmtDateBR($("fData").value);
    }

    function toggleDetails(){
      showExtras = !showExtras;
      $("tabDetalhes").classList.toggle("active", showExtras);
      render();
    }

    // init
    (function init(){
      setToday();

      $("btnReload").addEventListener("click", loadAll);
      $("btnHoje").addEventListener("click", ()=>{ setToday(); render(); });

      $("fData").addEventListener("change", ()=>{ $("todayPill").textContent = "Data: " + fmtDateBR($("fData").value); render(); });
      $("fBase").addEventListener("change", render);
      $("fMunicipio").addEventListener("change", render);
      $("fCriterio").addEventListener("change", render);

      $("tabFiltros").addEventListener("click", ()=>{
        $("tabFiltros").classList.add("active");
        // n√£o tem painel separado; apenas visual
      });
      $("tabDetalhes").addEventListener("click", toggleDetails);

      $("btnWhats").addEventListener("click", openWhats);

      $("btnClose").addEventListener("click", closeNotes);
      $("btnClose2").addEventListener("click", closeNotes);
      $("overlay").addEventListener("click", (e)=>{ if(e.target === $("overlay")) closeNotes(); });

      $("btnSalvarNota").addEventListener("click", saveNote);
      $("btnRecarregarNotas").addEventListener("click", loadNotes);

      loadAll();
    })();
  </script>
</body>
</html>