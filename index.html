<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento de Obras</title>

  <style>
    :root{
      --bg:#071a13;
      --bg2:#0c2a20;
      --card:#0e2f24;
      --card2:#10382b;
      --text:#e8fff4;
      --muted:#b9e6d2;
      --line:rgba(232,255,244,.12);
      --accent:#7CFCB8;
      --accent2:#3ddc97;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 50% -10%, rgba(124,252,184,.20), transparent 55%),
                  radial-gradient(900px 700px at 100% 20%, rgba(61,220,151,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg), #04110c 70%);
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }
    header{
      max-width:1200px;
      margin:0 auto 14px auto;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .title h1{margin:0;font-size:34px;letter-spacing:.2px}
    .title .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .rightTop{
      display:flex;flex-direction:column;gap:10px;align-items:flex-end;
      min-width:210px;
    }
    .badgeRow{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(124,252,184,.12);
      border:1px solid rgba(124,252,184,.22);
      color:var(--text);
      padding:8px 12px;border-radius:999px;font-size:13px;
    }
    .btn{
      border:0;cursor:pointer;
      padding:10px 14px;border-radius:12px;
      background:linear-gradient(180deg, rgba(124,252,184,.22), rgba(61,220,151,.16));
      border:1px solid rgba(124,252,184,.26);
      color:var(--text);
      box-shadow:var(--shadow);
      transition:.15s transform ease, .15s opacity ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .wrap{max-width:1200px;margin:0 auto;display:grid;gap:14px;}
    .panel{
      background:linear-gradient(180deg, rgba(16,56,43,.72), rgba(10,34,26,.66));
      border:1px solid rgba(232,255,244,.12);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      display:flex;flex-wrap:wrap;gap:12px;
      align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{
      padding:9px 12px;border-radius:12px;
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(124,252,184,.35);
      background:rgba(124,252,184,.14);
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .pane{display:none;}
    .pane.active{display:block;}

    .filters{
      padding:14px 16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{color:var(--muted);font-size:13px}
    input, select{
      width:100%;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(232,255,244,.14);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    input[type="date"]{color-scheme:dark}
    .rule{padding:0 16px 14px 16px;color:var(--muted);font-size:13px;}
    .detailBox{padding:14px 16px 6px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .toggleRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:0 16px 14px 16px;}
    .toggle{
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{width:auto}

    .error{
      margin:0 16px 16px 16px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      color:#ffeaea;
      white-space:pre-wrap;
      font-family:var(--mono);
      font-size:12px;
    }

    .gridBases{
      padding:14px 16px 18px 16px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .baseBlock{
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .baseHead{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid var(--line);
      background:rgba(124,252,184,.08);
    }
    .baseHead .name{font-weight:700}
    .baseHead .count{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(232,255,244,.10);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      background:rgba(0,0,0,.10);
      position:sticky; top:0;
      z-index:1;
    }
    tr:hover td{background:rgba(124,252,184,.06)}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:rgba(124,252,184,.12);
      border:1px solid rgba(124,252,184,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.warn{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.25)}
    .tag.danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.25)}
    .tag.done{background:rgba(124,252,184,.16);border-color:rgba(124,252,184,.32)}
    .linkBtn{
      cursor:pointer;
      padding:8px 10px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      font-size:12px;
    }
    .footer{
      max-width:1200px;margin:16px auto 0 auto;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(760px, 100%);
      background:linear-gradient(180deg, rgba(16,56,43,.92), rgba(10,34,26,.92));
      border:1px solid rgba(232,255,244,.14);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .modalHead h3{margin:0;font-size:16px}
    .modalBody{padding:14px}
    .modalGrid{
      display:grid;grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .modalGrid .field:last-child{grid-column:1/-1}
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(232,255,244,.14);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-family:var(--sans);
    }
    .notesList{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .noteItem{
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }
    .noteMeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .noteMeta .who{font-weight:700}
    .noteMeta .when{color:var(--muted);font-size:12px}
    .noteText{margin-top:8px;color:var(--text);white-space:pre-wrap}
    .modalFoot{
      display:flex;gap:10px;justify-content:flex-end;
      padding:12px 14px;border-top:1px solid var(--line);
      flex-wrap:wrap;
    }
    .checkList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      padding:10px 0 0 0;
    }
    .checkItem{
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.12);
    }

    /* Admin */
    .adminWrap{padding:14px 16px 18px 16px;}
    .adminGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .adminCard{
      border:1px solid rgba(232,255,244,.12);
      background:rgba(0,0,0,.10);
      border-radius:16px;
      padding:12px 12px;
    }
    .adminCard h4{margin:0 0 8px 0;font-size:14px}
    .adminCard .muted{font-size:12px}
    .adminTableWrap{
      margin-top:12px;
      border:1px solid rgba(232,255,244,.12);
      border-radius:16px;
      overflow:auto;
      max-height:520px;
      background:rgba(0,0,0,.10);
    }
    .miniRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:10px;
    }
    .miniRow input[type="text"]{max-width:420px}
    .chk{display:flex;gap:8px;align-items:center}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:900px){
      .filters{grid-template-columns:1fr}
      .modalGrid{grid-template-columns:1fr}
      .checkList{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start}
      .rightTop{align-items:flex-start}
      .adminGrid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Acompanhamento de Obras</h1>
      <div class="sub">UTEP Nordeste ‚Ä¢ Supabase + GitHub Pages</div>
    </div>

    <div class="rightTop">
      <div class="badgeRow">
        <div class="pill" id="todayPill">Data: --/--/----</div>
        <div class="pill">Vers√£o: LGPD+Admin</div>
      </div>

      <div class="badgeRow" style="gap:8px">
        <div class="pill" id="authPill" style="display:none">üîí</div>
        <button class="btn secondary" id="btnLogout" style="display:none">Logout</button>
      </div>

      <button class="btn secondary" id="btnReload">Recarregar</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="panelHead">
        <div class="tabs">
          <div class="tab active" id="tabAtivas">Ativas</div>
          <div class="tab" id="tabConcluidas">Conclu√≠das</div>
          <div class="tab" id="tabDetalhes">Detalhes</div>

          <button class="btn" id="btnEmail">Exportar E-mail</button>
          <button class="btn" id="btnWhats">Exportar WhatsApp</button>

          <div class="tab" id="tabAdmin" style="display:none">Admin</div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btnHoje">Hoje</button>
        </div>
      </div>

      <div class="pane active" id="paneFiltros">
        <div class="filters">
          <div class="field">
            <label>Data (prazo final)</label>
            <input type="date" id="fData" />
          </div>

          <div class="field">
            <label>Base</label>
            <select id="fBase">
              <option value="">Todas</option>
            </select>
          </div>

          <div class="field">
            <label>Munic√≠pio</label>
            <select id="fMunicipio">
              <option value="">Todos</option>
            </select>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Crit√©rio</label>
            <select id="fCriterio">
              <option value="">Todos</option>
            </select>
          </div>
        </div>

        <div class="rule" id="ruleText">
          Regras: mostra obras com <b>prazo final</b> na data escolhida. Se n√£o houver, mostra as <b>5 mais pr√≥ximas dentro de 5 dias</b>, separadas por Base.
        </div>
      </div>

      <div class="pane" id="paneDetalhes">
        <div class="detailBox">
          <div class="pill">Colunas extras</div>
          <div class="muted">Ative/desative campos adicionais na tabela.</div>
        </div>
        <div class="toggleRow">
          <label class="toggle">
            <input type="checkbox" id="tShowExtras" />
            Mostrar colunas extras (Ger√™ncia)
          </label>
        </div>
      </div>

      <!-- Admin pane -->
      <div class="pane" id="paneAdmin">
        <div class="adminWrap">
          <div class="adminGrid">
            <div class="adminCard">
              <h4>Marcar obras como conclu√≠das</h4>
              <div class="muted">Isso remove as obras da aba ‚ÄúAtivas‚Äù. (Admin pode marcar/desmarcar manualmente)</div>
              <div class="miniRow">
                <input id="admSearch" type="text" placeholder="Buscar por Nota, Projeto, Munic√≠pio, Base..." />
                <label class="chk"><input id="admOnlyOpen" type="checkbox" checked /> Mostrar apenas n√£o conclu√≠das</label>
              </div>
              <div class="miniRow">
                <button class="btn secondary" id="btnAdminReload">Recarregar admin</button>
                <button class="btn secondary" id="btnAdminExportCsv">Exportar CSV (vis√£o admin)</button>
              </div>
              <div class="small">Dica: marcar ‚Äúconclu√≠da‚Äù aqui √© √∫til quando faltou registrar ‚Äúenergizada‚Äù nas notas.</div>
            </div>

            <div class="adminCard">
              <h4>Op√ß√µes extras</h4>
              <div class="muted">Atalhos de admin (sem expor e-mails no dashboard normal).</div>
              <div class="miniRow">
                <button class="btn secondary" id="btnAdminCopySummary">Copiar resumo (ativas)</button>
                <button class="btn secondary" id="btnAdminCopyDone">Copiar resumo (conclu√≠das)</button>
              </div>
              <div class="miniRow">
                <button class="btn secondary" id="btnAdminPurgeCache">Limpar cache local</button>
              </div>
              <div class="small">
                Se voc√™ estiver usando aprova√ß√£o manual, d√° pra adicionar um painel de ‚Äúaprovar usu√°rios‚Äù.
                Se quiser, eu incluo na pr√≥xima vers√£o.
              </div>
            </div>
          </div>

          <div class="adminTableWrap">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">Conclu√≠da</th>
                  <th class="nowrap">Nota</th>
                  <th class="nowrap">Projeto</th>
                  <th class="nowrap">Base</th>
                  <th class="nowrap">Munic√≠pio</th>
                  <th class="nowrap">Crit√©rio</th>
                  <th class="nowrap">Prazo final</th>
                </tr>
              </thead>
              <tbody id="admTbody">
                <tr><td colspan="7" class="muted">Carregando‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="errBox" class="error" style="display:none"></div>
      <div class="gridBases" id="gridBases"></div>
    </div>

    <div class="footer">
      UTEP Nordeste ‚Ä¢ GitHub Pages ‚Ä¢ Acesso controlado (LGPD).
    </div>
  </div>

  <!-- Modal notas -->
  <div class="overlay" id="overlayNotes">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">Notas</h3>
          <div class="muted" id="modalSub"></div>
        </div>
        <button class="linkBtn" id="btnCloseNotes">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <div class="field">
            <label>Seu nome</label>
            <input id="nAutor" placeholder="Ex.: Jo√£o Silva" />
          </div>

          <div class="field">
            <label>Status</label>
            <select id="nStatus">
              <option value="executada">Executada</option>
              <option value="problemas">Houve problemas</option>
              <option value="nao_executada">N√£o foi executada</option>
              <option value="energizada">Energizada (conclu√≠da)</option>
            </select>
          </div>

          <div class="field">
            <label>Adicionar nota</label>
            <textarea id="nTexto" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btnSalvarNota">Salvar nota</button>
          <button class="btn secondary" id="btnRecarregarNotas">Recarregar notas</button>
        </div>

        <div class="notesList" id="notesList">
          <div class="muted">Carregando notas‚Ä¶</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn secondary" id="btnCloseNotes2">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal WhatsApp -->
  <div class="overlay" id="overlayWhats">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Exportar WhatsApp</h3>
          <div class="muted">Escolha per√≠odo e bases. Exporta agrupado por <b>data</b> e <b>base</b>.</div>
        </div>
        <button class="linkBtn" id="btnCloseWhats">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <div class="field">
            <label>De (data inicial)</label>
            <input type="date" id="wDe" />
          </div>
          <div class="field">
            <label>At√© (data final)</label>
            <input type="date" id="wAte" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Bases para exportar</label>
            <div class="checkList" id="wBases"></div>
            <div class="actions" style="margin-top:10px">
              <button class="btn secondary" id="btnSelAll">Selecionar todas</button>
              <button class="btn secondary" id="btnSelNone">Limpar</button>
            </div>
          </div>
        </div>

        <div class="rule" style="padding:10px 0 0 0">
          Dica: para ‚Äú<b>hoje at√© quinta que vem</b>‚Äù, coloque a data final manualmente no campo ‚ÄúAt√©‚Äù.
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn secondary" id="btnPreviewWhats">Pr√©via</button>
        <button class="btn" id="btnSendWhats">Abrir WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- Modal E-mail -->
  <div class="overlay" id="overlayEmail">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Exportar por E-mail</h3>
          <div class="muted">Somente destinat√°rio <b>@neoenergia.com</b>. (Abre seu cliente de e-mail com o texto pronto)</div>
        </div>
        <button class="linkBtn" id="btnCloseEmail">Fechar</button>
      </div>
      <div class="modalBody">
        <div class="modalGrid">
          <div class="field" style="grid-column:1/-1">
            <label>Para</label>
            <input id="eTo" type="email" placeholder="grupo@neoenergia.com" />
          </div>
          <div class="field">
            <label>De</label>
            <input type="date" id="eDe" />
          </div>
          <div class="field">
            <label>At√©</label>
            <input type="date" id="eAte" />
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>Bases</label>
            <div class="checkList" id="eBases"></div>
            <div class="actions" style="margin-top:10px">
              <button class="btn secondary" id="eSelAll">Selecionar todas</button>
              <button class="btn secondary" id="eSelNone">Limpar</button>
            </div>
          </div>
        </div>

        <div class="rule" id="eMsg" style="padding:10px 0 0 0">
          Voc√™ pode copiar o texto antes de abrir o e-mail.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="btnEmailCopy">Copiar texto</button>
        <button class="btn" id="btnEmailOpen">Abrir e-mail</button>
      </div>
    </div>
  </div>

  <!-- Overlay Login -->
  <div class="overlay" id="overlayLogin">
    <div class="modal" style="width:min(560px,100%)">
      <div class="modalHead">
        <div>
          <h3>Login</h3>
          <div class="muted">Acesso restrito ‚Ä¢ e-mail + senha</div>
        </div>
      </div>
      <div class="modalBody">
        <div class="modalGrid">
          <div class="field" style="grid-column:1/-1">
            <label>E-mail</label>
            <input id="loginEmail" type="email" autocomplete="email" placeholder="seuemail@neoenergia.com" />
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>Senha</label>
            <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btnSignIn">Entrar</button>
          <button class="btn secondary" id="btnSignUp">Criar conta</button>
        </div>
        <div class="rule" id="loginMsg" style="padding:10px 0 0 0">
          Use seu e-mail corporativo. Se sua conta ainda n√£o estiver aprovada, o acesso ficar√° bloqueado.
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay N√£o aprovado -->
  <div class="overlay" id="overlayDenied">
    <div class="modal" style="width:min(560px,100%)">
      <div class="modalHead">
        <div>
          <h3>Acesso bloqueado</h3>
          <div class="muted">Conta n√£o aprovada ou sem permiss√£o.</div>
        </div>
      </div>
      <div class="modalBody">
        <div class="pill">üö´ Sem acesso aos dados</div>
        <div class="rule" style="padding:10px 0 0 0">
          Se voc√™ acabou de criar a conta, aguarde aprova√ß√£o do administrador.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="btnDeniedLogout">Logout</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======= CONFIG =======
    const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co".trim();
    const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx".trim();
    const ALLOW_DOMAIN = "@neoenergia.com";

    // ADMIN (n√£o exibimos em tela; s√≥ determina se mostra aba Admin)
    const ADMIN_EMAIL = "mamutevitor@gmail.com";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // nomes de coluna (auto-detect)
    let COL_BASE = "base_oper_prog";
    let COL_PRAZO = "PREVISAO_EXECUCAO_FIM";
    let COL_NOTA  = "nota";
    let COL_MUN   = "municipio";
    let COL_CRIT  = "criterio";
    let COL_PROJ  = "projeto";
    let COL_AGENT = "agente_responsavel";

    let showExtras = false;
    let mode = "ativas"; // ativas | concluidas | admin

    // estado
    let allRows = [];
    let bases = [];
    let municipios = [];
    let criterios = [];
    let currentNotaKey = null;

    // admin state
    let isAdmin = false;
    let adminRows = [];

    const $ = (id) => document.getElementById(id);
    function show(el, on){ el.style.display = on ? "flex" : "none"; }
    function showInline(el, on){ el.style.display = on ? "inline-flex" : "none"; }

    function fmtDateBR(iso){
      if(!iso) return "";
      const d = new Date(iso);
      if(String(d) === "Invalid Date"){
        const parts = String(iso).slice(0,10).split("-");
        if(parts.length===3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return String(iso);
      }
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function fmtDateInput(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }
    function normalizeNota(v){
      if(v === null || v === undefined) return "";
      let s = String(v).trim();
      s = s.replace(/\.0$/,"");
      return s;
    }
    function parseDateOnly(v){
      if(!v) return null;
      const s = String(v).slice(0,10);
      const d = new Date(s + "T00:00:00");
      if(String(d)==="Invalid Date") return null;
      return d;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }
    function sameDay(a,b){
      return a && b &&
        a.getFullYear()===b.getFullYear() &&
        a.getMonth()===b.getMonth() &&
        a.getDate()===b.getDate();
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function showError(msg){
      const box = $("errBox");
      box.style.display = "block";
      box.textContent = msg;
    }
    function clearError(){
      const box = $("errBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function setAuthUI(isAuthed){
      const pill = $("authPill");
      const logout = $("btnLogout");
      if(isAuthed){
        pill.textContent = "‚úÖ Autenticado";
        showInline(pill, true);
        showInline(logout, true);
      }else{
        pill.textContent = "üîí N√£o autenticado";
        showInline(pill, true);
        showInline(logout, false);
      }
    }

    function emailAllowedUX(email){
      const e = (email||"").trim().toLowerCase();
      return e.endsWith(ALLOW_DOMAIN) || e === ADMIN_EMAIL.toLowerCase();
    }

    async function signIn(){
      const email = ($("loginEmail").value||"").trim().toLowerCase();
      const pass  = ($("loginPass").value||"").trim();
      const msg = $("loginMsg");

      if(!email || !pass){
        msg.textContent = "Informe e-mail e senha.";
        msg.style.color = "var(--warn)";
        return;
      }
      if(!emailAllowedUX(email)){
        msg.textContent = "E-mail n√£o permitido.";
        msg.style.color = "var(--warn)";
        return;
      }

      msg.textContent = "Entrando‚Ä¶";
      msg.style.color = "var(--muted)";

      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error){
        msg.textContent = "Falha no login: " + error.message;
        msg.style.color = "var(--danger)";
        return;
      }
    }

    async function signUp(){
      const email = ($("loginEmail").value||"").trim().toLowerCase();
      const pass  = ($("loginPass").value||"").trim();
      const msg = $("loginMsg");

      if(!email || !pass){
        msg.textContent = "Informe e-mail e senha.";
        msg.style.color = "var(--warn)";
        return;
      }
      if(!emailAllowedUX(email)){
        msg.textContent = "E-mail n√£o permitido.";
        msg.style.color = "var(--warn)";
        return;
      }
      if(pass.length < 8){
        msg.textContent = "Use uma senha com pelo menos 8 caracteres.";
        msg.style.color = "var(--warn)";
        return;
      }

      msg.textContent = "Criando conta‚Ä¶";
      msg.style.color = "var(--muted)";

      const { error } = await sb.auth.signUp({ email, password: pass });
      if(error){
        msg.textContent = "Falha ao criar conta: " + error.message;
        msg.style.color = "var(--danger)";
        return;
      }

      msg.textContent = "Conta criada. Se exigir aprova√ß√£o, aguarde libera√ß√£o.";
      msg.style.color = "var(--accent)";
    }

    async function logout(){
      await sb.auth.signOut();
      setAuthUI(false);
      show($("overlayDenied"), false);
      show($("overlayLogin"), true);
      $("tabAdmin").style.display = "none";
      isAdmin = false;
    }

    async function checkApprovedOrBlock(){
      const { data: { session } } = await sb.auth.getSession();
      if(!session){
        setAuthUI(false);
        show($("overlayDenied"), false);
        show($("overlayLogin"), true);
        return false;
      }

      setAuthUI(true);

      const email = (session.user.email || "").toLowerCase();
      isAdmin = (email === ADMIN_EMAIL.toLowerCase());

      // RPC me_status (n√£o exp√µe email na UI)
      const { data, error } = await sb.rpc("me_status");
      if(error || !data || !data.length){
        show($("overlayLogin"), false);
        show($("overlayDenied"), true);
        return false;
      }

      const st = data[0];
      if(!st.aprovado){
        show($("overlayLogin"), false);
        show($("overlayDenied"), true);
        return false;
      }

      // mostra admin tab somente pro admin
      $("tabAdmin").style.display = isAdmin ? "inline-flex" : "none";

      show($("overlayLogin"), false);
      show($("overlayDenied"), false);
      return true;
    }

    async function detectColumns(){
      const tests = [
        { key:"COL_BASE", candidates:["base_oper_prog", "BASE_OPER_PROG", '"BASE_OPER_PROG"'] },
        { key:"COL_PROJ", candidates:["projeto", "PROJETO", '"PROJETO"'] },
        { key:"COL_AGENT", candidates:["agente_responsavel", "AGENTE_RESPONSAVEL", '"AGENTE_RESPONSAVEL"'] },
        { key:"COL_PRAZO", candidates:["PREVISAO_EXECUCAO_FIM", "previsao_execucao_fim"] },
        { key:"COL_MUN", candidates:["municipio", "MUNICIPIO"] },
        { key:"COL_CRIT", candidates:["criterio", "CRITERIO"] },
        { key:"COL_NOTA", candidates:["nota", "NOTA"] },
      ];

      for(const t of tests){
        let chosen = null;
        for(const c of t.candidates){
          const { error } = await sb.from("obras").select(`${c}`, { head:true, count:"exact" }).limit(1);
          if(!error){ chosen = c; break; }
        }
        if(chosen){
          if(t.key==="COL_BASE") COL_BASE = chosen;
          if(t.key==="COL_PROJ") COL_PROJ = chosen;
          if(t.key==="COL_AGENT") COL_AGENT = chosen;
          if(t.key==="COL_PRAZO") COL_PRAZO = chosen;
          if(t.key==="COL_MUN") COL_MUN = chosen;
          if(t.key==="COL_CRIT") COL_CRIT = chosen;
          if(t.key==="COL_NOTA") COL_NOTA = chosen;
        }
      }
    }

    function getField(row, col){
      const clean = col.replaceAll('"',"");
      return row?.[clean];
    }

    async function loadAll(){
      clearError();
      await detectColumns();

      const selectCols = [
        `${COL_NOTA}`,
        `${COL_PROJ}`,
        `${COL_AGENT}`,
        `${COL_BASE}`,
        `${COL_MUN}`,
        `${COL_CRIT}`,
        `${COL_PRAZO}`,
        "titulo",
        "gerencia",
        "status",
        "concluida",
        "concluida_em"
      ].join(",");

      const { data, error } = await sb.from("obras").select(selectCols).limit(5000);
      if(error){
        showError(`N√£o consegui carregar 'obras'.\n\n${error.message}`);
        return;
      }

      allRows = data || [];
      buildFacets();
      buildWhatsBases();
      buildEmailBases();
      render();
    }

    function buildFacets(){
      const setBase = new Set();
      const setMun = new Set();
      const setCrit = new Set();

      for(const r of allRows){
        const b = (getField(r, COL_BASE) ?? "").toString().trim();
        const m = (getField(r, COL_MUN) ?? "").toString().trim();
        const c = (getField(r, COL_CRIT) ?? "").toString().trim();
        if(b) setBase.add(b);
        if(m) setMun.add(m);
        if(c) setCrit.add(c);
      }

      bases = Array.from(setBase).sort((a,b)=>a.localeCompare(b));
      municipios = Array.from(setMun).sort((a,b)=>a.localeCompare(b));
      criterios = Array.from(setCrit).sort((a,b)=>a.localeCompare(b));

      $("fBase").innerHTML = `<option value="">Todas</option>` + bases.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");
      $("fMunicipio").innerHTML = `<option value="">Todos</option>` + municipios.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
      $("fCriterio").innerHTML = `<option value="">Todos</option>` + criterios.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function setMode(m){
      mode = m;

      $("tabAtivas").classList.toggle("active", mode==="ativas");
      $("tabConcluidas").classList.toggle("active", mode==="concluidas");
      $("tabDetalhes").classList.toggle("active", mode==="detalhes");
      $("tabAdmin").classList.toggle("active", mode==="admin");

      $("paneFiltros").classList.toggle("active", mode==="ativas" || mode==="concluidas");
      $("paneDetalhes").classList.toggle("active", mode==="detalhes");
      $("paneAdmin").classList.toggle("active", mode==="admin");

      if(mode==="concluidas"){
        $("ruleText").innerHTML = `Mostrando <b>Conclu√≠das</b> (marcadas por nota ‚Äú<b>Energizada</b>‚Äù ou manualmente pelo Admin).`;
      } else {
        $("ruleText").innerHTML = `Regras: mostra obras com <b>prazo final</b> na data escolhida. Se n√£o houver, mostra as <b>5 mais pr√≥ximas dentro de 5 dias</b>, separadas por Base.`;
      }

      if(mode==="admin"){
        loadAdmin();
      } else {
        render();
      }
    }

    function render(){
      if(mode==="admin") return;

      clearError();

      const chosenDate = $("fData").value ? new Date($("fData").value + "T00:00:00") : null;
      const fBase = $("fBase").value;
      const fMun = $("fMunicipio").value;
      const fCrit = $("fCriterio").value;

      let rows = allRows.slice();

      if(mode==="concluidas") rows = rows.filter(r => !!r.concluida);
      else rows = rows.filter(r => !r.concluida);

      if(fBase) rows = rows.filter(r => (getField(r, COL_BASE) ?? "").toString().trim() === fBase);
      if(fMun) rows = rows.filter(r => (getField(r, COL_MUN) ?? "").toString().trim() === fMun);
      if(fCrit) rows = rows.filter(r => (getField(r, COL_CRIT) ?? "").toString().trim() === fCrit);

      const basesToShow = (fBase ? [fBase] : (bases.length ? bases : ["(Sem base)"]));

      const container = $("gridBases");
      container.innerHTML = "";

      for(const b of basesToShow){
        const baseRows = rows.filter(r => (getField(r, COL_BASE) ?? "").toString().trim() === b);

        let showList = [];
        let label = "";

        if(mode==="concluidas"){
          showList = baseRows.slice();
          label = `Conclu√≠das (${showList.length})`;
        } else {
          if(chosenDate){
            const inDay = baseRows.filter(r => {
              const d = parseDateOnly(getField(r, COL_PRAZO));
              return d && sameDay(d, chosenDate);
            });

            if(inDay.length){
              showList = inDay;
              label = `Obras do dia (${inDay.length})`;
            }else{
              const maxDate = addDays(chosenDate, 5);
              showList = baseRows
                .map(r => ({ r, d: parseDateOnly(getField(r, COL_PRAZO)) }))
                .filter(x => x.d && x.d >= chosenDate && x.d <= maxDate)
                .sort((x,y)=> x.d - y.d)
                .slice(0,5)
                .map(x=>x.r);
              label = `Sem obras no dia ‚Ä¢ Pr√≥ximas at√© +5 dias (${showList.length})`;
            }
          }else{
            const today = new Date(); today.setHours(0,0,0,0);
            const maxDate = addDays(today, 5);
            showList = baseRows
              .map(r => ({ r, d: parseDateOnly(getField(r, COL_PRAZO)) }))
              .filter(x => x.d && x.d >= today && x.d <= maxDate)
              .sort((x,y)=> x.d - y.d)
              .slice(0,5)
              .map(x=>x.r);
            label = `Pr√≥ximas at√© +5 dias (${showList.length})`;
          }
        }

        container.appendChild(renderBaseBlock(b, label, showList));
      }
    }

    function renderBaseBlock(baseName, label, list){
      const wrap = document.createElement("div");
      wrap.className = "baseBlock";

      const head = document.createElement("div");
      head.className = "baseHead";
      head.innerHTML = `<div class="name">${escapeHtml(baseName || "Sem base")}</div><div class="count">${escapeHtml(label)}</div>`;
      wrap.appendChild(head);

      const table = document.createElement("table");
      const thead = document.createElement("thead");

      const fixedCols = [
        { k: COL_NOTA, label:"Nota", cls:"nowrap" },
        { k: COL_PROJ, label:"Projeto", cls:"nowrap" },
        { k: COL_AGENT, label:"Agente respons√°vel", cls:"nowrap" },
        { k: COL_PRAZO, label:"Prazo final", cls:"nowrap" },
        { k: "titulo", label:"T√≠tulo", cls:"" },
        { k: COL_MUN, label:"Munic√≠pio", cls:"nowrap" },
        { k: COL_CRIT, label:"Crit√©rio", cls:"nowrap" },
        { k: "status", label:"Status", cls:"nowrap" },
      ];
      const extraCols = [{ k: "gerencia", label:"Ger√™ncia", cls:"nowrap" }];

      const cols = showExtras ? fixedCols.concat(extraCols) : fixedCols;
      thead.innerHTML = `<tr>${cols.map(c=>`<th class="${c.cls||""}">${escapeHtml(c.label)}</th>`).join("")}<th class="nowrap">A√ß√µes</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      if(!list.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="${cols.length+1}" class="muted">Nenhuma obra para exibir nesta base.</td>`;
        tbody.appendChild(tr);
      }else{
        list = list.slice().sort((a,b)=>{
          const da = parseDateOnly(getField(a,COL_PRAZO));
          const db = parseDateOnly(getField(b,COL_PRAZO));
          if(!da && !db) return 0;
          if(!da) return 1;
          if(!db) return -1;
          return da - db;
        });

        for(const row of list){
          const tr = document.createElement("tr");
          const cells = cols.map(c=>{
            let v = (c.k === COL_PRAZO) ? fmtDateBR(getField(row, COL_PRAZO)) : getField(row, c.k);
            if(c.k === COL_NOTA) v = normalizeNota(v);
            if(v === null || v === undefined || v === "") v = "‚Äî";
            return `<td class="${c.cls||""}">${escapeHtml(v)}</td>`;
          }).join("");

          const notaKey = normalizeNota(getField(row, COL_NOTA));
          const sub = `${normalizeNota(getField(row, COL_NOTA))} ‚Ä¢ ${(getField(row, COL_MUN)||"").toString()} ‚Ä¢ ${(getField(row, COL_CRIT)||"").toString()}`;

          tr.innerHTML =
            cells +
            `<td class="nowrap">
              <button class="linkBtn" data-nota="${escapeHtml(notaKey)}" data-sub="${escapeHtml(sub)}">Notas</button>
            </td>`;

          tbody.appendChild(tr);
        }
      }

      table.appendChild(tbody);
      wrap.appendChild(table);

      wrap.querySelectorAll("button[data-nota]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const nota = btn.getAttribute("data-nota");
          const sub = btn.getAttribute("data-sub");
          openNotes(nota, sub);
        });
      });

      return wrap;
    }

    function statusTag(status){
      if(status==="executada") return `<span class="tag">Executada</span>`;
      if(status==="problemas") return `<span class="tag warn">Problemas</span>`;
      if(status==="nao_executada") return `<span class="tag danger">N√£o executada</span>`;
      if(status==="energizada") return `<span class="tag done">Energizada</span>`;
      return `<span class="tag">${escapeHtml(status||"‚Äî")}</span>`;
    }

    async function openNotes(notaKey, sub){
      currentNotaKey = notaKey;
      $("modalTitle").textContent = `Notas - Nota ${notaKey}`;
      $("modalSub").textContent = sub || "";
      $("overlayNotes").style.display = "flex";
      $("nTexto").value = "";
      await loadNotes();
    }

    function closeNotes(){
      $("overlayNotes").style.display = "none";
      currentNotaKey = null;
    }

    async function loadNotes(){
      const list = $("notesList");
      list.innerHTML = `<div class="muted">Carregando notas‚Ä¶</div>`;

      const { data, error } = await sb
        .from("notes")
        .select("id, nota, autor, texto, status, created_at")
        .eq("nota", currentNotaKey)
        .order("created_at", { ascending:false });

      if(error){
        list.innerHTML = `<div class="error">Erro ao carregar notas: ${escapeHtml(error.message)}</div>`;
        return;
      }

      if(!data || !data.length){
        list.innerHTML = `<div class="muted">Nenhuma nota ainda. Adicione a primeira acima.</div>`;
        return;
      }

      list.innerHTML = data.map(n=>{
        const when = n.created_at ? new Date(n.created_at).toLocaleString("pt-BR") : "‚Äî";
        return `
          <div class="noteItem">
            <div class="noteMeta">
              <div class="who">${escapeHtml(n.autor || "‚Äî")}</div>
              ${statusTag(n.status)}
              <div class="when">${escapeHtml(when)}</div>
            </div>
            <div class="noteText">${escapeHtml(n.texto || "")}</div>
          </div>
        `;
      }).join("");
    }

    async function saveNote(){
      const autor = $("nAutor").value.trim();
      const texto = $("nTexto").value.trim();
      const status = $("nStatus").value;

      if(!autor){ alert("Informe seu nome."); return; }
      if(!texto){ alert("Escreva a nota."); return; }

      if(status === "energizada"){
        const ok = confirm("Confirmar: esta obra foi ENERGIZADA e ser√° movida para Conclu√≠das?");
        if(!ok) return;
      }

      const payload = { nota: currentNotaKey, autor, texto, status };
      const { error } = await sb.from("notes").insert(payload);
      if(error){ alert("Erro ao salvar nota: " + error.message); return; }

      $("nTexto").value = "";
      await loadNotes();
      await loadAll(); // reflete conclu√≠da via trigger
    }

    // WhatsApp bases
    function buildWhatsBases(){
      const wrap = $("wBases");
      if(!wrap) return;
      wrap.innerHTML = "";
      const list = (bases && bases.length) ? bases : [];
      if(!list.length){
        wrap.innerHTML = `<div class="muted">Carregue os dados primeiro.</div>`;
        return;
      }
      for(const b of list){
        const id = "wb_" + b.replace(/\W+/g,"_");
        const div = document.createElement("label");
        div.className = "checkItem";
        div.innerHTML = `
          <input type="checkbox" data-base="${escapeHtml(b)}" id="${id}" checked />
          <span>${escapeHtml(b)}</span>
        `;
        wrap.appendChild(div);
      }
    }
    function getSelectedWhatsBases(){
      return Array.from(document.querySelectorAll('#wBases input[type="checkbox"][data-base]'))
        .filter(c=>c.checked)
        .map(c=>c.getAttribute("data-base"));
    }

    function buildWhatsTextRange(fromDate, toDate, basesSelected){
      const d1 = new Date(fromDate + "T00:00:00");
      const d2 = new Date(toDate + "T00:00:00");
      d1.setHours(0,0,0,0);
      d2.setHours(0,0,0,0);

      if(String(d1)==="Invalid Date" || String(d2)==="Invalid Date") return "Escolha datas v√°lidas.";
      if(d2 < d1) return "A data final precisa ser maior ou igual √† inicial.";
      if(!basesSelected.length) return "Selecione ao menos uma base.";

      // Whats: s√≥ ativas (minimiza√ß√£o)
      const inRange = allRows
        .filter(r => !r.concluida)
        .map(r => ({ r, d: parseDateOnly(getField(r, COL_PRAZO)) }))
        .filter(x => x.d && x.d >= d1 && x.d <= d2)
        .filter(x => basesSelected.includes((getField(x.r, COL_BASE) ?? "").toString().trim()));

      const map = new Map(); // dateKey -> Map(base -> rows)
      for(const x of inRange){
        const dateKey = fmtDateInput(x.d);
        if(!map.has(dateKey)) map.set(dateKey, new Map());
        const b = (getField(x.r, COL_BASE) ?? "Sem base").toString().trim() || "Sem base";
        const mb = map.get(dateKey);
        if(!mb.has(b)) mb.set(b, []);
        mb.get(b).push(x.r);
      }

      const dateKeys = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
      const header = `üìå Obras planejadas (${fmtDateBR(d1)} ‚Üí ${fmtDateBR(d2)})`;
      if(!dateKeys.length) return `${header}\n\nNenhuma obra encontrada no per√≠odo para as bases selecionadas.`;

      let msg = header + "\n";
      for(const dk of dateKeys){
        msg += `\nüìÖ ${fmtDateBR(dk)}\n`;
        const mb = map.get(dk);
        const baseKeys = Array.from(mb.keys()).sort((a,b)=>a.localeCompare(b));
        for(const b of baseKeys){
          msg += `\nüè∑Ô∏è Base: ${b}\n`;
          const rows = mb.get(b).slice();
          for(const r of rows){
            const nota = normalizeNota(getField(r, COL_NOTA)) || "‚Äî";
            const proj = getField(r, COL_PROJ) || "‚Äî";
            const agente = getField(r, COL_AGENT) || "‚Äî";
            const titulo = getField(r, "titulo") || "‚Äî";
            const mun = getField(r, COL_MUN) || "‚Äî";
            const crit = getField(r, COL_CRIT) || "‚Äî";
            msg += `- Nota ${nota} ‚Ä¢ ${proj} ‚Ä¢ Agente: ${agente} ‚Ä¢ ${mun} ‚Ä¢ ${crit} ‚Ä¢ ${titulo}\n`;
          }
        }
      }
      return msg.trim();
    }

    function openWhatsWithText(text){
      window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
    }

    function openWhatsModal(){
      const today = new Date(); today.setHours(0,0,0,0);
      $("wDe").value = fmtDateInput(today);
      $("wAte").value = fmtDateInput(addDays(today, 5));
      $("overlayWhats").style.display = "flex";
    }
    function closeWhatsModal(){ $("overlayWhats").style.display = "none"; }
    function previewWhats(){
      const txt = buildWhatsTextRange($("wDe").value, $("wAte").value, getSelectedWhatsBases());
      alert(txt.length > 1500 ? (txt.slice(0,1500) + "\n\n...(pr√©via cortada)") : txt);
    }
    function sendWhats(){
      const txt = buildWhatsTextRange($("wDe").value, $("wAte").value, getSelectedWhatsBases());
      if(txt.startsWith("Escolha") || txt.startsWith("A data") || txt.startsWith("Selecione")){
        alert(txt); return;
      }
      openWhatsWithText(txt);
    }

    // E-mail export
    function buildEmailBases(){
      const wrap = $("eBases");
      if(!wrap) return;
      wrap.innerHTML = "";
      const list = (bases && bases.length) ? bases : [];
      if(!list.length){
        wrap.innerHTML = `<div class="muted">Carregue os dados primeiro.</div>`;
        return;
      }
      for(const b of list){
        const id = "eb_" + b.replace(/\W+/g,"_");
        const div = document.createElement("label");
        div.className = "checkItem";
        div.innerHTML = `
          <input type="checkbox" data-base="${escapeHtml(b)}" id="${id}" checked />
          <span>${escapeHtml(b)}</span>
        `;
        wrap.appendChild(div);
      }
    }
    function getSelectedEmailBases(){
      return Array.from(document.querySelectorAll('#eBases input[type="checkbox"][data-base]'))
        .filter(c=>c.checked)
        .map(c=>c.getAttribute("data-base"));
    }
    function openEmailModal(){
      const today = new Date(); today.setHours(0,0,0,0);
      $("eDe").value = fmtDateInput(today);
      $("eAte").value = fmtDateInput(addDays(today, 5));
      $("eTo").value = "";
      $("eMsg").textContent = "Voc√™ pode copiar o texto antes de abrir o e-mail.";
      $("eMsg").style.color = "var(--muted)";
      $("overlayEmail").style.display = "flex";
    }
    function closeEmailModal(){ $("overlayEmail").style.display = "none"; }

    function validateNeoenergiaRecipient(email){
      const e = (email||"").trim().toLowerCase();
      return e.endsWith(ALLOW_DOMAIN);
    }

    function buildEmailText(fromDate, toDate, basesSelected){
      // mesma l√≥gica do Whats, mas formato ‚Äúe-mail‚Äù
      const txt = buildWhatsTextRange(fromDate, toDate, basesSelected);
      return txt;
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        return false;
      }
    }

    async function emailCopy(){
      const to = ($("eTo").value||"").trim();
      if(!validateNeoenergiaRecipient(to)){
        $("eMsg").textContent = "Destinat√°rio precisa ser @neoenergia.com";
        $("eMsg").style.color = "var(--warn)";
        return;
      }
      const txt = buildEmailText($("eDe").value, $("eAte").value, getSelectedEmailBases());
      const ok = await copyToClipboard(txt);
      $("eMsg").textContent = ok ? "Texto copiado!" : "N√£o consegui copiar automaticamente. Selecione e copie manualmente.";
      $("eMsg").style.color = ok ? "var(--accent)" : "var(--warn)";
      if(!ok) alert(txt);
    }

    function emailOpen(){
      const to = ($("eTo").value||"").trim();
      if(!validateNeoenergiaRecipient(to)){
        $("eMsg").textContent = "Destinat√°rio precisa ser @neoenergia.com";
        $("eMsg").style.color = "var(--warn)";
        return;
      }
      const body = buildEmailText($("eDe").value, $("eAte").value, getSelectedEmailBases());
      const subject = "UTEP - Obras planejadas";
      // mailto tem limite de tamanho, ent√£o a gente abre e recomenda ‚Äúcopiar texto‚Äù se ficar grande
      const url = "mailto:" + encodeURIComponent(to)
        + "?subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);

      window.location.href = url;
      $("eMsg").textContent = "Abrindo seu cliente de e-mail‚Ä¶ (se o texto ficar grande, use Copiar texto).";
      $("eMsg").style.color = "var(--muted)";
    }

    // Admin
    async function loadAdmin(){
      if(!isAdmin){
        $("admTbody").innerHTML = `<tr><td colspan="7" class="muted">Sem permiss√£o.</td></tr>`;
        return;
      }
      // usa os dados j√° carregados (allRows) pra ser r√°pido
      adminRows = allRows.slice();
      renderAdminTable();
    }

    function renderAdminTable(){
      const tbody = $("admTbody");
      const q = ($("admSearch").value||"").trim().toLowerCase();
      const onlyOpen = $("admOnlyOpen").checked;

      let rows = adminRows.slice();
      if(onlyOpen) rows = rows.filter(r=> !r.concluida);

      if(q){
        rows = rows.filter(r=>{
          const nota = normalizeNota(getField(r, COL_NOTA)).toLowerCase();
          const proj = String(getField(r, COL_PROJ)||"").toLowerCase();
          const base = String(getField(r, COL_BASE)||"").toLowerCase();
          const mun  = String(getField(r, COL_MUN)||"").toLowerCase();
          const crit = String(getField(r, COL_CRIT)||"").toLowerCase();
          return (nota.includes(q) || proj.includes(q) || base.includes(q) || mun.includes(q) || crit.includes(q));
        });
      }

      rows = rows.slice().sort((a,b)=>{
        const da = parseDateOnly(getField(a, COL_PRAZO));
        const db = parseDateOnly(getField(b, COL_PRAZO));
        if(!da && !db) return 0;
        if(!da) return 1;
        if(!db) return -1;
        return da - db;
      });

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Nenhuma obra encontrada.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r=>{
        const nota = normalizeNota(getField(r, COL_NOTA)) || "‚Äî";
        const proj = getField(r, COL_PROJ) || "‚Äî";
        const base = getField(r, COL_BASE) || "‚Äî";
        const mun  = getField(r, COL_MUN) || "‚Äî";
        const crit = getField(r, COL_CRIT) || "‚Äî";
        const prazo = fmtDateBR(getField(r, COL_PRAZO)) || "‚Äî";
        const checked = r.concluida ? "checked" : "";
        return `
          <tr>
            <td class="nowrap"><input type="checkbox" data-nota="${escapeHtml(nota)}" ${checked} /></td>
            <td class="nowrap">${escapeHtml(nota)}</td>
            <td class="nowrap">${escapeHtml(proj)}</td>
            <td class="nowrap">${escapeHtml(base)}</td>
            <td class="nowrap">${escapeHtml(mun)}</td>
            <td class="nowrap">${escapeHtml(crit)}</td>
            <td class="nowrap">${escapeHtml(prazo)}</td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll('input[type="checkbox"][data-nota]').forEach(chk=>{
        chk.addEventListener("change", async ()=>{
          const nota = chk.getAttribute("data-nota");
          const mark = chk.checked;
          await adminSetConcluida(nota, mark);
        });
      });
    }

    async function adminSetConcluida(notaKey, mark){
      if(!isAdmin){
        alert("Sem permiss√£o."); return;
      }
      // update pelo campo nota (assumindo que nota identifica a obra)
      const payload = mark
        ? { concluida: true, concluida_em: new Date().toISOString() }
        : { concluida: false, concluida_em: null };

      const { error } = await sb
        .from("obras")
        .update(payload)
        .eq(COL_NOTA.replaceAll('"',''), notaKey);

      if(error){
        alert("Erro ao atualizar: " + error.message);
        return;
      }

      // atualiza cache local
      const row = allRows.find(r => normalizeNota(getField(r, COL_NOTA)) === notaKey);
      if(row){
        row.concluida = !!mark;
        row.concluida_em = mark ? new Date().toISOString() : null;
      }
      // re-render admin e dashboard
      renderAdminTable();
      if(mode !== "admin") render();
    }

    function toCSV(rows){
      const cols = [
        "nota","projeto","agente_responsavel","base","municipio","criterio","prazo_final","titulo","status","concluida"
      ];
      const lines = [cols.join(",")];
      for(const r of rows){
        const nota = normalizeNota(getField(r, COL_NOTA));
        const proj = String(getField(r, COL_PROJ)||"");
        const ag   = String(getField(r, COL_AGENT)||"");
        const base = String(getField(r, COL_BASE)||"");
        const mun  = String(getField(r, COL_MUN)||"");
        const crit = String(getField(r, COL_CRIT)||"");
        const prazo= String(getField(r, COL_PRAZO)||"").slice(0,10);
        const tit  = String(r.titulo||"");
        const st   = String(r.status||"");
        const con  = r.concluida ? "true" : "false";
        const vals = [nota,proj,ag,base,mun,crit,prazo,tit,st,con].map(v=> `"${String(v).replaceAll('"','""')}"`);
        lines.push(vals.join(","));
      }
      return lines.join("\n");
    }

    function downloadTextFile(filename, text){
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function adminExportCsv(){
      const csv = toCSV(adminRows);
      downloadTextFile("obras_admin.csv", csv);
    }

    async function adminCopySummary(done){
      const rows = allRows.filter(r => done ? !!r.concluida : !r.concluida);
      const header = done ? "‚úÖ Conclu√≠das" : "üìå Ativas";
      let txt = header + "\n";
      for(const r of rows.slice(0, 2000)){
        const nota = normalizeNota(getField(r, COL_NOTA)) || "‚Äî";
        const proj = getField(r, COL_PROJ) || "‚Äî";
        const base = getField(r, COL_BASE) || "‚Äî";
        const prazo= fmtDateBR(getField(r, COL_PRAZO)) || "‚Äî";
        txt += `- ${nota} ‚Ä¢ ${proj} ‚Ä¢ ${base} ‚Ä¢ ${prazo}\n`;
      }
      const ok = await copyToClipboard(txt.trim());
      alert(ok ? "Resumo copiado!" : txt);
    }

    function adminPurgeCache(){
      try{
        localStorage.clear();
        alert("Cache local limpo.");
      }catch(e){
        alert("N√£o consegui limpar.");
      }
    }

    async function guard(){
      const ok = await checkApprovedOrBlock();
      if(!ok) return;
      await loadAll();
    }

    function setToday(){
      const now = new Date();
      now.setHours(0,0,0,0);
      $("fData").value = fmtDateInput(now);
      $("todayPill").textContent = "Data: " + fmtDateBR($("fData").value);
    }

    (function init(){
      setToday();
      setMode("ativas");

      $("btnReload").addEventListener("click", guard);
      $("btnHoje").addEventListener("click", ()=>{ setToday(); render(); });

      $("fData").addEventListener("change", ()=>{ $("todayPill").textContent = "Data: " + fmtDateBR($("fData").value); render(); });
      $("fBase").addEventListener("change", render);
      $("fMunicipio").addEventListener("change", render);
      $("fCriterio").addEventListener("change", render);

      $("tabAtivas").addEventListener("click", ()=> setMode("ativas"));
      $("tabConcluidas").addEventListener("click", ()=> setMode("concluidas"));
      $("tabDetalhes").addEventListener("click", ()=> setMode("detalhes"));
      $("tabAdmin").addEventListener("click", ()=> setMode("admin"));

      $("tShowExtras").addEventListener("change", (e)=>{ showExtras = e.target.checked; render(); });

      $("btnWhats").addEventListener("click", openWhatsModal);
      $("btnCloseWhats").addEventListener("click", closeWhatsModal);
      $("overlayWhats").addEventListener("click", (e)=>{ if(e.target === $("overlayWhats")) closeWhatsModal(); });
      $("btnPreviewWhats").addEventListener("click", previewWhats);
      $("btnSendWhats").addEventListener("click", sendWhats);
      $("btnSelAll").addEventListener("click", ()=>{ document.querySelectorAll('#wBases input[type="checkbox"][data-base]').forEach(c=>c.checked=true); });
      $("btnSelNone").addEventListener("click", ()=>{ document.querySelectorAll('#wBases input[type="checkbox"][data-base]').forEach(c=>c.checked=false); });

      $("btnEmail").addEventListener("click", openEmailModal);
      $("btnCloseEmail").addEventListener("click", closeEmailModal);
      $("overlayEmail").addEventListener("click", (e)=>{ if(e.target === $("overlayEmail")) closeEmailModal(); });
      $("btnEmailCopy").addEventListener("click", emailCopy);
      $("btnEmailOpen").addEventListener("click", emailOpen);
      $("eSelAll").addEventListener("click", ()=>{ document.querySelectorAll('#eBases input[type="checkbox"][data-base]').forEach(c=>c.checked=true); });
      $("eSelNone").addEventListener("click", ()=>{ document.querySelectorAll('#eBases input[type="checkbox"][data-base]').forEach(c=>c.checked=false); });

      $("btnCloseNotes").addEventListener("click", closeNotes);
      $("btnCloseNotes2").addEventListener("click", closeNotes);
      $("overlayNotes").addEventListener("click", (e)=>{ if(e.target === $("overlayNotes")) closeNotes(); });
      $("btnSalvarNota").addEventListener("click", saveNote);
      $("btnRecarregarNotas").addEventListener("click", loadNotes);

      // Admin UI events
      $("btnAdminReload").addEventListener("click", ()=> loadAdmin());
      $("admSearch").addEventListener("input", ()=> renderAdminTable());
      $("admOnlyOpen").addEventListener("change", ()=> renderAdminTable());
      $("btnAdminExportCsv").addEventListener("click", adminExportCsv);
      $("btnAdminCopySummary").addEventListener("click", ()=> adminCopySummary(false));
      $("btnAdminCopyDone").addEventListener("click", ()=> adminCopySummary(true));
      $("btnAdminPurgeCache").addEventListener("click", adminPurgeCache);

      // Auth
      $("btnSignIn").addEventListener("click", signIn);
      $("btnSignUp").addEventListener("click", signUp);
      $("btnLogout").addEventListener("click", logout);
      $("btnDeniedLogout").addEventListener("click", logout);

      sb.auth.onAuthStateChange(()=> guard());
      guard();
    })();
  </script>
</body>
</html>